<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Rail Fatigue Management - v76: Teams Feature</title>
    
    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    
    
    <!-- SheetJS for Excel file handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* ============================================
           PRODUCTION-READY CSS REPLACEMENT FOR TAILWIND
           Complete utility class system - v67b
           ============================================ */
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body.resizing {
            cursor: row-resize !important;
            user-select: none !important;
        }
        
        body.resizing * {
            cursor: row-resize !important;
            user-select: none !important;
        }
        
        /* ========== LAYOUT ========== */
        .block { display: block; }
        .inline-flex { display: inline-flex; }
        .flex { display: flex; }
        .grid { display: grid; }
        .hidden { display: none; }
        
        .flex-col { flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-1 { flex: 1 1 0%; }
        .flex-shrink-0 { flex-shrink: 0; }
        .shrink-0 { flex-shrink: 0; }
        
        .items-start { align-items: flex-start; }
        .items-center { align-items: center; }
        
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        
        /* Grid */
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        
        /* Timeline specific - fixed grid */
        .grid-cols-\[200px_repeat\(28\,120px\)\] {
            display: grid;
            grid-template-columns: 200px repeat(28, 120px);
        }
        
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .md\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        }
        
        @media (min-width: 1024px) {
            .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .lg\:grid-cols-6 { grid-template-columns: repeat(6, minmax(0, 1fr)); }
        }
        
        @media (min-width: 1280px) {
            .xl\:grid-cols-8 { grid-template-columns: repeat(8, minmax(0, 1fr)); }
        }
        
        /* ========== SPACING ========== */
        /* Padding */
        .p-0\.5 { padding: 0.125rem; }
        .p-1 { padding: 0.25rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        
        .px-1 { padding-left: 0.25rem; padding-right: 0.25rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-1\.5 { padding-top: 0.375rem; padding-bottom: 0.375rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-2\.5 { padding-top: 0.625rem; padding-bottom: 0.625rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        
        .pt-2 { padding-top: 0.5rem; }
        .pt-4 { padding-top: 1rem; }
        .pt-6 { padding-top: 1.5rem; }
        .pb-2 { padding-bottom: 0.5rem; }
        .pb-4 { padding-bottom: 1rem; }
        .pr-12 { padding-right: 3rem; }
        
        /* Margin */
        .m-2 { margin: 0.5rem; }
        .m-4 { margin: 1rem; }
        
        .mx-2 { margin-left: 0.5rem; margin-right: 0.5rem; }
        .mx-4 { margin-left: 1rem; margin-right: 1rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        
        .mt-0\.5 { margin-top: 0.125rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-8 { margin-top: 2rem; }
        
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        
        .ml-2 { margin-left: 0.5rem; }
        .ml-4 { margin-left: 1rem; }
        .-ml-1 { margin-left: -0.25rem; }
        
        .mr-1 { margin-right: 0.25rem; }
        .mr-2 { margin-right: 0.5rem; }
        .mr-3 { margin-right: 0.75rem; }
        
        /* Gap */
        .gap-0\.5 { gap: 0.125rem; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        
        /* Space between */
        .space-y-1 > * + * { margin-top: 0.25rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-5 > * + * { margin-top: 1.25rem; }
        .space-y-6 > * + * { margin-top: 1.5rem; }
        
        /* ========== SIZING ========== */
        .w-3 { width: 0.75rem; }
        .w-4 { width: 1rem; }
        .w-5 { width: 1.25rem; }
        .w-6 { width: 1.5rem; }
        .w-8 { width: 2rem; }
        .w-12 { width: 3rem; }
        .w-16 { width: 4rem; }
        .w-20 { width: 5rem; }
        .w-full { width: 100%; }
        
        .h-3 { height: 0.75rem; }
        .h-4 { height: 1rem; }
        .h-5 { height: 1.25rem; }
        .h-6 { height: 1.5rem; }
        .h-8 { height: 2rem; }
        .h-12 { height: 3rem; }
        .h-full { height: 100%; }
        .h-screen { height: 100vh; }
        
        .min-w-0 { min-width: 0; }
        .min-w-full { min-width: 100%; }
        .min-w-max { min-width: max-content; }
        .min-w-\[110px\] { min-width: 110px; }
        .min-w-\[220px\] { min-width: 220px; }
        
        .min-h-screen { min-height: 100vh; }
        .min-h-\[280px\] { min-height: 280px; }
        
        .max-w-md { max-width: 28rem; }
        .max-w-2xl { max-width: 42rem; }
        .max-w-4xl { max-width: 56rem; }
        
        .max-h-96 { max-height: 24rem; }
        .max-h-\[90vh\] { max-height: 90vh; }
        .max-h-\[80vh\] { max-height: 80vh; }
        
        /* ========== TYPOGRAPHY ========== */
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-base { font-size: 1rem; line-height: 1.5rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .text-\[9px\] { font-size: 9px; }
        .text-\[10px\] { font-size: 10px; }
        
        .font-normal { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        
        .tracking-wide { letter-spacing: 0.025em; }
        .uppercase { text-transform: uppercase; }
        .underline { text-decoration: underline; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .list-disc { list-style-type: disc; }
        
        /* ========== COLORS ========== */
        /* Backgrounds */
        .bg-white { background-color: #ffffff; }
        .bg-black { background-color: #000000; }
        
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-200 { background-color: #e5e7eb; }
        
        .bg-slate-700 { background-color: #334155; }
        .bg-slate-800 { background-color: #1e293b; }
        .bg-slate-800\/90 { background-color: rgba(30, 41, 59, 0.9); }
        .bg-slate-900 { background-color: #0f172a; }
        
        .bg-red-50 { background-color: #fef2f2; }
        .bg-red-100 { background-color: #fee2e2; }
        .bg-red-900\/50 { background-color: rgba(127, 29, 29, 0.5); }
        
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-blue-600 { background-color: #2563eb; }
        
        .bg-green-600 { background-color: #16a34a; }
        
        .bg-amber-100 { background-color: #fef3c7; }
        .bg-green-100 { background-color: #dcfce7; }
        .bg-indigo-100 { background-color: #e0e7ff; }
        .bg-orange-600 { background-color: #ea580c; }
        .bg-purple-600 { background-color: #9333ea; }
        
        .bg-opacity-50 { --tw-bg-opacity: 0.5; }
        .bg-black-50 { background-color: rgba(0, 0, 0, 0.5); }
        
        /* Gradients */
        .bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--tw-gradient-stops)); }
        .from-slate-900 { --tw-gradient-from: #0f172a; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(15, 23, 42, 0)); }
        .via-slate-800 { --tw-gradient-stops: var(--tw-gradient-from), #1e293b, var(--tw-gradient-to, rgba(30, 41, 59, 0)); }
        .to-slate-900 { --tw-gradient-to: #0f172a; }
        .from-blue-50 { --tw-gradient-from: #eff6ff; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(239, 246, 255, 0)); }
        .to-blue-100 { --tw-gradient-to: #dbeafe; }
        
        /* Text colors */
        .text-white { color: #ffffff; }
        
        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-900 { color: #111827; }
        
        .text-slate-300 { color: #cbd5e1; }
        .text-slate-400 { color: #94a3b8; }
        
        .text-red-200 { color: #fecaca; }
        .text-red-500 { color: #ef4444; }
        .text-red-600 { color: #dc2626; }
        .text-red-700 { color: #b91c1c; }
        .text-red-800 { color: #991b1b; }
        .text-red-900 { color: #7f1d1d; }
        
        .text-blue-100 { color: #dbeafe; }
        .text-blue-400 { color: #60a5fa; }
        .text-blue-500 { color: #3b82f6; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-700 { color: #1d4ed8; }
        .text-blue-800 { color: #1e40af; }
        .text-blue-900 { color: #1e3a8a; }
        
        .text-green-100 { color: #dcfce7; }
        .text-green-500 { color: #22c55e; }
        .text-green-800 { color: #166534; }
        
        .text-amber-500 { color: #f59e0b; }
        .text-amber-600 { color: #d97706; }
        .text-amber-800 { color: #92400e; }
        
        .text-indigo-600 { color: #4f46e5; }
        .text-indigo-800 { color: #3730a3; }
        
        /* Placeholder */
        .placeholder-slate-400::placeholder { color: #94a3b8; }
        
        /* ========== BORDERS ========== */
        .border { border-width: 1px; border-style: solid; }
        .border-2 { border-width: 2px; border-style: solid; }
        .border-4 { border-width: 4px; border-style: solid; }
        .border-t { border-top-width: 1px; border-top-style: solid; }
        .border-b { border-bottom-width: 1px; border-bottom-style: solid; }
        .border-b-4 { border-bottom-width: 4px; border-bottom-style: solid; }
        .border-l { border-left-width: 1px; border-left-style: solid; }
        .border-l-4 { border-left-width: 4px; border-left-style: solid; }
        .border-r { border-right-width: 1px; border-right-style: solid; }
        
        .border-dashed { border-style: dashed; }
        
        .border-gray-200 { border-color: #e5e7eb; }
        .border-gray-300 { border-color: #d1d5db; }
        
        .border-slate-600 { border-color: #475569; }
        .border-slate-700 { border-color: #334155; }
        
        .border-red-500 { border-color: #ef4444; }
        .border-red-700 { border-color: #b91c1c; }
        .border-red-300 { border-color: #fca5a5; }
        
        .border-amber-300 { border-color: #fcd34d; }
        .border-green-300 { border-color: #86efac; }
        
        .border-blue-200 { border-color: #bfdbfe; }
        .border-blue-300 { border-color: #93c5fd; }
        .border-blue-600 { border-color: #2563eb; }
        
        .border-orange-600 { border-color: #ea580c; }
        .border-purple-600 { border-color: #9333ea; }
        
        .rounded { border-radius: 0.25rem; }
        .rounded-md { border-radius: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-full { border-radius: 9999px; }
        .rounded-r-lg { border-top-right-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        
        /* ========== SHADOWS ========== */
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        
        /* ========== POSITIONING ========== */
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .sticky { position: sticky; }
        
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .top-0 { top: 0; }
        .top-1 { top: 0.25rem; }
        .left-0 { left: 0; }
        .left-1 { left: 0.25rem; }
        .right-1 { right: 0.25rem; }
        
        .z-10 { z-index: 10; }
        .z-40 { z-index: 40; }
        .z-50 { z-index: 50; }
        
        /* ========== EFFECTS ========== */
        .opacity-0 { opacity: 0; }
        .opacity-25 { opacity: 0.25; }
        .opacity-50 { opacity: 0.5; }
        .opacity-75 { opacity: 0.75; }
        
        .backdrop-blur-sm { backdrop-filter: blur(4px); }
        
        /* ========== TRANSITIONS ========== */
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .transition-colors { transition-property: color, background-color, border-color; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .transition-opacity { transition-property: opacity; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .transition-shadow { transition-property: box-shadow; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .transition-transform { transition-property: transform; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .duration-200 { transition-duration: 200ms; }
        
        .transform { --tw-translate-x: 0; --tw-translate-y: 0; --tw-rotate: 0; --tw-skew-x: 0; --tw-skew-y: 0; --tw-scale-x: 1; --tw-scale-y: 1; transform: translateX(var(--tw-translate-x)) translateY(var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y)); }
        .scale-105 { transform: scale(1.05); }
        
        /* ========== INTERACTIVITY ========== */
        .cursor-pointer { cursor: pointer; }
        .cursor-not-allowed { cursor: not-allowed; }
        
        .overflow-auto { overflow: auto; }
        .overflow-x-auto { overflow-x: auto; }
        .overflow-y-auto { overflow-y: auto; }
        
        /* ========== HOVER STATES ========== */
        .hover\:bg-gray-50:hover { background-color: #f9fafb; }
        .hover\:bg-gray-100:hover { background-color: #f3f4f6; }
        .hover\:bg-gray-300:hover { background-color: #d1d5db; }
        
        .hover\:bg-blue-100:hover { background-color: #dbeafe; }
        .hover\:bg-blue-200:hover { background-color: #bfdbfe; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        
        .hover\:bg-red-100:hover { background-color: #fee2e2; }
        .hover\:bg-red-200:hover { background-color: #fecaca; }
        
        .hover\:bg-green-700:hover { background-color: #15803d; }
        .hover\:bg-purple-700:hover { background-color: #7e22ce; }
        
        .hover\:text-blue-300:hover { color: #93c5fd; }
        .hover\:text-blue-800:hover { color: #1e40af; }
        .hover\:text-gray-600:hover { color: #4b5563; }
        .hover\:text-red-800:hover { color: #991b1b; }
        
        .hover\:border-blue-500:hover { border-color: #3b82f6; }
        
        .hover\:shadow-md:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .hover\:shadow-lg:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .hover\:shadow-xl:hover { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        
        .hover\:-translate-y-0\.5:hover { --tw-translate-y: -0.125rem; transform: translateY(var(--tw-translate-y)); }
        .hover\:scale-110:hover { --tw-scale-x: 1.1; --tw-scale-y: 1.1; transform: scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y)); }
        
        .hover\:underline:hover { text-decoration: underline; }
        
        /* Group hover */
        .group:hover .group-hover\:opacity-100 { opacity: 1; }
        
        /* ========== FOCUS STATES ========== */
        .focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }
        .focus\:border-transparent:focus { border-color: transparent; }
        .focus\:ring-2:focus { --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); }
        .focus\:ring-blue-500:focus { --tw-ring-color: #3b82f6; }
        .focus\:ring-offset-2:focus { --tw-ring-offset-width: 2px; }
        .focus\:ring-offset-slate-800:focus { --tw-ring-offset-color: #1e293b; }
        
        /* ========== DISABLED STATES ========== */
        .disabled\:opacity-50:disabled { opacity: 0.5; }
        .disabled\:cursor-not-allowed:disabled { cursor: not-allowed; }
        .disabled\:transform-none:disabled { transform: none; }
        
        /* ========== ANIMATIONS ========== */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin { animation: spin 1s linear infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        /* ========== CUSTOM COMPONENTS ========== */
        .employee-draggable {
            cursor: grab;
            user-select: none;
        }
        
        .employee-draggable:active {
            cursor: grabbing;
        }
        
        .dragging {
            opacity: 0.5;
        }
        
        .drag-over {
            background-color: #dbeafe !important;
            border: 2px dashed #3b82f6 !important;
        }
        
        .multi-drag-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #3b82f6;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            border: 2px solid white;
        }
        
        .resizing {
            user-select: none;
            cursor: row-resize !important;
        }
        
        .resizing * {
            cursor: row-resize !important;
        }
        
        /* Non-pattern day indicator */
        .non-pattern-day {
            background: repeating-linear-gradient(
                45deg,
                #f9fafb,
                #f9fafb 8px,
                #f3f4f6 8px,
                #f3f4f6 16px
            );
            position: relative;
        }
        
        .non-pattern-day::after {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 12px 12px 0;
            border-color: transparent #d1d5db transparent transparent;
        }
        
        /* ========== FATIGUE ASSESSMENT MODULE STYLES ========== */
        .fatigue-module {
            background: #f8fafc;
            min-height: 100%;
        }
        
        .fatigue-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
        }
        
        @media (max-width: 1200px) {
            .fatigue-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .fatigue-panel {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        
        .fatigue-panel-header {
            padding: 0.875rem 1.25rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafc;
        }
        
        .fatigue-panel-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .fatigue-panel-body {
            padding: 1.25rem;
        }
        
        .fatigue-form-group {
            margin-bottom: 1rem;
        }
        
        .fatigue-form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 0.375rem;
        }
        
        .fatigue-form-input, .fatigue-form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
        }
        
        .fatigue-form-input:focus, .fatigue-form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .fatigue-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
        }
        
        .fatigue-template-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .fatigue-template-btn {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            font-size: 0.75rem;
            color: #64748b;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .fatigue-template-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .fatigue-shift-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }
        
        .fatigue-shift-item {
            display: grid;
            grid-template-columns: 70px 1fr 55px 32px;
            gap: 0.5rem;
            align-items: center;
            padding: 0.625rem 0.875rem;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.8rem;
        }
        
        .fatigue-shift-item:last-child {
            border-bottom: none;
        }
        
        .fatigue-shift-item:hover {
            background: #f8fafc;
        }
        
        .fatigue-summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        
        .fatigue-summary-card {
            background: #f8fafc;
            border-radius: 6px;
            padding: 0.875rem;
            text-align: center;
        }
        
        .fatigue-summary-value {
            font-family: ui-monospace, monospace;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.125rem;
        }
        
        .fatigue-summary-label {
            font-size: 0.65rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .fatigue-chart-container {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .fatigue-chart-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.75rem;
        }
        
        .fatigue-data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }
        
        .fatigue-data-table th {
            background: #f8fafc;
            padding: 0.625rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #64748b;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
        }
        
        .fatigue-data-table td {
            padding: 0.625rem 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            font-family: ui-monospace, monospace;
        }
        
        .fatigue-data-table tr:hover {
            background: #f8fafc;
        }
        
        .fatigue-risk-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .fatigue-risk-low { background: #dcfce7; color: #166534; }
        .fatigue-risk-moderate { background: #fef9c3; color: #854d0e; }
        .fatigue-risk-high { background: #fed7aa; color: #9a3412; }
        .fatigue-risk-critical { background: #fee2e2; color: #991b1b; }
        
        .fatigue-warning {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 0.875rem;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #92400e;
            margin-bottom: 1rem;
        }
        
        .fatigue-empty-state {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
        }
        
        .fatigue-defaults-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding: 0.875rem;
            background: #f8fafc;
            border-radius: 6px;
        }
        
        .fatigue-defaults-section-title {
            font-size: 0.65rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .risk-color-low { color: #22c55e; }
        .risk-color-moderate { color: #eab308; }
        .risk-color-high { color: #f97316; }
        .risk-color-critical { color: #ef4444; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Lucide Icons inline SVG components -->
    <script type="text/babel">
        // Simple icon components
        const Calendar = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
        );

        const Users = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
        );

        const Clock = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
        );

        const AlertTriangle = ({ className = "w-6 h-6" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L2 20h20L12 2zm0 4.5l7.5 13.5h-15L12 6.5z" fill="currentColor"/>
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" fill="currentColor"/>
                <line x1="12" y1="9" x2="12" y2="13" stroke="white" strokeWidth="2" strokeLinecap="round"/>
                <circle cx="12" cy="16.5" r="1" fill="white"/>
            </svg>
        );

        const ErrorTriangle = ({ className = "w-6 h-6" }) => (
            <svg className={className} viewBox="0 0 24 24" fill="currentColor">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" fill="currentColor"/>
                <line x1="12" y1="9" x2="12" y2="13" stroke="white" strokeWidth="2" strokeLinecap="round"/>
                <circle cx="12" cy="16.5" r="1" fill="white"/>
            </svg>
        );

        const CheckCircle = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        );

        const XCircle = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
        );

        const AlertCircle = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
        );

        const Plus = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        );

        const Edit2 = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
        );

        const Trash2 = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const ChevronLeft = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
        );

        const ChevronRight = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="9 18 15 12 9 6"/>
            </svg>
        );

        const GripVertical = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="9" cy="12" r="1"/>
                <circle cx="9" cy="5" r="1"/>
                <circle cx="9" cy="19" r="1"/>
                <circle cx="15" cy="12" r="1"/>
                <circle cx="15" cy="5" r="1"/>
                <circle cx="15" cy="19" r="1"/>
            </svg>
        );

        const Upload = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
        );

        const Download = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
        );

        const Home = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
        );

        const X = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        );
    </script>

    <!-- Main Application Component -->
    
        <!-- Supabase Init and Auth Screen -->
        <script type="text/babel">
            /* ==================== SUPABASE INIT + AUTH SCREEN ==================== */
    
            const SUPABASE_URL = 'https://tditgrtsggyogttfwzso.supabase.co';
            const SUPABASE_KEY = 'sb_publishable_TrbrfiGPuSFngQuIJU9fJg_kbzcaLVi';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            // Global user state
            let currentUser = null;
            
            // Helper to get current user
            const getCurrentUser = () => currentUser;
            const setCurrentUser = (user) => { currentUser = user; };
            
            // Database helper functions - maps Firebase-style calls to Supabase
            // Table name mapping (Firebase camelCase -> Supabase snake_case)
            const tableMap = {
              'employees': 'employees',
              'projects': 'projects', 
              'teams': 'teams',
              'shiftPatterns': 'shift_patterns',
              'assignments': 'assignments'
            };
            
            // Convert camelCase to snake_case for DB writes
            const toSnakeCase = (obj) => {
              const result = {};
              for (const key in obj) {
                const snakeKey = key.replace(/([A-Z])/g, '_$1').toLowerCase();
                result[snakeKey] = obj[key];
              }
              return result;
            };
            
            // Supabase DB wrapper that mimics Firebase Firestore API
            const db = {
              collection: (name) => ({
                doc: (id) => ({
                  set: async (data) => {
                    const table = tableMap[name] || name;
                    const snakeData = toSnakeCase(data);
                    const { error } = await supabase.from(table).upsert({ ...snakeData, id: snakeData.id || id });
                    if (error) throw error;
                  },
                  update: async (data) => {
                    const table = tableMap[name] || name;
                    const snakeData = toSnakeCase(data);
                    // Remove FieldValue.delete() markers (set to null)
                    for (const key in snakeData) {
                      if (snakeData[key] === '__DELETE__') snakeData[key] = null;
                    }
                    const { error } = await supabase.from(table).update(snakeData).eq('id', id);
                    if (error) throw error;
                  },
                  delete: async () => {
                    const table = tableMap[name] || name;
                    const { error } = await supabase.from(table).delete().eq('id', id);
                    if (error) throw error;
                  }
                })
              })
            };
            
            // Mock firebase.firestore.FieldValue for compatibility
            const firebase = {
              firestore: {
                FieldValue: {
                  delete: () => '__DELETE__'
                }
              }
            };
    
            const SignOutHeader = ({ user, onSignOut }) => {
                if (!user) return null;

                const handleSignOut = async () => {
                    try {
                        await supabase.auth.signOut();
                        onSignOut();
                    } catch (error) {
                        console.error("Error signing out:", error);
                        alert("Failed to sign out. Check console for details.");
                    }
                };

                return (
                    <div className="text-white text-sm bg-slate-800/90 backdrop-blur-sm px-3 py-1 rounded-lg shadow-lg border border-slate-700 flex items-center gap-3">
                        <p className="font-medium">{user.email}</p>
                        <button 
                            onClick={handleSignOut} 
                            className="text-blue-400 hover:text-blue-300 text-xs underline transition-colors"
                        >
                            Sign out
                        </button>
                    </div>
                );
            };
    
            const AuthScreen = ({ onLogin }) => {
                const [mode, setMode] = React.useState("signin");
                const [email, setEmail] = React.useState("");
                const [password, setPassword] = React.useState("");
                const [error, setError] = React.useState("");
                const [busy, setBusy] = React.useState(false);
    
                const handleSubmit = async (e) => {
                    e.preventDefault();
                    setBusy(true);
                    setError("");
    
                    try {
                        if (mode === "signup") {
                            const { data, error } = await supabase.auth.signUp({ email, password });
                            if (error) throw error;
                            if (data.user) onLogin(data.user);
                        } else {
                            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                            if (error) throw error;
                            if (data.user) onLogin(data.user);
                        }
                    } catch (err) {
                        console.error(err);
                        setError(err.message || "Something went wrong.");
                    } finally {
                        setBusy(false);
                    }
                };
    
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4">
                        <div className="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl w-full max-w-md p-8 space-y-6">
                            <div className="text-center space-y-2">
                                <div className="flex justify-center mb-4">
                                    <div className="bg-blue-600 p-3 rounded-lg">
                                        <Calendar className="w-8 h-8 text-white" />
                                    </div>
                                </div>
                                <h2 className="text-3xl font-bold text-white">
                                    Network Rail
                                </h2>
                                <p className="text-slate-400 text-sm">
                                    Fatigue Management System
                                </p>
                                <div className="pt-2">
                                    <p className="text-lg font-semibold text-white">
                                        {mode === "signin" ? "Sign In" : "Create Account"}
                                    </p>
                                </div>
                            </div>
                            
                            {error && (
                                <div className="bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded-lg" role="alert">
                                    <div className="flex items-start">
                                        <AlertCircle className="w-5 h-5 mr-2 flex-shrink-0 mt-0.5" />
                                        <div>
                                            <strong className="font-semibold">Error: </strong>
                                            <span>{error}</span>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            <form onSubmit={handleSubmit} className="space-y-5">
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2" htmlFor="email">
                                        Email Address
                                    </label>
                                    <input
                                        id="email"
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        required
                                        className="w-full px-4 py-2.5 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                        placeholder="you@example.com"
                                        disabled={busy}
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2" htmlFor="password">
                                        Password
                                    </label>
                                    <input
                                        id="password"
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        required
                                        className="w-full px-4 py-2.5 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                        placeholder="Ã¢â‚¬Â¢Ã¢â‚¬Â¢Ã¢â‚¬Â¢Ã¢â‚¬Â¢Ã¢â‚¬Â¢Ã¢â‚¬Â¢Ã¢â‚¬Â¢Ã¢â‚¬Â¢"
                                        disabled={busy}
                                    />
                                </div>
                                
                                <button
                                    type="submit"
                                    className="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-800 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                    disabled={busy}
                                >
                                    {busy ? (
                                        <span className="flex items-center justify-center">
                                            <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            Processing...
                                        </span>
                                    ) : (
                                        mode === "signin" ? "Sign In" : "Create Account"
                                    )}
                                </button>
                            </form>
                            
                            <div className="relative">
                                <div className="absolute inset-0 flex items-center">
                                    <div className="w-full border-t border-slate-700"></div>
                                </div>
                                <div className="relative flex justify-center text-sm">
                                    <span className="px-2 bg-slate-800 text-slate-400">
                                        {mode === "signin" ? "New to the system?" : "Already registered?"}
                                    </span>
                                </div>
                            </div>
                            
                            <div className="text-center">
                                <button
                                    onClick={() => {
                                        setMode(mode === "signin" ? "signup" : "signin");
                                        setError("");
                                    }}
                                    className="text-blue-400 hover:text-blue-300 font-medium transition-colors"
                                    disabled={busy}
                                >
                                    {mode === "signin" ? "Create a new account" : "Sign in to existing account"}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };
        </script>
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // Error Boundary Component to catch React errors and prevent white screens
        class ErrorBoundary extends React.Component {
          constructor(props) {
            super(props);
            this.state = { hasError: false, error: null, errorInfo: null };
          }

          static getDerivedStateFromError(error) {
            return { hasError: true };
          }

          componentDidCatch(error, errorInfo) {
            console.error('Ã¢ÂÅ’Ã¢ÂÅ’Ã¢ÂÅ’ REACT ERROR CAUGHT BY BOUNDARY:', error);
            console.error('Error info:', errorInfo);
            console.error('Component stack:', errorInfo.componentStack);
            this.setState({ error, errorInfo });
          }

          render() {
            if (this.state.hasError) {
              return (
                <div style={{
                  padding: '20px',
                  backgroundColor: '#fee',
                  border: '2px solid #c00',
                  borderRadius: '8px',
                  margin: '20px'
                }}>
                  <h2 style={{ color: '#c00', marginTop: 0 }}>Ã¢Å¡Â Ã¯Â¸Â Application Error</h2>
                  <p>Something went wrong. The app has been protected from crashing.</p>
                  <details style={{ marginTop: '10px', whiteSpace: 'pre-wrap' }}>
                    <summary style={{ cursor: 'pointer', fontWeight: 'bold' }}>Error Details (click to expand)</summary>
                    <pre style={{ 
                      backgroundColor: '#fff', 
                      padding: '10px', 
                      borderRadius: '4px',
                      overflow: 'auto',
                      fontSize: '12px'
                    }}>
                      {this.state.error && this.state.error.toString()}
                      {'\n\n'}
                      {this.state.errorInfo && this.state.errorInfo.componentStack}
                    </pre>
                  </details>
                  <button 
                    onClick={() => window.location.reload()} 
                    style={{
                      marginTop: '10px',
                      padding: '8px 16px',
                      backgroundColor: '#007bff',
                      color: 'white',
                      border: 'none',
                      borderRadius: '4px',
                      cursor: 'pointer'
                    }}>
                    Reload Application
                  </button>
                </div>
              );
            }

            return this.props.children;
          }
        }

        // ==================== NETWORK RAIL PERIODS ====================
        
        const NETWORK_RAIL_YEARS = [2024, 2025, 2026, 2027, 2028, 2029, 2030];
        
        const generateNetworkRailPeriods = (year) => {
            const periods = [];
            const yearStart = new Date(year, 3, 1); // April 1st - Network Rail year start
            
            for (let i = 0; i < 13; i++) {
                const periodStart = new Date(yearStart);
                periodStart.setDate(yearStart.getDate() + (i * 28));
                const periodEnd = new Date(periodStart);
                periodEnd.setDate(periodStart.getDate() + 27);
                
                const startStr = periodStart.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
                const endStr = periodEnd.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                
                periods.push({
                    id: `${year}-P${i + 1}`,
                    year: year,
                    period: i + 1,
                    name: `P${i + 1} (${startStr} - ${endStr})`,
                    startDate: periodStart.toISOString().split('T')[0],
                    endDate: periodEnd.toISOString().split('T')[0]
                });
            }
            
            return periods;
        };

        // ==================== HSE FATIGUE/RISK INDEX CALCULATOR ====================
        // Based on HSE Research Report RR446 - Crown Copyright
        
        const FatigueCalculator = {
            CONSTANTS: {
                SLEEP_DECAY_RATE: 0.136934833451947,
                WAKE_DECAY_RATE: 0.686825862760272,
                BASELINE_PVT: 3.9,
                ASYMPTOTE_FACTOR: 0.441596758431994,
                CIRCADIAN_AMPLITUDE: 0.74,
                CIRCADIAN_PHASE: 5.23,
                START_AMPLITUDE: 0.5,
                START_PHASE: 1.25
            },
            
            parseTimeToHours(timeStr) {
                if (!timeStr || !timeStr.includes(':')) return 0;
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours + minutes / 60;
            },
            
            calculateBedTime(endHour) {
                if (endHour < 24.25) return 16.3 + 0.367 * endHour;
                return endHour + 1;
            },
            
            calculateRKFit(endHour, bedTime) {
                if (endHour < 18.5) return 8.13;
                return -2.28827436527851 + 11.7995318577367 / 
                    (1 + 0.472949055173571 * Math.exp(-1.77393493516727 + 0.16244804759197 * (bedTime - 20)));
            },
            
            calculateAircrewFit(endHour) {
                return Math.min(8, 8 - 0.285 * (endHour - 18.5));
            },
            
            calculateTimingComponent(startHour, endHour, commuteMinutes) {
                const dutyLength = endHour > startHour ? endHour - startHour : (24 + endHour) - startHour;
                const commuteHours = (commuteMinutes - 40) / 60;
                const adjStart = startHour - commuteHours;
                const adjLength = dutyLength + commuteHours;
                
                const todRisk = 1.0106 + 0.1057 * 
                    (Math.sin(Math.PI * endHour / 12) - Math.sin(Math.PI * adjStart / 12)) / 
                    (adjLength * Math.PI / 12);
                
                const P1 = -0.4287, P2 = 0.1501, P3 = 0.129;
                const P4 = 0.0359, P5 = -0.8012, P6 = 0.7315;
                
                let shiftRisk;
                if (adjLength < 4.25) {
                    shiftRisk = 1 + P4 + P5 * Math.exp(-P6 * adjLength);
                } else if (adjLength > 8.13) {
                    shiftRisk = 1 + P1 + P2 * Math.exp(P3 * adjLength);
                } else {
                    shiftRisk = 1;
                }
                
                if (commuteHours <= 0) {
                    return (todRisk * shiftRisk) / 1.288 * 0.997976;
                }
                
                let commuteRisk;
                if (commuteHours < 4.25) {
                    commuteRisk = 1 + P4 + P5 * Math.exp(-P6 * commuteHours);
                } else if (commuteHours > 8.13) {
                    commuteRisk = 1 + P1 + P2 * Math.exp(P3 * commuteHours);
                } else {
                    commuteRisk = 1;
                }
                
                const shiftRiskAdjusted = (shiftRisk * adjLength - commuteRisk * commuteHours) / dutyLength;
                return (todRisk * shiftRiskAdjusted) / 1.288 * 0.997976;
            },
            
            calculateJobBreaksComponent(dutyLength, params) {
                const { workload, attention, breakFrequency, breakLength, continuousWork, breakAfterContinuous } = params;
                
                let workloadFactor = 0.125 + 0.015 * (workload + attention);
                const avgContinuous = (breakFrequency + continuousWork) / 2;
                const avgBreak = (breakLength + breakAfterContinuous) / 2;
                
                if (avgBreak === 0 && avgContinuous === 0) {
                    workloadFactor *= 1.2;
                } else {
                    workloadFactor *= 1.2 * avgContinuous / (avgContinuous + avgBreak);
                }
                
                const fiveMinBreak = 0.172731235 + -0.200918653 * 0.04 + 0.03552264 * 0.04 * 0.04;
                const fifteenMinBreak = avgContinuous * 0.000442;
                const thirtyMinBreak = 0.000206 + -0.0000138433 * avgContinuous + 0.00000096491 * avgContinuous * avgContinuous;
                
                let finalBreakFactor;
                if (avgBreak < 5) {
                    finalBreakFactor = 0.174 + (fiveMinBreak - 0.174) * avgBreak / 5;
                } else if (avgBreak < 15) {
                    finalBreakFactor = fiveMinBreak + (fifteenMinBreak - fiveMinBreak) * (avgBreak - 5) / 10;
                } else if (avgBreak < 30) {
                    finalBreakFactor = fifteenMinBreak + (thirtyMinBreak - fifteenMinBreak) * (avgBreak - 15) / 15;
                } else if (avgBreak < 60) {
                    finalBreakFactor = thirtyMinBreak * (60 - avgBreak) / 30;
                } else {
                    finalBreakFactor = 0;
                }
                
                const dutyMinutes = dutyLength * 60;
                const numSequences = 1 + Math.floor(dutyMinutes / (avgContinuous + avgBreak) - 0.01);
                const seqLength = Math.floor(0.5 + avgContinuous / 15);
                const breakEffect = 0.24 * Math.exp(-0.395 * (avgBreak - 13.3)) / 0.2388 / 
                    (1 + Math.exp(-0.395 * (avgBreak - 13.3)));
                
                const CONST1 = 1.826297414, CONST2 = 1.146457295;
                let n = 0, leng = -1, rr = 1, rrTotal = 0;
                
                do {
                    if (leng < seqLength) { leng++; } else { leng = 0; }
                    if (leng === 0) { rr = 1 + (rr - 1) * breakEffect; }
                    else { rr = CONST1 + (rr - CONST1) * Math.exp(-0.25 * CONST2); }
                    rrTotal += rr;
                    n++;
                } while (n <= numSequences * seqLength);
                
                let riskFactor = rrTotal / n / 1.4858;
                riskFactor += ((workload + attention) - 3) * 0.0232;
                return (riskFactor / 1.032) / 1.0286182;
            },
            
            calculateCumulativeComponent(duties, dutyIndex, defaults) {
                if (dutyIndex === 0) return 0.8885804237312078;
                
                const currentDuty = duties[dutyIndex];
                const prevDuty = duties[dutyIndex - 1];
                
                const prevEnd = this.parseTimeToHours(prevDuty.endTime);
                const currStart = this.parseTimeToHours(currentDuty.startTime);
                
                let gap = (currentDuty.day - prevDuty.day) * 24 + currStart - prevEnd;
                if (gap < 0) gap += 24;
                
                const bedTime = this.calculateBedTime(prevEnd);
                const rkFit = this.calculateRKFit(prevEnd, bedTime);
                const aircrewFit = this.calculateAircrewFit(prevEnd);
                
                let loss = Math.min(8, 8.07 - (rkFit + aircrewFit) / 2);
                if (loss < 9 - gap) loss = 9 - gap;
                
                const prevCumulative = dutyIndex > 0 ? 
                    this.calculateCumulativeComponent(duties, dutyIndex - 1, defaults) : 
                    this.CONSTANTS.BASELINE_PVT;
                
                const asymptote = this.CONSTANTS.BASELINE_PVT - loss * this.CONSTANTS.ASYMPTOTE_FACTOR;
                
                let nightPVT;
                if (prevCumulative > asymptote) {
                    nightPVT = asymptote + (prevCumulative - asymptote) * Math.exp(-this.CONSTANTS.SLEEP_DECAY_RATE);
                } else {
                    nightPVT = asymptote + (prevCumulative - asymptote) * Math.exp(-this.CONSTANTS.WAKE_DECAY_RATE);
                }
                
                if (gap >= 24) {
                    const recoveryFactor = Math.min(1, (gap - 24) / 48);
                    nightPVT = nightPVT + (this.CONSTANTS.BASELINE_PVT - nightPVT) * recoveryFactor * 0.5;
                }
                
                return 0.88 + (nightPVT / this.CONSTANTS.BASELINE_PVT) * 0.12 + (dutyIndex * 0.02);
            },
            
            calculateRiskIndex(duty, dutyIndex, allDuties, defaults) {
                const startHour = this.parseTimeToHours(duty.startTime);
                let endHour = this.parseTimeToHours(duty.endTime);
                if (endHour <= startHour) endHour += 24;
                
                const dutyLength = endHour - startHour;
                
                const cumulative = this.calculateCumulativeComponent(allDuties, dutyIndex, defaults);
                const timing = this.calculateTimingComponent(startHour, endHour, defaults.commuteTime);
                const jobBreaks = this.calculateJobBreaksComponent(dutyLength, defaults);
                
                const riskIndex = cumulative * timing * jobBreaks;
                
                return {
                    riskIndex: Math.round(riskIndex * 1000) / 1000,
                    cumulative: Math.round(cumulative * 1000) / 1000,
                    timing: Math.round(timing * 1000) / 1000,
                    jobBreaks: Math.round(jobBreaks * 1000) / 1000,
                    dutyLength: Math.round(dutyLength * 100) / 100,
                    restBefore: dutyIndex > 0 ? this.calculateRestPeriod(allDuties[dutyIndex - 1], duty) : null
                };
            },
            
            calculateRestPeriod(prevDuty, currentDuty) {
                const prevEnd = this.parseTimeToHours(prevDuty.endTime);
                const currStart = this.parseTimeToHours(currentDuty.startTime);
                let gap = (currentDuty.day - prevDuty.day) * 24 + currStart - prevEnd;
                if (gap < 0) gap += 24;
                return Math.round(gap * 100) / 100;
            },
            
            getRiskLevel(riskIndex) {
                if (riskIndex < 1.0) return { level: 'low', label: 'Low Risk', color: '#22c55e' };
                if (riskIndex < 1.1) return { level: 'moderate', label: 'Moderate', color: '#eab308' };
                if (riskIndex < 1.2) return { level: 'high', label: 'Elevated', color: '#f97316' };
                return { level: 'critical', label: 'High Risk', color: '#ef4444' };
            }
        };
        
        // Shift pattern templates for fatigue assessment
        const FATIGUE_TEMPLATES = {
            clactonRoster: {
                name: "Clacton Wheel Lathe",
                shifts: [
                    { day: 1, startTime: "08:30", endTime: "18:00" },
                    { day: 2, startTime: "07:30", endTime: "18:00" },
                    { day: 3, startTime: "07:30", endTime: "18:00" },
                    { day: 4, startTime: "07:30", endTime: "18:00" },
                    { day: 5, startTime: "07:30", endTime: "12:00" },
                    { day: 8, startTime: "08:30", endTime: "18:00" },
                    { day: 9, startTime: "07:30", endTime: "18:00" },
                    { day: 10, startTime: "07:30", endTime: "18:00" },
                    { day: 11, startTime: "07:30", endTime: "18:00" },
                    { day: 12, startTime: "07:30", endTime: "12:00" }
                ]
            },
            standardWeek: {
                name: "Standard 5-Day",
                shifts: [
                    { day: 1, startTime: "08:00", endTime: "17:00" },
                    { day: 2, startTime: "08:00", endTime: "17:00" },
                    { day: 3, startTime: "08:00", endTime: "17:00" },
                    { day: 4, startTime: "08:00", endTime: "17:00" },
                    { day: 5, startTime: "08:00", endTime: "17:00" }
                ]
            },
            nightShift: {
                name: "Night Shift Pattern",
                shifts: [
                    { day: 1, startTime: "22:00", endTime: "06:00" },
                    { day: 2, startTime: "22:00", endTime: "06:00" },
                    { day: 3, startTime: "22:00", endTime: "06:00" },
                    { day: 4, startTime: "22:00", endTime: "06:00" }
                ]
            },
            extended12hr: {
                name: "12hr Continental",
                shifts: [
                    { day: 1, startTime: "06:00", endTime: "18:00" },
                    { day: 2, startTime: "06:00", endTime: "18:00" },
                    { day: 5, startTime: "18:00", endTime: "06:00" },
                    { day: 6, startTime: "18:00", endTime: "06:00" }
                ]
            }
        };
        
        const DEFAULT_FATIGUE_PARAMS = {
            commuteTime: 60,
            workload: 2,
            attention: 1,
            breakFrequency: 180,
            breakLength: 15,
            continuousWork: 240,
            breakAfterContinuous: 30
        };

        // ==================== COMPLIANCE ENGINE ====================

        const calculateShiftDuration = (startTime, endTime) => {
          // Handle undefined, null, or empty values
          if (!startTime || !endTime) {
            console.warn('Ã¢Å¡Â Ã¯Â¸Â calculateShiftDuration called with invalid times:', { startTime, endTime });
            return 0;
          }
          
          // Ensure we have strings
          startTime = String(startTime);
          endTime = String(endTime);
          
          // Validate format
          if (!startTime.includes(':') || !endTime.includes(':')) {
            console.warn('Ã¢Å¡Â Ã¯Â¸Â Invalid time format:', { startTime, endTime });
            return 0;
          }
          
          const [startHour, startMin] = startTime.split(':').map(Number);
          const [endHour, endMin] = endTime.split(':').map(Number);
          
          // Validate parsed numbers
          if (isNaN(startHour) || isNaN(startMin) || isNaN(endHour) || isNaN(endMin)) {
            console.warn('Ã¢Å¡Â Ã¯Â¸Â Invalid time values after parsing:', { startTime, endTime });
            return 0;
          }
          
          let duration = (endHour * 60 + endMin) - (startHour * 60 + startMin);
          if (duration < 0) duration += 24 * 60;
          
          return duration / 60;
        };

        // Helper function to get shift times for a specific date
        // Checks for custom times on the assignment first
        const getShiftTimesForDate = (pattern, date, assignment = null) => {
          // Check if this assignment has custom times (manual override)
          if (assignment && assignment.customStartTime && assignment.customEndTime) {
            return {
              startTime: assignment.customStartTime,
              endTime: assignment.customEndTime
            };
          }
          
          if (pattern.weeklySchedule) {
            // Get day of week (0 = Sunday, 6 = Saturday)
            const d = new Date(date);
            const dayIndex = d.getDay();
            // Map to Network Rail week (Sat = 0)
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayName = daysOfWeek[dayIndex];
            return pattern.weeklySchedule[dayName];
          } else {
            return {
              startTime: pattern.startTime,
              endTime: pattern.endTime
            };
          }
        };

        // Helper function to get day of week in Network Rail format (Sat=0, Sun=1, ..., Fri=6)
        const getDayOfWeekShort = (date) => {
          const d = new Date(date);
          const day = d.getDay();
          // Convert Sunday=0 to our format where Saturday=0
          return day === 0 ? 1 : (day === 6 ? 0 : day + 1);
        };
        
        const getDayOfWeekName = (dayIndex) => {
          const daysShort = ['Sat', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
          return daysShort[dayIndex];
        };

        // FIXED: Check if a shift pattern has hours scheduled for a specific day
        // A day is valid for assignment if the shift STARTS on that day
        const shiftPatternHasHoursForDay = (pattern, date) => {
          console.log('Ã°Å¸â€Â Checking pattern hours for day:', { patternName: pattern.name, date });
          
          // Special case: Custom Roster can be used for any day
          if (pattern.name === 'Custom Roster' || pattern.isCustom) {
            console.log('Ã¢Å“â€¦ Custom Roster - always valid');
            return true;
          }
          
          if (pattern.weeklySchedule) {
            // FIXED: Use the same day name mapping as getShiftTimesForDate
            const d = new Date(date);
            const dayIndex = d.getDay();
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayName = daysOfWeek[dayIndex];
            
            // DETAILED LOGGING - Show ALL days in the schedule
            console.log('Ã°Å¸â€œâ€¦ Day mapping:', { dayIndex, dayName });
            console.log('Ã°Å¸â€œâ€¦ FULL WEEKLY SCHEDULE for pattern "' + pattern.name + '":');
            daysOfWeek.forEach(day => {
              const schedule = pattern.weeklySchedule[day];
              if (schedule && schedule.startTime) {
                console.log(`   ${day}: ${schedule.startTime} - ${schedule.endTime || 'next day'}`);
              } else {
                console.log(`   ${day}: NO HOURS`);
              }
            });
            
            const daySchedule = pattern.weeklySchedule[dayName];
            // A day is valid if it has a START time (shift begins this day)
            // End time can be blank if shift continues to next day
            const hasHours = daySchedule && daySchedule.startTime && daySchedule.startTime !== '' && daySchedule.startTime !== '--:--';
            console.log(hasHours ? `Ã¢Å“â€¦ ${dayName} HAS HOURS` : `Ã¢ÂÅ’ ${dayName} HAS NO HOURS`, daySchedule);
            return hasHours;
          }
          // Legacy patterns work for all days
          console.log('Ã¢Å“â€¦ Legacy pattern - always valid');
          return true;
        };

        // Get alternative valid shift patterns for a specific day
        const getValidShiftPatternsForDay = (shiftPatterns, projectId, date) => {
          const projectPatterns = shiftPatterns.filter(sp => sp.projectId === projectId);
          return projectPatterns.filter(pattern => shiftPatternHasHoursForDay(pattern, date));
        };

        // NEW: Check if employee has multiple shifts on same date
        const hasMultipleShiftsOnDate = (employeeId, date, assignments) => {
          const shiftsOnDate = assignments.filter(a => 
            a.employeeId === employeeId && a.date === date
          );
          return shiftsOnDate.length > 1;
        };

        // NEW: Check if there's a dangerous day-to-night transition
        const hasDangerousDayNightTransition = (employeeId, date, assignments, shiftPatterns) => {
          const shiftsOnDate = assignments.filter(a => 
            a.employeeId === employeeId && a.date === date
          );
          
          if (shiftsOnDate.length < 2) return false;
          
          // Check if one is day shift and one is night shift
          let hasDayShift = false;
          let hasNightShift = false;
          
          shiftsOnDate.forEach(assignment => {
            const pattern = shiftPatterns.find(p => p.id === assignment.shiftPatternId);
            if (pattern) {
              if (pattern.isNight) {
                hasNightShift = true;
              } else {
                hasDayShift = true;
              }
            }
          });
          
          return hasDayShift && hasNightShift;
        };

        const checkCompliance = (employeeId, assignments, shiftPatterns) => {
          const violations = [];
          
          const empAssignments = assignments
            .filter(a => a.employeeId === employeeId)
            .sort((a, b) => new Date(a.date) - new Date(b.date));
          
          // Check 1: Maximum shift length
          empAssignments.forEach(assignment => {
            const pattern = shiftPatterns.find(p => p.id === assignment.shiftPatternId);
            if (pattern) {
              const times = getShiftTimesForDate(pattern, assignment.date, assignment);
              const duration = calculateShiftDuration(times.startTime, times.endTime);
              if (duration > 12) {
                violations.push({
                  type: 'MAX_SHIFT_LENGTH',
                  severity: 'error',
                  date: assignment.date,
                  message: `Shift exceeds 12 hours (${duration.toFixed(1)}h)`
                });
              }
            }
          });
          
          // NEW Check 2a: Multiple shifts on same day
          empAssignments.forEach(assignment => {
            if (hasMultipleShiftsOnDate(employeeId, assignment.date, assignments)) {
              // Check if this is a day-to-night transition (more dangerous)
              if (hasDangerousDayNightTransition(employeeId, assignment.date, assignments, shiftPatterns)) {
                const existing = violations.find(v => 
                  v.type === 'DAY_NIGHT_TRANSITION' && v.date === assignment.date
                );
                if (!existing) {
                  violations.push({
                    type: 'DAY_NIGHT_TRANSITION',
                    severity: 'error',
                    date: assignment.date,
                    message: 'Day shift followed by night shift on same date - insufficient rest'
                  });
                }
              } else {
                const existing = violations.find(v => 
                  v.type === 'MULTIPLE_SHIFTS_SAME_DAY' && v.date === assignment.date
                );
                if (!existing) {
                  violations.push({
                    type: 'MULTIPLE_SHIFTS_SAME_DAY',
                    severity: 'error',
                    date: assignment.date,
                    message: 'Multiple shifts assigned on same date'
                  });
                }
              }
            }
          });
          
          // Check 2b: Minimum rest period between consecutive days
          for (let i = 0; i < empAssignments.length - 1; i++) {
            const current = empAssignments[i];
            const next = empAssignments[i + 1];
            
            const currentPattern = shiftPatterns.find(p => p.id === current.shiftPatternId);
            const nextPattern = shiftPatterns.find(p => p.id === next.shiftPatternId);
            
            if (currentPattern && nextPattern) {
              const currentDate = new Date(current.date);
              const nextDate = new Date(next.date);
              const daysDiff = (nextDate - currentDate) / (1000 * 60 * 60 * 24);
              
              if (daysDiff === 1) {
                const currentTimes = getShiftTimesForDate(currentPattern, current.date, current);
                const nextTimes = getShiftTimesForDate(nextPattern, next.date, next);
                
                const [endHour, endMin] = currentTimes.endTime.split(':').map(Number);
                const [startHour, startMin] = nextTimes.startTime.split(':').map(Number);
                
                let restHours = (startHour * 60 + startMin) - (endHour * 60 + endMin);
                if (restHours < 0) restHours += 24 * 60;
                restHours = restHours / 60;
                
                if (restHours < 12) {
                  violations.push({
                    type: 'INSUFFICIENT_REST',
                    severity: 'error',
                    date: next.date,
                    message: `Only ${restHours.toFixed(1)}h rest between shifts (min 12h required)`
                  });
                }
              }
            }
          }
          
          // Check 3: Maximum 72 hours in rolling 7-day period
          empAssignments.forEach((assignment) => {
            const windowStart = new Date(assignment.date);
            const windowEnd = new Date(windowStart);
            windowEnd.setDate(windowEnd.getDate() + 6);
            
            const windowAssignments = empAssignments.filter(a => {
              const aDate = new Date(a.date);
              return aDate >= windowStart && aDate <= windowEnd;
            });
            
            let totalHours = 0;
            windowAssignments.forEach(a => {
              const pattern = shiftPatterns.find(p => p.id === a.shiftPatternId);
              if (pattern) {
                const times = getShiftTimesForDate(pattern, a.date, a);
                totalHours += calculateShiftDuration(times.startTime, times.endTime);
              }
            });
            
            if (totalHours > 72) {
              const existingViolation = violations.find(
                v => v.type === 'MAX_WEEKLY_HOURS' && 
                Math.abs(new Date(v.date) - windowStart) < 7 * 24 * 60 * 60 * 1000
              );
              
              if (!existingViolation) {
                violations.push({
                  type: 'MAX_WEEKLY_HOURS',
                  severity: 'error',
                  date: assignment.date,
                  windowEnd: windowEnd.toISOString().split('T')[0],
                  message: `Exceeds 72h in 7-day period (${totalHours.toFixed(1)}h total, breach by ${(totalHours - 72).toFixed(1)}h)`,
                  totalHours
                });
              }
            } else if (totalHours > 66) {
              const existingWarning = violations.find(
                v => v.type === 'APPROACHING_WEEKLY_LIMIT' && 
                Math.abs(new Date(v.date) - windowStart) < 7 * 24 * 60 * 60 * 1000
              );
              
              if (!existingWarning) {
                violations.push({
                  type: 'APPROACHING_WEEKLY_LIMIT',
                  severity: 'warning',
                  date: assignment.date,
                  message: `Approaching 72h limit (${totalHours.toFixed(1)}h in rolling 7 days)`,
                  totalHours
                });
              }
            }
          });
          
          return violations;
        };

        const getEmployeeComplianceStatus = (employeeId, assignments, shiftPatterns) => {
          const violations = checkCompliance(employeeId, assignments, shiftPatterns);
          const errors = violations.filter(v => v.severity === 'error');
          const warnings = violations.filter(v => v.severity === 'warning');
          
          if (errors.length > 0) return { status: 'error', violations: errors };
          if (warnings.length > 0) return { status: 'warning', violations: warnings };
          return { status: 'ok', violations: [] };
        };

        // ==================== MAIN APP (First 1000 lines) ====================

        const FatigueManagementApp = ({ user, onSignOut }) => {
          const [currentView, setCurrentView] = useState('dashboard');
          const [selectedProject, setSelectedProject] = useState(null);
          const [selectedEmployee, setSelectedEmployee] = useState(null);
          const [planningViewMode, setPlanningViewMode] = useState('timeline');
          const [currentWeekStart, setCurrentWeekStart] = useState('2025-11-03');
          
          // Network Rail period state
          const [selectedYear, setSelectedYear] = useState(2025);
          const [selectedPeriod, setSelectedPeriod] = useState(null);
          
          // Generate periods based on selected year
          const networkRailPeriods = useMemo(() => {
            return generateNetworkRailPeriods(selectedYear);
          }, [selectedYear]);
          
          // Initialize selected period when project is selected
          React.useEffect(() => {
            if (selectedProject && networkRailPeriods.length > 0) {
              if (!selectedPeriod) {
                setSelectedPeriod(networkRailPeriods[0].id);
              }
              // Update currentWeekStart when period changes
              const period = networkRailPeriods.find(p => p.id === selectedPeriod);
              if (period) {
                setCurrentWeekStart(period.startDate);
              }
            }
          }, [selectedProject, selectedPeriod, networkRailPeriods]);
          
          // Employee search and drag state
          const [employeeSearchTerm, setEmployeeSearchTerm] = useState('');
          const draggedEmployeeRef = React.useRef(null); // Use ref instead of state
          const draggedAssignmentsRef = React.useRef(null); // For dragging date assignments
          const [dragOverCell, setDragOverCell] = useState(null);
          const [selectedEmployees, setSelectedEmployees] = useState([]); // Multi-select state
          const [selectedTiles, setSelectedTiles] = useState([]); // Selected shift tiles {employeeId, date, assignmentId, shiftPatternId}
          const [tileDragging, setTileDragging] = useState(null); // { startX, startDate }
          
          // Handle tile selection (click on shift tile)
          const handleTileClick = (e, employeeId, date, assignmentId, shiftPatternId) => {
            e.stopPropagation();
            
            const tileKey = `${employeeId}-${date}-${shiftPatternId}`;
            const isSelected = selectedTiles.some(t => `${t.employeeId}-${t.date}-${t.shiftPatternId}` === tileKey);
            
            if (e.shiftKey) {
              // Shift+click: Toggle tile in selection
              if (isSelected) {
                setSelectedTiles(selectedTiles.filter(t => `${t.employeeId}-${t.date}-${t.shiftPatternId}` !== tileKey));
              } else {
                setSelectedTiles([...selectedTiles, { employeeId, date, assignmentId, shiftPatternId }]);
              }
            } else {
              // Regular click: Select only this tile
              setSelectedTiles([{ employeeId, date, assignmentId, shiftPatternId }]);
            }
          };
          
          // Handle drag start on selected tile (no Ctrl needed)
          const handleTileCtrlDragStart = (e, employeeId, date, assignmentId, shiftPatternId) => {
            const tileKey = `${employeeId}-${date}-${shiftPatternId}`;
            const isSelected = selectedTiles.some(t => `${t.employeeId}-${t.date}-${t.shiftPatternId}` === tileKey);
            
            if (!isSelected || selectedTiles.length === 0) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            setTileDragging({
              startX: e.clientX,
              currentX: e.clientX,
              startDate: date
            });
          };
          
          const handleTileCtrlDragMove = (e) => {
            if (!tileDragging) return;
            e.preventDefault();
            
            const dragDistance = e.clientX - tileDragging.startX;
            // Cell width is 120px based on grid-template-columns: 200px repeat(28, 120px)
            const daysForward = Math.max(0, Math.floor(dragDistance / 120));
            
            setTileDragging(prev => ({
              ...prev,
              currentX: e.clientX,
              daysForward: daysForward
            }));
          };
          
          const handleTileCtrlDragEnd = async (e) => {
            if (!tileDragging) return;
            
            const dragDistance = e.clientX - tileDragging.startX;
            const daysToAdvance = Math.max(0, Math.floor(dragDistance / 120)); // Cell width is 120px
            
            if (daysToAdvance < 1) {
              console.log('Ã¢ÂÂ­Ã¯Â¸Â Drag too short - no assignments created');
              setTileDragging(null);
              return;
            }
            
            console.log(`Ã°Å¸Å½Â¯ Drag: Copying ${selectedTiles.length} assignments forward ${daysToAdvance} days`);
            
            let assignmentsCreated = 0;
            let assignmentsSkipped = 0;
            
            // Calculate maxId once at the start
            let currentMaxId = Math.max(...assignments.map(a => a.id), 0);
            console.log(`Ã°Å¸â€œÅ  Starting with maxId: ${currentMaxId}`);
            
            // For each selected tile, copy it forward
            for (const tile of selectedTiles) {
              console.log(`\nÃ°Å¸â€â€ž Processing tile:`, tile);
              const assignment = assignments.find(a => a.id === tile.assignmentId);
              if (!assignment) {
                console.log('Ã¢ÂÅ’ Assignment not found');
                continue;
              }
              
              const pattern = shiftPatterns.find(p => p.id === tile.shiftPatternId);
              if (!pattern) {
                console.log('Ã¢ÂÅ’ Pattern not found');
                continue;
              }
              
              console.log(`Ã°Å¸â€œâ€¹ Pattern: ${pattern.name}, Days to advance: ${daysToAdvance}`);
              
              // Create assignments for the next N days
              for (let dayOffset = 1; dayOffset <= daysToAdvance; dayOffset++) {
                const originalDate = new Date(tile.date);
                const newDate = new Date(originalDate);
                newDate.setDate(newDate.getDate() + dayOffset);
                const newDateStr = newDate.toISOString().split('T')[0];
                
                console.log(`\n  Ã°Å¸â€œâ€¦ Day offset ${dayOffset}: ${newDateStr}`);
                
                // Check if pattern has hours for this day (skip if not)
                const hasHours = shiftPatternHasHoursForDay(pattern, newDateStr);
                if (!hasHours) {
                  console.log(`  Ã¢ÂÂ­Ã¯Â¸Â Skipping ${newDateStr}: No hours in pattern`);
                  assignmentsSkipped++;
                  continue;
                }
                
                // Check if employee is already assigned to this shift pattern on this date
                const existingAssignment = assignments.find(a => 
                  a.employeeId === tile.employeeId && 
                  a.shiftPatternId === tile.shiftPatternId && 
                  a.date === newDateStr
                );
                
                if (existingAssignment) {
                  console.log(`  Ã¢ÂÂ­Ã¯Â¸Â Skipping ${newDateStr}: Already assigned (ID: ${existingAssignment.id})`);
                  assignmentsSkipped++;
                  continue;
                }
                
                // Create the assignment with properly incremented ID
                try {
                  currentMaxId++; // Increment for each new assignment
                  const newAssignment = {
                    id: currentMaxId,
                    employeeId: tile.employeeId,
                    projectId: assignment.projectId,
                    shiftPatternId: tile.shiftPatternId,
                    date: newDateStr
                  };
                  
                  console.log(`  Ã°Å¸â€™Â¾ Saving assignment ID ${newAssignment.id} for ${newDateStr}...`);
                  await db.collection('assignments').doc(String(newAssignment.id)).set(newAssignment);
                  assignmentsCreated++;
                  console.log(`  Ã¢Å“â€¦ Successfully created assignment ID ${newAssignment.id} for ${newDateStr}`);
                } catch (error) {
                  console.error(`  Ã¢ÂÅ’ Error creating assignment for ${newDateStr}:`, error);
                }
              }
            }
            
            // Show toast notification
            const message = `Ã¢Å“â€¦ Created ${assignmentsCreated} assignments${assignmentsSkipped > 0 ? `, skipped ${assignmentsSkipped} (no hours in pattern)` : ''}`;
            console.log(message);
            
            setTileDragging(null);
            setSelectedTiles([]); // Clear selection after drag
          };
          
          // Event listeners for tile drag
          React.useEffect(() => {
            if (tileDragging) {
              window.addEventListener('mousemove', handleTileCtrlDragMove);
              window.addEventListener('mouseup', handleTileCtrlDragEnd);
              return () => {
                window.removeEventListener('mousemove', handleTileCtrlDragMove);
                window.removeEventListener('mouseup', handleTileCtrlDragEnd);
              };
            }
          }, [tileDragging, selectedTiles, assignments]);
          const [selectedDateAssignments, setSelectedDateAssignments] = useState(null); // For Ctrl+click date selection
          
          // Resizable panel state
          const [employeePanelHeight, setEmployeePanelHeight] = useState(200);
          const [isResizing, setIsResizing] = useState(false);
          const resizeStartY = React.useRef(0);
          const resizeStartHeight = React.useRef(0);
          
          const [projects, setProjects] = useState([]);
          const [employees, setEmployees] = useState([]);
          const [teams, setTeams] = useState([]);
          const [assignments, setAssignments] = useState([]);
          const [shiftPatterns, setShiftPatterns] = useState([]);
          const [loading, setLoading] = useState(true);
          
          // Load data from Supabase
          const loadAllData = async () => {
            try {
              const [employeesRes, projectsRes, teamsRes, patternsRes, assignmentsRes] = await Promise.all([
                supabase.from('employees').select('*').order('name'),
                supabase.from('projects').select('*').order('name'),
                supabase.from('teams').select('*').order('name'),
                supabase.from('shift_patterns').select('*').order('name'),
                supabase.from('assignments').select('*').order('date'),
              ]);
              
              // Map snake_case to camelCase for compatibility
              if (employeesRes.data) setEmployees(employeesRes.data.map(e => ({
                ...e, teamId: e.team_id, organisationId: e.organisation_id
              })));
              if (projectsRes.data) setProjects(projectsRes.data.map(p => ({
                ...p, startDate: p.start_date, endDate: p.end_date, organisationId: p.organisation_id
              })));
              if (teamsRes.data) setTeams(teamsRes.data.map(t => ({
                ...t, memberIds: t.member_ids || [], organisationId: t.organisation_id
              })));
              if (patternsRes.data) setShiftPatterns(patternsRes.data.map(sp => ({
                ...sp, 
                projectId: sp.project_id,
                startTime: sp.start_time,
                endTime: sp.end_time,
                dutyType: sp.duty_type,
                isNight: sp.is_night,
                weeklySchedule: sp.weekly_schedule,
                organisationId: sp.organisation_id
              })));
              if (assignmentsRes.data) setAssignments(assignmentsRes.data.map(a => ({
                ...a,
                employeeId: a.employee_id,
                projectId: a.project_id,
                shiftPatternId: a.shift_pattern_id,
                customStartTime: a.custom_start_time,
                customEndTime: a.custom_end_time,
                organisationId: a.organisation_id
              })));
            } catch (err) {
              console.error('Error loading data:', err);
            } finally {
              setLoading(false);
            }
          };
          
          useEffect(() => {
            loadAllData();
            
            // Set up Supabase realtime subscriptions
            const channel = supabase.channel('db-changes')
              .on('postgres_changes', { event: '*', schema: 'public' }, () => {
                loadAllData();
              })
              .subscribe();
            
            return () => {
              supabase.removeChannel(channel);
            };
          }, []);
          
          const [showAssignmentModal, setShowAssignmentModal] = useState(false);
          const [assignmentModalData, setAssignmentModalData] = useState(null);
          const [showShiftPatternModal, setShowShiftPatternModal] = useState(false);
          const [shiftPatternModalData, setShiftPatternModalData] = useState(null);
          const [showProjectModal, setShowProjectModal] = useState(false);
          const [showNoRosterModal, setShowNoRosterModal] = useState(false);
          const [noRosterModalData, setNoRosterModalData] = useState(null);
          const [showManualOverrideModal, setShowManualOverrideModal] = useState(false);
          const [manualOverrideData, setManualOverrideData] = useState(null);
          const [showExportModal, setShowExportModal] = useState(false);
          const [showImportModal, setShowImportModal] = useState(false);
          const [importFile, setImportFile] = useState(null);
          const [importPreview, setImportPreview] = useState(null);
          const [importErrors, setImportErrors] = useState([]);
          const [showTeamModal, setShowTeamModal] = useState(false);
          const [teamModalData, setTeamModalData] = useState(null);
          const [showTeamAssignModal, setShowTeamAssignModal] = useState(false);
          const [teamAssignModalData, setTeamAssignModalData] = useState(null);
          
          const getProjectStats = (projectId) => {
            const projectAssignments = assignments.filter(a => a.projectId === projectId);
            
            let totalHours = 0;
            const uniqueEmployees = new Set();
            
            projectAssignments.forEach(assignment => {
              uniqueEmployees.add(assignment.employeeId);
              const pattern = shiftPatterns.find(p => p.id === assignment.shiftPatternId);
              if (pattern) {
                const times = getShiftTimesForDate(pattern, assignment.date, assignment);
                totalHours += calculateShiftDuration(times.startTime, times.endTime);
              }
            });
            
            const violations = [];
            Array.from(uniqueEmployees).forEach(empId => {
              const empViolations = checkCompliance(empId, assignments, shiftPatterns);
              const errors = empViolations.filter(v => v.severity === 'error');
              if (errors.length > 0) {
                const employee = employees.find(e => e.id === empId);
                violations.push({
                  employeeId: empId,
                  employeeName: employee?.name || 'Unknown',
                  violations: errors
                });
              }
            });
            
            return {
              totalHours,
              employeeCount: uniqueEmployees.size,
              violations
            };
          };
          
          const addAssignment = async (employeeId, projectId, shiftPatternId, startDate, endDate) => {
            console.log('=== addAssignment called ===');
            console.log('Parameters:', { employeeId, projectId, shiftPatternId, startDate, endDate });
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const newAssignments = [];
            
            let currentDate = new Date(start);
            while (currentDate <= end) {
              newAssignments.push({
                employeeId,
                projectId,
                shiftPatternId,
                date: currentDate.toISOString().split('T')[0]
              });
              currentDate.setDate(currentDate.getDate() + 1);
            }
            
            console.log('New assignments to save:', newAssignments.length);
            
            // Write to Firestore
            try {
              const batch = db.batch();
              let maxId = Math.max(...assignments.map(a => a.id), 0);
              
              newAssignments.forEach((assignment) => {
                maxId++;
                const assignmentWithId = { ...assignment, id: maxId };
                const docRef = db.collection('assignments').doc(String(maxId));
                batch.set(docRef, assignmentWithId);
              });
              
              await batch.commit();
              console.log('Ã¢Å“â€¦ Assignments saved to Firestore');
              // State updates automatically via onSnapshot listener
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error saving assignments:', error);
              alert('Failed to save assignments. Please try again.');
            }
          };

          const updateAssignment = async (assignmentId, newShiftPatternId) => {
            console.log('=== updateAssignment called ===');
            console.log('Parameters:', { assignmentId, newShiftPatternId });
            
            try {
              await db.collection('assignments').doc(String(assignmentId)).update({
                shiftPatternId: newShiftPatternId
              });
              console.log('Ã¢Å“â€¦ Assignment updated in Firestore');
              // State updates automatically via onSnapshot listener
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error updating assignment:', error);
              alert('Failed to update assignment. Please try again.');
            }
          };

          // Add assignment with custom times (for Custom Roster)
          const addAssignmentWithTimes = async (employeeId, projectId, shiftPatternId, startDate, endDate, customStartTime, customEndTime) => {
            console.log('=== addAssignmentWithTimes called ===');
            console.log('Parameters:', { employeeId, projectId, shiftPatternId, startDate, endDate, customStartTime, customEndTime });
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const newAssignments = [];
            
            let currentDate = new Date(start);
            while (currentDate <= end) {
              newAssignments.push({
                employeeId,
                projectId,
                shiftPatternId,
                date: currentDate.toISOString().split('T')[0],
                customStartTime,
                customEndTime
              });
              currentDate.setDate(currentDate.getDate() + 1);
            }
            
            console.log('New assignments with custom times to save:', newAssignments.length);
            
            try {
              const batch = db.batch();
              let maxId = Math.max(...assignments.map(a => a.id), 0);
              
              newAssignments.forEach((assignment) => {
                maxId++;
                const assignmentWithId = { ...assignment, id: maxId };
                const docRef = db.collection('assignments').doc(String(maxId));
                batch.set(docRef, assignmentWithId);
              });
              
              await batch.commit();
              console.log('Ã¢Å“â€¦ Assignments with custom times saved to Firestore');
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error saving assignments:', error);
              alert('Failed to save assignments. Please try again.');
            }
          };

          // Update assignment with custom times
          const updateAssignmentWithTimes = async (assignmentId, newShiftPatternId, customStartTime, customEndTime) => {
            console.log('=== updateAssignmentWithTimes called ===');
            console.log('Parameters:', { assignmentId, newShiftPatternId, customStartTime, customEndTime });
            
            try {
              await db.collection('assignments').doc(String(assignmentId)).update({
                shiftPatternId: newShiftPatternId,
                customStartTime,
                customEndTime
              });
              console.log('Ã¢Å“â€¦ Assignment with custom times updated in Firestore');
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error updating assignment:', error);
              alert('Failed to update assignment. Please try again.');
            }
          };

          // Team CRUD operations
          const addTeam = async (name, memberIds) => {
            const teamId = Date.now();
            const newTeam = {
              id: teamId,
              name,
              memberIds: memberIds || []
            };
            
            try {
              await db.collection('teams').doc(String(teamId)).set(newTeam);
              console.log('Ã¢Å“â€¦ Team saved to Firestore');
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error saving team:', error);
              alert('Failed to save team. Please try again.');
            }
          };

          const updateTeam = async (teamId, name, memberIds) => {
            try {
              await db.collection('teams').doc(String(teamId)).update({
                name,
                memberIds
              });
              console.log('Ã¢Å“â€¦ Team updated in Firestore');
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error updating team:', error);
              alert('Failed to update team. Please try again.');
            }
          };

          const deleteTeam = async (teamId) => {
            try {
              await db.collection('teams').doc(String(teamId)).delete();
              console.log('Ã¢Å“â€¦ Team deleted from Firestore');
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error deleting team:', error);
              alert('Failed to delete team. Please try again.');
            }
          };

          // Bulk assign team to shift pattern
          const assignTeamToPattern = async (teamId, projectId, patternId, startDate, endDate) => {
            const team = teams.find(t => t.id === teamId);
            if (!team || !team.memberIds || team.memberIds.length === 0) {
              alert('Team has no members');
              return;
            }
            
            try {
              const batch = db.batch();
              
              team.memberIds.forEach(employeeId => {
                const assignmentId = `${employeeId}-${projectId}-${patternId}-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
                const assignmentRef = db.collection('assignments').doc(assignmentId);
                batch.set(assignmentRef, {
                  id: assignmentId,
                  date: startDate,
                  employeeId,
                  projectId,
                  patternId,
                  startDate,
                  endDate,
                  isRecurring: true
                });
              });
              
              await batch.commit();
              console.log(`Ã¢Å“â€¦ Assigned ${team.memberIds.length} team members to pattern`);
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error assigning team:', error);
              alert('Failed to assign team. Please try again.');
            }
          };

          const addShiftPattern = async (projectId, name, startTime, endTime, dutyType, isNight) => {
            const patternId = `${projectId}-${Date.now()}`;
            const newPattern = {
              id: patternId,
              projectId,
              name,
              startTime,
              endTime,
              dutyType,
              isNight
            };
            
            try {
              await db.collection('shiftPatterns').doc(patternId).set(newPattern);
              console.log('Ã¢Å“â€¦ Shift pattern saved to Firestore');
              // State updates automatically via onSnapshot listener
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error saving shift pattern:', error);
              alert('Failed to save shift pattern. Please try again.');
            }
          };

          const updateShiftPattern = async (patternId, name, startTime, endTime, dutyType, isNight) => {
            try {
              await db.collection('shiftPatterns').doc(patternId).update({
                name,
                startTime,
                endTime,
                dutyType,
                isNight,
                weeklySchedule: firebase.firestore.FieldValue.delete() // Remove weeklySchedule if it exists
              });
              console.log('Ã¢Å“â€¦ Shift pattern updated in Firestore');
              // State updates automatically via onSnapshot listener
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error updating shift pattern:', error);
              alert('Failed to update shift pattern. Please try again.');
            }
          };

          const addShiftPatternWithWeekly = async (projectId, name, weeklySchedule, dutyType, isNight) => {
            const patternId = `${projectId}-${Date.now()}`;
            const newPattern = {
              id: patternId,
              projectId,
              name,
              weeklySchedule,
              dutyType,
              isNight
            };
            
            try {
              await db.collection('shiftPatterns').doc(patternId).set(newPattern);
              console.log('Ã¢Å“â€¦ Shift pattern with weekly schedule saved to Firestore');
              // State updates automatically via onSnapshot listener
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error saving shift pattern:', error);
              alert('Failed to save shift pattern. Please try again.');
            }
          };

          const updateShiftPatternWithWeekly = async (patternId, name, weeklySchedule, dutyType, isNight) => {
            try {
              await db.collection('shiftPatterns').doc(patternId).update({
                name,
                weeklySchedule,
                dutyType,
                isNight,
                startTime: firebase.firestore.FieldValue.delete(), // Remove simple times if they exist
                endTime: firebase.firestore.FieldValue.delete()
              });
              console.log('Ã¢Å“â€¦ Shift pattern updated with weekly schedule in Firestore');
              // State updates automatically via onSnapshot listener
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error updating shift pattern:', error);
              alert('Failed to update shift pattern. Please try again.');
            }
          };

          const deleteShiftPattern = async (patternId) => {
            // Check if pattern is in use
            const inUse = assignments.some(a => a.shiftPatternId === patternId);
            if (inUse) {
              alert('Cannot delete shift pattern - it is currently in use. Please remove all assignments first.');
              return;
            }
            
            try {
              await db.collection('shiftPatterns').doc(patternId).delete();
              console.log('Ã¢Å“â€¦ Shift pattern deleted from Firestore');
              // State updates automatically via onSnapshot listener
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error deleting shift pattern:', error);
              alert('Failed to delete shift pattern. Please try again.');
            }
          };

          const deleteAssignment = async (assignmentId) => {
            try {
              await db.collection('assignments').doc(String(assignmentId)).delete();
              console.log('Ã¢Å“â€¦ Assignment deleted from Firestore');
              // State updates automatically via onSnapshot listener
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error deleting assignment:', error);
              alert('Failed to delete assignment. Please try again.');
            }
          };

          const addProject = async (projectData) => {
            try {
              // Find the highest project ID and increment
              const maxId = projects.length > 0 ? Math.max(...projects.map(p => p.id)) : 0;
              const newProjectId = maxId + 1;
              
              const newProject = {
                id: newProjectId,
                name: projectData.name,
                location: projectData.location,
                startDate: projectData.startDate,
                endDate: projectData.endDate,
                type: projectData.type
              };
              
              await db.collection('projects').doc(String(newProjectId)).set(newProject);
              console.log('Ã¢Å“â€¦ Project saved to Firestore');
              setShowProjectModal(false);
              // State updates automatically via onSnapshot listener
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error saving project:', error);
              alert('Failed to save project. Please try again.');
            }
          };

          // Helper function to generate time options in 15-minute intervals
          const generateTimeOptions = () => {
            const options = [];
            for (let hour = 0; hour < 24; hour++) {
              for (let minute = 0; minute < 60; minute += 15) {
                const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                options.push(timeStr);
              }
            }
            return options;
          };

          // Check if a shift is overnight (finish time is before start time)
          const isOvernightShift = (startTime, endTime) => {
            if (!startTime || !endTime) return false;
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            const startMinutes = startHour * 60 + startMin;
            const endMinutes = endHour * 60 + endMin;
            return endMinutes < startMinutes;
          };

          // Bulk Import/Export Functions
          const exportShiftTemplate = () => {
            if (!selectedProject) {
              alert('Please select a project first');
              return;
            }
            
            const project = projects.find(p => p.id === selectedProject);
            const projectShiftPatterns = shiftPatterns.filter(sp => sp.projectId === selectedProject);
            const period = networkRailPeriods.find(p => p.id === selectedPeriod);
            
            // Generate dates for the selected period
            const startDate = period ? new Date(period.startDate) : new Date(project.startDate);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 27); // 28 days total
            
            // Create template data with instructions
            const templateData = [
              ['Network Rail Fatigue Management - Shift Upload Template'],
              ['Project: ' + project.name],
              ['Period: ' + (period ? period.name : 'N/A')],
              ['Period Dates: ' + startDate.toISOString().split('T')[0] + ' to ' + endDate.toISOString().split('T')[0]],
              [''],
              ['INSTRUCTIONS:'],
              ['1. Fill in the Employee Name (must match exactly from employee list)'],
              ['2. Enter the Start Date in YYYY-MM-DD format'],
              ['3. Enter the End Date in YYYY-MM-DD format (shifts will be created for all days in range)'],
              ['4. Enter the Shift Pattern name (must match exactly from available patterns)'],
              ['5. Do not modify the header row'],
              ['6. You can add as many rows as needed'],
              ['7. Save and upload this file when complete'],
              [''],
              ['EXAMPLE: To assign John Smith to Day Shift from Nov 3-5, enter:'],
              ['Employee Name: John Smith, Start Date: 2025-11-03, End Date: 2025-11-05, Shift Pattern: Day Shift'],
              ['This will create 3 shifts (one for each day in the range)'],
              [''],
              ['Employee Name', 'Start Date', 'End Date', 'Shift Pattern', 'Notes'],
              // Add example rows
              ['', startDate.toISOString().split('T')[0], startDate.toISOString().split('T')[0], '', 'Example: Single day assignment'],
              ['', startDate.toISOString().split('T')[0], new Date(startDate.getTime() + 6*24*60*60*1000).toISOString().split('T')[0], '', 'Example: 7-day block']
            ];
            
            // Create reference sheet with valid data
            const employeeList = [['Available Employees'], [''], ['Copy these names exactly:'], ...employees.map(e => [e.name])];
            const shiftPatternList = [
              ['Available Shift Patterns', 'Times', 'Type'],
              [''],
              ['Copy these names exactly:'],
              ...projectShiftPatterns.map(sp => [sp.name, `${sp.startTime}-${sp.endTime}`, sp.dutyType])
            ];
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const wsTemplate = XLSX.utils.aoa_to_sheet(templateData);
            const wsEmployees = XLSX.utils.aoa_to_sheet(employeeList);
            const wsShifts = XLSX.utils.aoa_to_sheet(shiftPatternList);
            
            // Set column widths
            wsTemplate['!cols'] = [
              { wch: 25 }, // Employee Name
              { wch: 12 }, // Start Date
              { wch: 12 }, // End Date
              { wch: 20 }, // Shift Pattern
              { wch: 35 }  // Notes
            ];
            
            wsEmployees['!cols'] = [{ wch: 30 }];
            wsShifts['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 15 }];
            
            XLSX.utils.book_append_sheet(wb, wsTemplate, 'Upload Template');
            XLSX.utils.book_append_sheet(wb, wsEmployees, 'Employee List');
            XLSX.utils.book_append_sheet(wb, wsShifts, 'Shift Patterns');
            
            // Download file
            const fileName = `Shift_Upload_Template_${project.name.replace(/\s+/g, '_')}_${period?.name.replace(/\s+/g, '_') || 'Period'}.xlsx`;
            XLSX.writeFile(wb, fileName);
          };

          const importShifts = (file) => {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                // Find the header row (contains "Employee Name", "Start Date", "End Date")
                let headerRowIndex = -1;
                for (let i = 0; i < jsonData.length; i++) {
                  if (jsonData[i][0] === 'Employee Name' && (jsonData[i][1] === 'Start Date' || jsonData[i][1] === 'Date')) {
                    headerRowIndex = i;
                    break;
                  }
                }
                
                if (headerRowIndex === -1) {
                  alert('Invalid template format. Could not find header row.');
                  return;
                }
                
                // Check if this is the new format (Start Date/End Date) or old format (Date)
                const isRangeFormat = jsonData[headerRowIndex][1] === 'Start Date';
                
                // Process data rows
                const dataRows = jsonData.slice(headerRowIndex + 1).filter(row => 
                  row[0] && row[1] && (isRangeFormat ? row[2] && row[3] : row[2])
                );
                
                if (dataRows.length === 0) {
                  alert('No valid data found in the template. Please add shift assignments.');
                  return;
                }
                
                // Validate and create assignments
                const newAssignments = [];
                const errors = [];
                const projectShiftPatterns = shiftPatterns.filter(sp => sp.projectId === selectedProject);
                
                dataRows.forEach((row, idx) => {
                  const employeeName = row[0]?.toString().trim();
                  const startDate = row[1]?.toString().trim();
                  const endDate = isRangeFormat ? row[2]?.toString().trim() : startDate;
                  const shiftPatternName = isRangeFormat ? row[3]?.toString().trim() : row[2]?.toString().trim();
                  const notes = isRangeFormat ? row[4]?.toString() : row[3]?.toString();
                  
                  // Skip example rows
                  if (notes?.includes('Example')) return;
                  
                  // Find employee
                  const employee = employees.find(e => e.name.toLowerCase() === employeeName.toLowerCase());
                  if (!employee) {
                    errors.push(`Row ${idx + headerRowIndex + 2}: Employee "${employeeName}" not found`);
                    return;
                  }
                  
                  // Validate date formats
                  const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                  if (!dateRegex.test(startDate)) {
                    errors.push(`Row ${idx + headerRowIndex + 2}: Invalid start date format "${startDate}". Use YYYY-MM-DD`);
                    return;
                  }
                  if (!dateRegex.test(endDate)) {
                    errors.push(`Row ${idx + headerRowIndex + 2}: Invalid end date format "${endDate}". Use YYYY-MM-DD`);
                    return;
                  }
                  
                  // Validate date range
                  const start = new Date(startDate);
                  const end = new Date(endDate);
                  if (end < start) {
                    errors.push(`Row ${idx + headerRowIndex + 2}: End date cannot be before start date`);
                    return;
                  }
                  
                  // Check for reasonable date range (warn if > 28 days)
                  const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                  if (daysDiff > 28) {
                    errors.push(`Row ${idx + headerRowIndex + 2}: Date range is ${daysDiff} days - this seems unusually long. Please verify.`);
                    return;
                  }
                  
                  // Find shift pattern
                  const shiftPattern = projectShiftPatterns.find(sp => 
                    sp.name.toLowerCase() === shiftPatternName.toLowerCase()
                  );
                  if (!shiftPattern) {
                    errors.push(`Row ${idx + headerRowIndex + 2}: Shift pattern "${shiftPatternName}" not found for this project`);
                    return;
                  }
                  
                  // Create assignments for each day in the range
                  let currentDate = new Date(start);
                  while (currentDate <= end) {
                    newAssignments.push({
                      id: Date.now() + Math.random(),
                      employeeId: employee.id,
                      projectId: selectedProject,
                      shiftPatternId: shiftPattern.id,
                      date: currentDate.toISOString().split('T')[0]
                    });
                    currentDate.setDate(currentDate.getDate() + 1);
                  }
                });
                
                // Show results
                if (errors.length > 0) {
                  const errorMsg = `Found ${errors.length} error(s):\n\n${errors.slice(0, 10).join('\n')}${errors.length > 10 ? '\n\n...and ' + (errors.length - 10) + ' more errors' : ''}\n\n${newAssignments.length} valid assignments were found. Import anyway?`;
                  if (!confirm(errorMsg)) return;
                }
                
                if (newAssignments.length === 0) {
                  alert('No valid assignments to import.');
                  return;
                }
                
                // Add assignments to Firestore
                (async () => {
                  try {
                    const batch = db.batch();
                    let maxId = Math.max(...assignments.map(a => a.id), 0);
                    
                    newAssignments.forEach((assignment) => {
                      maxId++;
                      const assignmentWithId = { ...assignment, id: maxId };
                      const docRef = db.collection('assignments').doc(String(maxId));
                      batch.set(docRef, assignmentWithId);
                    });
                    
                    await batch.commit();
                    console.log('Ã¢Å“â€¦ Imported assignments saved to Firestore');
                    alert(`Successfully imported ${newAssignments.length} shift assignment(s)!`);
                    
                    // Check for compliance violations
                    setTimeout(() => {
                      const violations = getProjectStats(selectedProject).violations;
                      if (violations.length > 0) {
                        alert(`Warning: ${violations.length} employee(s) now have compliance violations. Please review the Compliance Violations section.`);
                      }
                    }, 500); // Give time for Firestore to sync
                    
                  } catch (error) {
                    console.error('Ã¢ÂÅ’ Error importing assignments:', error);
                    alert('Failed to import assignments. Please try again.');
                  }
                })();
                
              } catch (error) {
                console.error('Import error:', error);
                alert('Error reading file: ' + error.message);
              }
            };
            reader.readAsArrayBuffer(file);
          };

          // Dashboard View Component
          const DashboardView = () => (
            <div style={{ minHeight: '100vh', background: '#f1f5f9' }}>
              {/* Header */}
              <div style={{ 
                  background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)', 
                  padding: '0.75rem 1.5rem',
                  borderBottom: '3px solid #3b82f6',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between'
              }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                      <div style={{ color: 'white', fontWeight: 600, fontSize: '1.1rem' }}>
                          Network Rail <span style={{ color: '#3b82f6' }}>Fatigue Management</span>
                      </div>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                      <div style={{
                          background: '#334155',
                          color: '#3b82f6',
                          padding: '0.375rem 0.75rem',
                          borderRadius: '4px',
                          fontFamily: 'ui-monospace, monospace',
                          fontSize: '0.7rem',
                          fontWeight: 500
                      }}>
                          DASHBOARD
                      </div>
                      <SignOutHeader user={user} onSignOut={onSignOut} />
                  </div>
              </div>
              
              <div className="p-6">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {projects.map(project => {
                  const stats = getProjectStats(project.id);
                  return (
                    <div key={project.id} className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer"
                         onClick={() => { setSelectedProject(project.id); setCurrentView('planning'); }}>
                      <div className="flex items-start justify-between mb-4">
                        <div>
                          <h3 className="text-xl font-semibold text-gray-900">{project.name}</h3>
                          <p className="text-sm text-gray-600">{project.location}</p>
                          <p className="text-xs text-gray-500 mt-1">{project.type}</p>
                        </div>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            setSelectedProject(project.id);
                            setCurrentView('summary');
                          }}
                          className="hover:scale-110 transition-transform"
                          title="View project summary">
                          {stats.violations.length > 0 ? (
                            <ErrorTriangle className="w-6 h-6 text-red-500" />
                          ) : (
                            <CheckCircle className="w-6 h-6 text-green-500" />
                          )}
                        </button>
                      </div>
                      
                      <div className="space-y-2 text-sm">
                        <div className="flex justify-between">
                          <span className="text-gray-600">Total Hours:</span>
                          <span className="font-semibold">{stats.totalHours.toLocaleString()}h</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-gray-600">Employees:</span>
                          <span className="font-semibold">{stats.employeeCount}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-gray-600">Compliance:</span>
                          <span className={`font-semibold ${stats.violations.length > 0 ? 'text-red-600' : 'text-green-600'}`}>
                            {stats.violations.length === 0 ? 'Compliant' : `${stats.violations.length} Breach${stats.violations.length > 1 ? 'es' : ''}`}
                          </span>
                        </div>
                      </div>
                      
                      <button className="mt-4 w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition-colors">
                        Open Project
                      </button>
                    </div>
                  );
                })}
                
                {/* Create New Project Card */}
                <div 
                  onClick={() => setShowProjectModal(true)}
                  className="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-dashed border-blue-300 rounded-lg shadow-md p-6 hover:shadow-lg hover:border-blue-500 transition-all cursor-pointer flex flex-col items-center justify-center min-h-[280px]">
                  <div className="bg-blue-600 rounded-full p-4 mb-4">
                    <Plus className="w-8 h-8 text-white" />
                  </div>
                  <h3 className="text-xl font-semibold text-gray-900 mb-2">Create New Project</h3>
                  <p className="text-sm text-gray-600 text-center">Add a new project to start planning shifts</p>
                </div>
              </div>
              
              <div className="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                <button 
                  onClick={() => { setCurrentView('person'); setSelectedEmployee(employees[0].id); }}
                  className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow text-left">
                  <Calendar className="w-8 h-8 text-blue-600 mb-2" />
                  <h3 className="text-xl font-semibold text-gray-900">Employee View</h3>
                  <p className="text-gray-600 mt-2">Check individual compliance and schedules</p>
                </button>
                
                <button 
                  onClick={() => setCurrentView('fatigue')}
                  className="bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow text-left">
                  <svg className="w-8 h-8 text-orange-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                  </svg>
                  <h3 className="text-xl font-semibold text-gray-900">Fatigue Risk Assessment</h3>
                  <p className="text-gray-600 mt-2">HSE RR446 compliant shift pattern analysis</p>
                  <span className="inline-block mt-2 text-xs font-medium text-orange-600 bg-orange-100 px-2 py-1 rounded">NEW</span>
                </button>
                
                <button 
                  onClick={() => setCurrentView('teams')}
                  className="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow text-left">
                  <Users className="w-8 h-8 text-purple-600 mb-2" />
                  <h3 className="text-xl font-semibold text-gray-900">Team Management</h3>
                  <p className="text-gray-600 mt-2">Create teams and assign them to shift patterns</p>
                  <span className="inline-block mt-2 text-xs font-medium text-purple-600 bg-purple-100 px-2 py-1 rounded">NEW</span>
                </button>
              </div>
              </div>
            </div>
          );

          // Show loading state
          if (loading) {
            return (
              <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                <div className="text-center">
                  <div className="mb-4">
                    <svg className="animate-spin h-12 w-12 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                  </div>
                  <p className="text-gray-600">Loading data from Firestore...</p>
                </div>
              </div>
            );
          }

          // Render different views based on currentView state
          return (
            <div className="min-h-screen bg-gray-100">
              {currentView === 'dashboard' && <DashboardView />}
              {currentView === 'planning' && <PlanningViewContainer />}
              {currentView === 'person' && <PersonViewContainer />}
              {currentView === 'summary' && <ProjectSummaryContainer />}
              {currentView === 'fatigue' && <FatigueAssessmentView />}
              {currentView === 'teams' && <TeamsView />}
              
              {showProjectModal && <ProjectModal />}
              {showAssignmentModal && <AssignmentModal />}
              {showShiftPatternModal && <ShiftPatternModal />}
              {showNoRosterModal && noRosterModalData && <NoRosterModal />}
              {showManualOverrideModal && <ManualOverrideModal />}
              {showExportModal && <ExportModal />}
              {showImportModal && <ImportModal />}
              {showTeamModal && <TeamModal />}
              {showTeamAssignModal && <TeamAssignModal />}
            </div>
          );

          // Fatigue Assessment View - HSE Risk Index Calculator
          function FatigueAssessmentView() {
            const [shifts, setShifts] = useState([]);
            const [defaults, setDefaults] = useState(DEFAULT_FATIGUE_PARAMS);
            const [showDefaults, setShowDefaults] = useState(false);
            
            // Create a new shift with default parameters
            const createNewShift = (day, startTime, endTime) => ({
                id: Date.now(),
                day,
                startTime,
                endTime,
                // Per-shift parameters (will use defaults if not set)
                commuteIn: defaults.commuteTime,
                commuteOut: defaults.commuteTime,
                workload: defaults.workload,
                attention: defaults.attention,
                breakFrequency: defaults.breakFrequency,
                breakLength: defaults.breakLength
            });
            
            // Calculate results for all shifts
            const results = useMemo(() => {
                if (shifts.length === 0) return null;
                
                const sortedShifts = [...shifts].sort((a, b) => a.day - b.day);
                
                const calculations = sortedShifts.map((shift, idx) => {
                    // Build per-shift params, using shift values or falling back to defaults
                    const shiftParams = {
                        commuteTime: Math.round((shift.commuteIn + shift.commuteOut) / 2) || defaults.commuteTime,
                        workload: shift.workload ?? defaults.workload,
                        attention: shift.attention ?? defaults.attention,
                        breakFrequency: shift.breakFrequency ?? defaults.breakFrequency,
                        breakLength: shift.breakLength ?? defaults.breakLength,
                        continuousWork: defaults.continuousWork,
                        breakAfterContinuous: defaults.breakAfterContinuous
                    };
                    
                    const calc = FatigueCalculator.calculateRiskIndex(shift, idx, sortedShifts, shiftParams);
                    return {
                        ...shift,
                        ...calc,
                        shiftParams,
                        riskLevel: FatigueCalculator.getRiskLevel(calc.riskIndex)
                    };
                });
                
                const riskIndices = calculations.map(c => c.riskIndex);
                const avgRisk = riskIndices.reduce((a, b) => a + b, 0) / riskIndices.length;
                const maxRisk = Math.max(...riskIndices);
                const minRisk = Math.min(...riskIndices);
                const totalHours = calculations.reduce((a, c) => a + c.dutyLength, 0);
                
                return {
                    calculations,
                    summary: {
                        avgRisk: Math.round(avgRisk * 100) / 100,
                        maxRisk: Math.round(maxRisk * 100) / 100,
                        minRisk: Math.round(minRisk * 100) / 100,
                        dutyCount: calculations.length,
                        totalHours: Math.round(totalHours * 10) / 10,
                        avgDutyLength: Math.round((totalHours / calculations.length) * 10) / 10,
                        highRiskCount: calculations.filter(c => c.riskIndex >= 1.1).length
                    }
                };
            }, [shifts, defaults]);
            
            const handleAddShift = () => {
                const lastDay = shifts.length > 0 ? Math.max(...shifts.map(s => s.day)) : 0;
                const newShift = createNewShift(lastDay + 1, "08:00", "17:00");
                setShifts([...shifts, newShift]);
            };
            
            const handleRemoveShift = (id) => {
                setShifts(shifts.filter(s => s.id !== id));
                if (expandedShift === id) setExpandedShift(null);
            };
            
            const handleUpdateShift = (id, field, value) => {
                setShifts(shifts.map(s => s.id === id ? { ...s, [field]: value } : s));
            };
            
            const handleLoadTemplate = (templateKey) => {
                const template = FATIGUE_TEMPLATES[templateKey];
                setShifts(template.shifts.map((s, i) => ({
                    ...createNewShift(s.day, s.startTime, s.endTime),
                    id: Date.now() + i
                })));
            };
            
            const handleClearAll = () => {
                setShifts([]);
                setExpandedShift(null);
            };
            
            const formatDuration = (hours) => {
                const h = Math.floor(hours);
                const m = Math.round((hours - h) * 60);
                return `${h}h ${m}m`;
            };
            
            const workloadLabels = ['Undemanding', 'Light', 'Moderate', 'Heavy'];
            const attentionLabels = ['Rarely', 'Sometimes', 'Mostly', 'Always'];
            
            return (
              <div className="fatigue-module" style={{ minHeight: '100vh' }}>
                {/* Header */}
                <div style={{ 
                    background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)', 
                    padding: '0.75rem 1.5rem',
                    borderBottom: '3px solid #f97316',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between'
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                        <button 
                            onClick={() => setCurrentView('dashboard')}
                            style={{
                                background: '#334155',
                                border: 'none',
                                color: 'white',
                                padding: '0.5rem 0.75rem',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.25rem',
                                fontSize: '0.8rem'
                            }}>
                            Ã¢â€ Â Back
                        </button>
                        <div style={{ color: 'white', fontWeight: 600, fontSize: '1.1rem' }}>
                            Fatigue <span style={{ color: '#f97316' }}>Risk Assessment</span>
                        </div>
                    </div>
                    <div style={{
                        background: '#334155',
                        color: '#f97316',
                        padding: '0.375rem 0.75rem',
                        borderRadius: '4px',
                        fontFamily: 'ui-monospace, monospace',
                        fontSize: '0.7rem',
                        fontWeight: 500
                    }}>
                        HSE RR446 COMPLIANT
                    </div>
                </div>
                
                {/* Main Content */}
                <div className="fatigue-grid">
                    {/* Left Panel - Pattern Input */}
                    <div className="fatigue-panel">
                        <div className="fatigue-panel-header">
                            <div className="fatigue-panel-title">
                                Ã°Å¸â€œâ€¹ Shift Pattern Definition
                            </div>
                            <button 
                                onClick={() => setShowDefaults(!showDefaults)}
                                style={{
                                    padding: '0.375rem 0.625rem',
                                    fontSize: '0.7rem',
                                    background: '#f1f5f9',
                                    border: '1px solid #e2e8f0',
                                    borderRadius: '4px',
                                    cursor: 'pointer'
                                }}>
                                Ã¢Å¡â„¢Ã¯Â¸Â Defaults
                            </button>
                        </div>
                        <div className="fatigue-panel-body">
                            {/* Defaults Panel */}
                            {showDefaults && (
                                <div className="fatigue-defaults-grid">
                                    <div>
                                        <div className="fatigue-defaults-section-title">Job Factors</div>
                                        <div className="fatigue-form-group">
                                            <label className="fatigue-form-label">Workload</label>
                                            <select className="fatigue-form-select" value={defaults.workload}
                                                onChange={(e) => setDefaults({...defaults, workload: Number(e.target.value)})}>
                                                <option value={0}>Undemanding</option>
                                                <option value={1}>Light</option>
                                                <option value={2}>Moderate</option>
                                                <option value={3}>Heavy</option>
                                            </select>
                                        </div>
                                        <div className="fatigue-form-group">
                                            <label className="fatigue-form-label">Attention Required</label>
                                            <select className="fatigue-form-select" value={defaults.attention}
                                                onChange={(e) => setDefaults({...defaults, attention: Number(e.target.value)})}>
                                                <option value={0}>Rarely</option>
                                                <option value={1}>Sometimes</option>
                                                <option value={2}>Mostly</option>
                                                <option value={3}>Always</option>
                                            </select>
                                        </div>
                                        <div className="fatigue-form-group" style={{ marginBottom: 0 }}>
                                            <label className="fatigue-form-label">Commute (mins)</label>
                                            <input type="number" className="fatigue-form-input" value={defaults.commuteTime}
                                                onChange={(e) => setDefaults({...defaults, commuteTime: Number(e.target.value)})} />
                                        </div>
                                    </div>
                                    <div>
                                        <div className="fatigue-defaults-section-title">Break Pattern</div>
                                        <div className="fatigue-form-group">
                                            <label className="fatigue-form-label">Break Frequency (mins)</label>
                                            <input type="number" className="fatigue-form-input" value={defaults.breakFrequency}
                                                onChange={(e) => setDefaults({...defaults, breakFrequency: Number(e.target.value)})} />
                                        </div>
                                        <div className="fatigue-form-group">
                                            <label className="fatigue-form-label">Avg Break Length (mins)</label>
                                            <input type="number" className="fatigue-form-input" value={defaults.breakLength}
                                                onChange={(e) => setDefaults({...defaults, breakLength: Number(e.target.value)})} />
                                        </div>
                                        <div className="fatigue-form-group" style={{ marginBottom: 0 }}>
                                            <label className="fatigue-form-label">Max Continuous (mins)</label>
                                            <input type="number" className="fatigue-form-input" value={defaults.continuousWork}
                                                onChange={(e) => setDefaults({...defaults, continuousWork: Number(e.target.value)})} />
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Templates */}
                            <div className="fatigue-form-group">
                                <label className="fatigue-form-label">Load Template</label>
                                <div className="fatigue-template-grid">
                                    {Object.entries(FATIGUE_TEMPLATES).map(([key, template]) => (
                                        <button key={key} className="fatigue-template-btn" onClick={() => handleLoadTemplate(key)}>
                                            {template.name}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Add Shift Button */}
                            <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.75rem' }}>
                                <button onClick={handleAddShift} style={{
                                    padding: '0.5rem 1rem', background: '#3b82f6', color: 'white',
                                    border: 'none', borderRadius: '6px', cursor: 'pointer', fontSize: '0.8rem', fontWeight: 500
                                }}>+ Add Shift</button>
                                <button onClick={handleClearAll} style={{
                                    padding: '0.5rem 1rem', background: '#f1f5f9', color: '#374151',
                                    border: '1px solid #e2e8f0', borderRadius: '6px', cursor: 'pointer', fontSize: '0.8rem'
                                }}>Clear All</button>
                            </div>
                            
                            {/* Inline Editable Shift Table */}
                            <div className="fatigue-form-group" style={{ marginBottom: 0 }}>
                                <label className="fatigue-form-label">Shift Pattern ({shifts.length} shifts)</label>
                                <div style={{ border: '1px solid #e2e8f0', borderRadius: '6px', overflow: 'hidden' }}>
                                    {shifts.length === 0 ? (
                                        <div className="fatigue-empty-state" style={{ padding: '2rem' }}>
                                            No shifts defined. Add shifts manually or load a template.
                                        </div>
                                    ) : (
                                        <div style={{ overflowX: 'auto' }}>
                                            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '0.7rem' }}>
                                                <thead>
                                                    <tr style={{ background: '#f8fafc' }}>
                                                        <th style={{ padding: '0.4rem 0.25rem', textAlign: 'center', fontWeight: 600, color: '#475569', borderBottom: '1px solid #e2e8f0', width: '36px' }}>Day</th>
                                                        <th style={{ padding: '0.4rem 0.25rem', textAlign: 'center', fontWeight: 600, color: '#475569', borderBottom: '1px solid #e2e8f0', width: '58px' }}>Start</th>
                                                        <th style={{ padding: '0.4rem 0.25rem', textAlign: 'center', fontWeight: 600, color: '#475569', borderBottom: '1px solid #e2e8f0', width: '58px' }}>End</th>
                                                        <th style={{ padding: '0.4rem 0.25rem', textAlign: 'center', fontWeight: 600, color: '#475569', borderBottom: '1px solid #e2e8f0', width: '42px' }} title="Commute to work (mins)">Ã°Å¸Å¡â€”Ã¢â€ â€™</th>
                                                        <th style={{ padding: '0.4rem 0.25rem', textAlign: 'center', fontWeight: 600, color: '#475569', borderBottom: '1px solid #e2e8f0', width: '42px' }} title="Commute from work (mins)">Ã¢â€ ÂÃ°Å¸Å¡â€”</th>
                                                        <th style={{ padding: '0.4rem 0.25rem', textAlign: 'center', fontWeight: 600, color: '#475569', borderBottom: '1px solid #e2e8f0', width: '58px' }} title="Physical workload">Work</th>
                                                        <th style={{ padding: '0.4rem 0.25rem', textAlign: 'center', fontWeight: 600, color: '#475569', borderBottom: '1px solid #e2e8f0', width: '58px' }} title="Attention required">Attn</th>
                                                        <th style={{ padding: '0.4rem 0.25rem', textAlign: 'center', fontWeight: 600, color: '#475569', borderBottom: '1px solid #e2e8f0', width: '42px' }} title="Break frequency (mins)">Brk</th>
                                                        <th style={{ padding: '0.4rem 0.25rem', textAlign: 'center', fontWeight: 600, color: '#475569', borderBottom: '1px solid #e2e8f0', width: '36px' }} title="Break length (mins)">Len</th>
                                                        <th style={{ padding: '0.4rem 0.25rem', textAlign: 'center', fontWeight: 600, color: '#64748b', borderBottom: '1px solid #e2e8f0', width: '38px' }}>Hrs</th>
                                                        <th style={{ padding: '0.4rem 0.25rem', borderBottom: '1px solid #e2e8f0', width: '24px' }}></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {[...shifts].sort((a, b) => a.day - b.day).map((shift, idx) => {
                                                        const startH = FatigueCalculator.parseTimeToHours(shift.startTime);
                                                        let endH = FatigueCalculator.parseTimeToHours(shift.endTime);
                                                        if (endH <= startH) endH += 24;
                                                        const duration = endH - startH;
                                                        
                                                        const cellStyle = { padding: '0.2rem' };
                                                        const inputStyle = { 
                                                            width: '100%', 
                                                            padding: '0.2rem 0.15rem', 
                                                            border: '1px solid transparent',
                                                            borderRadius: '3px',
                                                            fontSize: '0.7rem',
                                                            textAlign: 'center',
                                                            background: 'transparent'
                                                        };
                                                        
                                                        return (
                                                            <tr key={shift.id} style={{ borderBottom: idx < shifts.length - 1 ? '1px solid #f1f5f9' : 'none' }}>
                                                                <td style={cellStyle}>
                                                                    <input type="number" min="1" value={shift.day}
                                                                        onChange={(e) => handleUpdateShift(shift.id, 'day', Number(e.target.value))}
                                                                        style={{ ...inputStyle, fontWeight: 600 }}
                                                                        onFocus={(e) => e.target.style.border = '1px solid #3b82f6'}
                                                                        onBlur={(e) => e.target.style.border = '1px solid transparent'} />
                                                                </td>
                                                                <td style={cellStyle}>
                                                                    <input type="time" value={shift.startTime}
                                                                        onChange={(e) => handleUpdateShift(shift.id, 'startTime', e.target.value)}
                                                                        style={inputStyle}
                                                                        onFocus={(e) => e.target.style.border = '1px solid #3b82f6'}
                                                                        onBlur={(e) => e.target.style.border = '1px solid transparent'} />
                                                                </td>
                                                                <td style={cellStyle}>
                                                                    <input type="time" value={shift.endTime}
                                                                        onChange={(e) => handleUpdateShift(shift.id, 'endTime', e.target.value)}
                                                                        style={inputStyle}
                                                                        onFocus={(e) => e.target.style.border = '1px solid #3b82f6'}
                                                                        onBlur={(e) => e.target.style.border = '1px solid transparent'} />
                                                                </td>
                                                                <td style={cellStyle}>
                                                                    <input type="number" min="0" value={shift.commuteIn}
                                                                        onChange={(e) => handleUpdateShift(shift.id, 'commuteIn', Number(e.target.value))}
                                                                        style={{ ...inputStyle, background: shift.commuteIn !== defaults.commuteTime ? '#fef3c7' : 'transparent' }}
                                                                        onFocus={(e) => e.target.style.border = '1px solid #3b82f6'}
                                                                        onBlur={(e) => e.target.style.border = '1px solid transparent'} />
                                                                </td>
                                                                <td style={cellStyle}>
                                                                    <input type="number" min="0" value={shift.commuteOut}
                                                                        onChange={(e) => handleUpdateShift(shift.id, 'commuteOut', Number(e.target.value))}
                                                                        style={{ ...inputStyle, background: shift.commuteOut !== defaults.commuteTime ? '#fef3c7' : 'transparent' }}
                                                                        onFocus={(e) => e.target.style.border = '1px solid #3b82f6'}
                                                                        onBlur={(e) => e.target.style.border = '1px solid transparent'} />
                                                                </td>
                                                                <td style={cellStyle}>
                                                                    <select value={shift.workload}
                                                                        onChange={(e) => handleUpdateShift(shift.id, 'workload', Number(e.target.value))}
                                                                        style={{ ...inputStyle, background: shift.workload !== defaults.workload ? '#fef3c7' : 'transparent', cursor: 'pointer' }}>
                                                                        <option value={0}>Light</option>
                                                                        <option value={1}>Med</option>
                                                                        <option value={2}>Mod</option>
                                                                        <option value={3}>Heavy</option>
                                                                    </select>
                                                                </td>
                                                                <td style={cellStyle}>
                                                                    <select value={shift.attention}
                                                                        onChange={(e) => handleUpdateShift(shift.id, 'attention', Number(e.target.value))}
                                                                        style={{ ...inputStyle, background: shift.attention !== defaults.attention ? '#fef3c7' : 'transparent', cursor: 'pointer' }}>
                                                                        <option value={0}>Low</option>
                                                                        <option value={1}>Some</option>
                                                                        <option value={2}>Most</option>
                                                                        <option value={3}>High</option>
                                                                    </select>
                                                                </td>
                                                                <td style={cellStyle}>
                                                                    <input type="number" min="0" value={shift.breakFrequency}
                                                                        onChange={(e) => handleUpdateShift(shift.id, 'breakFrequency', Number(e.target.value))}
                                                                        style={{ ...inputStyle, background: shift.breakFrequency !== defaults.breakFrequency ? '#fef3c7' : 'transparent' }}
                                                                        onFocus={(e) => e.target.style.border = '1px solid #3b82f6'}
                                                                        onBlur={(e) => e.target.style.border = '1px solid transparent'} />
                                                                </td>
                                                                <td style={cellStyle}>
                                                                    <input type="number" min="0" value={shift.breakLength}
                                                                        onChange={(e) => handleUpdateShift(shift.id, 'breakLength', Number(e.target.value))}
                                                                        style={{ ...inputStyle, background: shift.breakLength !== defaults.breakLength ? '#fef3c7' : 'transparent' }}
                                                                        onFocus={(e) => e.target.style.border = '1px solid #3b82f6'}
                                                                        onBlur={(e) => e.target.style.border = '1px solid transparent'} />
                                                                </td>
                                                                <td style={{ ...cellStyle, textAlign: 'center', color: '#64748b', fontFamily: 'ui-monospace, monospace', fontSize: '0.65rem' }}>
                                                                    {duration.toFixed(1)}
                                                                </td>
                                                                <td style={{ ...cellStyle, textAlign: 'center' }}>
                                                                    <button 
                                                                        onClick={() => handleRemoveShift(shift.id)}
                                                                        style={{
                                                                            background: 'none', 
                                                                            border: 'none', 
                                                                            color: '#94a3b8', 
                                                                            cursor: 'pointer',
                                                                            padding: '0',
                                                                            fontSize: '0.75rem',
                                                                            lineHeight: 1
                                                                        }}
                                                                        title="Remove shift">Ã¢Å“â€¢</button>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                                {shifts.length > 0 && (
                                    <div style={{ fontSize: '0.6rem', color: '#94a3b8', marginTop: '0.25rem' }}>
                                        Ã°Å¸â€™Â¡ Yellow = custom value Ã¢â‚¬Â¢ Ã°Å¸Å¡â€”Ã¢â€ â€™ = commute in Ã¢â‚¬Â¢ Ã¢â€ ÂÃ°Å¸Å¡â€” = commute out
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    {/* Right Panel - Results */}
                    <div className="fatigue-panel">
                        <div className="fatigue-panel-header">
                            <div className="fatigue-panel-title">Ã°Å¸â€œÅ  Fatigue Risk Analysis</div>
                        </div>
                        <div className="fatigue-panel-body">
                            {!results ? (
                                <div className="fatigue-empty-state">
                                    <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>Ã°Å¸â€œË†</div>
                                    <div style={{ color: '#64748b' }}>Define a shift pattern to see the fatigue risk analysis</div>
                                </div>
                            ) : (
                                <>
                                    {/* Summary Cards */}
                                    <div className="fatigue-summary-cards">
                                        <div className="fatigue-summary-card">
                                            <div className={`fatigue-summary-value ${
                                                results.summary.avgRisk < 1 ? 'risk-color-low' :
                                                results.summary.avgRisk < 1.1 ? 'risk-color-moderate' :
                                                results.summary.avgRisk < 1.2 ? 'risk-color-high' : 'risk-color-critical'
                                            }`}>{results.summary.avgRisk.toFixed(2)}</div>
                                            <div className="fatigue-summary-label">Avg Risk Index</div>
                                        </div>
                                        <div className="fatigue-summary-card">
                                            <div className={`fatigue-summary-value ${
                                                results.summary.maxRisk < 1 ? 'risk-color-low' :
                                                results.summary.maxRisk < 1.1 ? 'risk-color-moderate' :
                                                results.summary.maxRisk < 1.2 ? 'risk-color-high' : 'risk-color-critical'
                                            }`}>{results.summary.maxRisk.toFixed(2)}</div>
                                            <div className="fatigue-summary-label">Peak Risk</div>
                                        </div>
                                        <div className="fatigue-summary-card">
                                            <div className="fatigue-summary-value" style={{ color: '#1e293b' }}>{results.summary.totalHours}h</div>
                                            <div className="fatigue-summary-label">Total Hours</div>
                                        </div>
                                        <div className="fatigue-summary-card">
                                            <div className="fatigue-summary-value" style={{ color: results.summary.highRiskCount > 0 ? '#f97316' : '#22c55e' }}>
                                                {results.summary.highRiskCount}
                                            </div>
                                            <div className="fatigue-summary-label">Elevated Shifts</div>
                                        </div>
                                    </div>
                                    
                                    {/* Warning */}
                                    {results.summary.maxRisk >= 1.1 && (
                                        <div className="fatigue-warning">
                                            Ã¢Å¡Â Ã¯Â¸Â This pattern has {results.summary.highRiskCount} shift(s) with elevated fatigue risk. Consider adjusting start times, duration, or rest periods.
                                        </div>
                                    )}
                                    
                                    {/* Risk Index Chart - CSS Based */}
                                    <div className="fatigue-chart-container">
                                        <div className="fatigue-chart-title">Risk Index by Duty</div>
                                        <div style={{ position: 'relative', height: '200px', padding: '0 10px' }}>
                                            {/* Reference lines */}
                                            <div style={{ position: 'absolute', left: '40px', right: '10px', bottom: `${((1.0 - 0.7) / 0.6) * 100}%`, borderTop: '2px dashed #22c55e', zIndex: 1 }}>
                                                <span style={{ position: 'absolute', left: '-38px', top: '-8px', fontSize: '10px', color: '#22c55e' }}>1.0</span>
                                            </div>
                                            <div style={{ position: 'absolute', left: '40px', right: '10px', bottom: `${((1.1 - 0.7) / 0.6) * 100}%`, borderTop: '2px dashed #f97316', zIndex: 1 }}>
                                                <span style={{ position: 'absolute', left: '-38px', top: '-8px', fontSize: '10px', color: '#f97316' }}>1.1</span>
                                            </div>
                                            {/* Y-axis labels */}
                                            <div style={{ position: 'absolute', left: '0', top: '0', bottom: '0', width: '35px', display: 'flex', flexDirection: 'column', justifyContent: 'space-between', fontSize: '10px', color: '#64748b' }}>
                                                <span>1.3</span>
                                                <span>1.0</span>
                                                <span>0.7</span>
                                            </div>
                                            {/* Bars */}
                                            <div style={{ position: 'absolute', left: '45px', right: '10px', bottom: '0', top: '0', display: 'flex', alignItems: 'flex-end', gap: '4px' }}>
                                                {results.calculations.map((calc, idx) => {
                                                    const heightPercent = Math.min(100, Math.max(0, ((calc.riskIndex - 0.7) / 0.6) * 100));
                                                    return (
                                                        <div key={idx} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                                                            <div style={{ 
                                                                width: '100%', 
                                                                maxWidth: '40px',
                                                                height: `${heightPercent}%`,
                                                                background: calc.riskLevel.color,
                                                                borderRadius: '4px 4px 0 0',
                                                                minHeight: '4px',
                                                                position: 'relative'
                                                            }}>
                                                                <span style={{ 
                                                                    position: 'absolute', 
                                                                    top: '-18px', 
                                                                    left: '50%', 
                                                                    transform: 'translateX(-50%)',
                                                                    fontSize: '9px',
                                                                    fontWeight: 600,
                                                                    color: calc.riskLevel.color
                                                                }}>{calc.riskIndex.toFixed(2)}</span>
                                                            </div>
                                                            <span style={{ fontSize: '9px', color: '#64748b', marginTop: '4px' }}>D{calc.day}</span>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                        <div style={{ display: 'flex', justifyContent: 'center', gap: '1rem', marginTop: '0.5rem', fontSize: '0.7rem' }}>
                                            <span><span style={{ display: 'inline-block', width: '12px', height: '12px', background: '#22c55e', borderRadius: '2px', marginRight: '4px' }}></span>Baseline (1.0)</span>
                                            <span><span style={{ display: 'inline-block', width: '12px', height: '12px', background: '#f97316', borderRadius: '2px', marginRight: '4px' }}></span>Elevated (1.1)</span>
                                        </div>
                                    </div>
                                    
                                    {/* Component Breakdown - CSS Based */}
                                    <div className="fatigue-chart-container">
                                        <div className="fatigue-chart-title">Component Breakdown</div>
                                        <div style={{ display: 'flex', gap: '1rem', marginBottom: '0.75rem', fontSize: '0.7rem' }}>
                                            <span><span style={{ display: 'inline-block', width: '12px', height: '3px', background: '#8b5cf6', marginRight: '4px' }}></span>Cumulative</span>
                                            <span><span style={{ display: 'inline-block', width: '12px', height: '3px', background: '#f59e0b', marginRight: '4px' }}></span>Timing</span>
                                            <span><span style={{ display: 'inline-block', width: '12px', height: '3px', background: '#10b981', marginRight: '4px' }}></span>Job/Breaks</span>
                                        </div>
                                        <div style={{ overflowX: 'auto' }}>
                                            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '0.75rem' }}>
                                                <thead>
                                                    <tr style={{ borderBottom: '2px solid #e2e8f0' }}>
                                                        <th style={{ padding: '0.5rem', textAlign: 'left', color: '#64748b' }}>Day</th>
                                                        <th style={{ padding: '0.5rem', textAlign: 'center', color: '#8b5cf6' }}>Cumulative</th>
                                                        <th style={{ padding: '0.5rem', textAlign: 'center', color: '#f59e0b' }}>Timing</th>
                                                        <th style={{ padding: '0.5rem', textAlign: 'center', color: '#10b981' }}>Job/Breaks</th>
                                                        <th style={{ padding: '0.5rem', textAlign: 'left' }}>Visual</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {results.calculations.map((calc, idx) => (
                                                        <tr key={idx} style={{ borderBottom: '1px solid #e2e8f0' }}>
                                                            <td style={{ padding: '0.5rem', fontFamily: 'ui-monospace, monospace' }}>Day {calc.day}</td>
                                                            <td style={{ padding: '0.5rem', textAlign: 'center', fontFamily: 'ui-monospace, monospace' }}>{calc.cumulative.toFixed(3)}</td>
                                                            <td style={{ padding: '0.5rem', textAlign: 'center', fontFamily: 'ui-monospace, monospace' }}>{calc.timing.toFixed(3)}</td>
                                                            <td style={{ padding: '0.5rem', textAlign: 'center', fontFamily: 'ui-monospace, monospace' }}>{calc.jobBreaks.toFixed(3)}</td>
                                                            <td style={{ padding: '0.5rem', width: '150px' }}>
                                                                <div style={{ display: 'flex', gap: '2px', height: '16px' }}>
                                                                    <div style={{ width: `${(calc.cumulative / 1.3) * 100}%`, background: '#8b5cf6', borderRadius: '2px' }} title={`Cumulative: ${calc.cumulative.toFixed(3)}`}></div>
                                                                    <div style={{ width: `${(calc.timing / 1.3) * 100}%`, background: '#f59e0b', borderRadius: '2px' }} title={`Timing: ${calc.timing.toFixed(3)}`}></div>
                                                                    <div style={{ width: `${(calc.jobBreaks / 1.3) * 100}%`, background: '#10b981', borderRadius: '2px' }} title={`Job/Breaks: ${calc.jobBreaks.toFixed(3)}`}></div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    {/* Data Table */}
                                    <div className="fatigue-chart-container" style={{ padding: 0 }}>
                                        <div style={{ padding: '0.75rem 1rem', borderBottom: '1px solid #e2e8f0' }}>
                                            <div className="fatigue-chart-title" style={{ margin: 0 }}>Detailed Analysis</div>
                                        </div>
                                        <div style={{ overflowX: 'auto' }}>
                                            <table className="fatigue-data-table">
                                                <thead>
                                                    <tr>
                                                        <th>Day</th>
                                                        <th>Start</th>
                                                        <th>End</th>
                                                        <th>Duration</th>
                                                        <th>Rest Before</th>
                                                        <th>Cumulative</th>
                                                        <th>Timing</th>
                                                        <th>Job/Breaks</th>
                                                        <th>Risk Index</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {results.calculations.map((calc, idx) => (
                                                        <tr key={idx}>
                                                            <td>{calc.day}</td>
                                                            <td>{calc.startTime}</td>
                                                            <td>{calc.endTime}</td>
                                                            <td>{formatDuration(calc.dutyLength)}</td>
                                                            <td>{calc.restBefore ? formatDuration(calc.restBefore) : 'Ã¢â‚¬â€'}</td>
                                                            <td>{calc.cumulative.toFixed(3)}</td>
                                                            <td>{calc.timing.toFixed(3)}</td>
                                                            <td>{calc.jobBreaks.toFixed(3)}</td>
                                                            <td style={{ fontWeight: 600, color: calc.riskLevel.color }}>{calc.riskIndex.toFixed(3)}</td>
                                                            <td><span className={`fatigue-risk-badge fatigue-risk-${calc.riskLevel.level}`}>{calc.riskLevel.label}</span></td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
              </div>
            );
          }

          // Planning View Container
          function PlanningViewContainer() {
            const project = projects.find(p => p.id === selectedProject);
            const projectShiftPatterns = shiftPatterns.filter(sp => sp.projectId === selectedProject);
            const projectAssignments = assignments.filter(a => a.projectId === selectedProject);
            
            // Scroll position management to prevent jump on drag & drop
            const scrollContainerRef = React.useRef(null);
            const savedScrollPosition = React.useRef(0);
            
            // Save scroll position before operations
            const saveScrollPosition = () => {
              if (scrollContainerRef.current) {
                savedScrollPosition.current = scrollContainerRef.current.scrollTop;
              }
            };
            
            // Restore scroll position after re-render
            React.useEffect(() => {
              if (scrollContainerRef.current && savedScrollPosition.current > 0) {
                scrollContainerRef.current.scrollTop = savedScrollPosition.current;
              }
            });
            
            if (!project) return null;
            
            const openAssignmentModal = (data) => {
              setAssignmentModalData(data);
              setShowAssignmentModal(true);
            };
            
            // Drag handlers - SIMPLIFIED
            // Employee selection handlers
            const handleEmployeeClick = (e, employee) => {
              // Require Ctrl key to be held to select/deselect employees
              if (!e.ctrlKey && !e.metaKey) {
                // No Ctrl/Cmd held - do nothing (prevents accidental selection)
                return;
              }
              
              if (e.shiftKey) {
                // Ctrl+Shift+click: Add to selection or remove if already selected
                if (selectedEmployees.some(emp => emp.id === employee.id)) {
                  setSelectedEmployees(selectedEmployees.filter(emp => emp.id !== employee.id));
                } else {
                  setSelectedEmployees([...selectedEmployees, employee]);
                }
              } else {
                // Ctrl+click: Toggle this employee's selection
                if (selectedEmployees.some(emp => emp.id === employee.id)) {
                  setSelectedEmployees(selectedEmployees.filter(emp => emp.id !== employee.id));
                } else {
                  setSelectedEmployees([...selectedEmployees, employee]);
                }
              }
            };
            
            const clearSelection = () => {
              setSelectedEmployees([]);
            };
            
            // Handle ESC key to clear selection
            React.useEffect(() => {
              const handleKeyDown = (e) => {
                if (e.key === 'Escape') {
                  clearSelection();
                }
              };
              window.addEventListener('keydown', handleKeyDown);
              return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);
            
            // Resize handlers
            const handleResizeStart = (e) => {
              setIsResizing(true);
              resizeStartY.current = e.clientY;
              resizeStartHeight.current = employeePanelHeight;
              e.preventDefault();
            };
            
            React.useEffect(() => {
              const handleResizeMove = (e) => {
                if (!isResizing) return;
                
                const deltaY = resizeStartY.current - e.clientY; // Inverted because panel grows upward
                const newHeight = Math.max(100, Math.min(window.innerHeight - 200, resizeStartHeight.current + deltaY));
                setEmployeePanelHeight(newHeight);
              };
              
              const handleResizeEnd = () => {
                setIsResizing(false);
                document.body.classList.remove('resizing');
              };
              
              if (isResizing) {
                document.body.classList.add('resizing');
                document.addEventListener('mousemove', handleResizeMove);
                document.addEventListener('mouseup', handleResizeEnd);
                return () => {
                  document.removeEventListener('mousemove', handleResizeMove);
                  document.removeEventListener('mouseup', handleResizeEnd);
                  document.body.classList.remove('resizing');
                };
              }
            }, [isResizing]);
            
            const handleEmployeeDragStart = (e, employee) => {
              console.log('Ã°Å¸Å½Â¯ Drag starting for employee:', employee.name);
              
              // Determine what to drag - if employee is in selection, drag all selected, otherwise just this one
              const employeesToDrag = selectedEmployees.some(emp => emp.id === employee.id) 
                ? selectedEmployees 
                : [employee];
              
              // Set the ref FIRST before any state updates
              draggedEmployeeRef.current = employeesToDrag;
              
              console.log('Ã¢Å“â€¦ Drag started:', draggedEmployeeRef.current.length, 'employee(s)', draggedEmployeeRef.current.map(e => e.name).join(', '));
              
              e.dataTransfer.effectAllowed = 'move';
              e.dataTransfer.setData('text/plain', employee.id); // Required for Firefox
              
              // No need to update selection state during drag - it can interfere with the drag operation
            };
            
            const handleEmployeeDragEnd = () => {
              console.log('Ã°Å¸â€ºâ€˜ Drag ended');
              // Don't clear ref here - let drop do it
              setDragOverCell(null);
            };
            
            const handleCellDragOver = (e, shiftPatternId, date) => {
              e.preventDefault(); // CRITICAL - without this, drop won't fire
              e.dataTransfer.dropEffect = 'move';
              // Removed logging here as it fires constantly and clutters console
              return false; // Extra safety for older browsers
            };
            
            const handleCellDrop = (e, shiftPatternId, date) => {
              e.preventDefault();
              e.stopPropagation();
              
              // Save scroll position to prevent jump after Firestore update
              saveScrollPosition();
              
              console.log('Ã°Å¸Å½Â¯ DROP EVENT FIRED on date:', date, 'shift pattern:', shiftPatternId);
              console.log('Ã°Å¸â€œÂ¦ draggedEmployeeRef.current:', draggedEmployeeRef.current);
              console.log('Ã°Å¸â€œÂ¦ draggedAssignmentsRef.current:', draggedAssignmentsRef.current);
              
              // Check if we're dropping date assignments (bulk copy)
              if (draggedAssignmentsRef.current && draggedAssignmentsRef.current.length > 0) {
                console.log('Ã°Å¸â€œâ€¦ Dropping', draggedAssignmentsRef.current.length, 'date assignments to:', date);
                
                const newAssignments = draggedAssignmentsRef.current.map(assignment => ({
                  employeeId: assignment.employeeId,
                  projectId: assignment.projectId,
                  shiftPatternId: assignment.shiftPatternId,
                  date: date // New date
                }));
                
                // Save to Firestore
                (async () => {
                  try {
                    const batch = db.batch();
                    let maxId = Math.max(...assignments.map(a => a.id), 0);
                    
                    newAssignments.forEach((assignment) => {
                      maxId++;
                      const assignmentWithId = { ...assignment, id: maxId };
                      const docRef = db.collection('assignments').doc(String(maxId));
                      batch.set(docRef, assignmentWithId);
                    });
                    
                    await batch.commit();
                    console.log('Ã¢Å“â€¦', newAssignments.length, 'assignments copied to new date and saved to Firestore!');
                  } catch (error) {
                    console.error('Ã¢ÂÅ’ Error copying assignments:', error);
                    alert('Failed to copy assignments. Please try again.');
                  }
                })();
                
                // Clear date selection
                setSelectedDateAssignments(null);
                draggedAssignmentsRef.current = null;
                setDragOverCell(null);
                return false;
              }
              
              // Otherwise handle employee drop as before
              const employeesToAssign = draggedEmployeeRef.current;
              console.log('Ã°Å¸â€˜Â¥ Employees to assign:', employeesToAssign?.length || 0);
              if (employeesToAssign) {
                console.log('   Names:', employeesToAssign.map(e => e.name).join(', '));
              }
              
              if (employeesToAssign && employeesToAssign.length > 0) {
                // If no shift pattern specified (Gantt view), use the first day shift as default
                let targetShiftPattern = shiftPatternId;
                if (!targetShiftPattern) {
                  const dayShift = projectShiftPatterns.find(p => !p.isNight);
                  targetShiftPattern = dayShift ? dayShift.id : projectShiftPatterns[0]?.id;
                  console.log('Ã¢Å¡Â Ã¯Â¸Â No shift specified, using default:', targetShiftPattern);
                }
                
                if (targetShiftPattern) {
                  console.log('Ã°Å¸â€Â VALIDATION START:', {
                    targetShiftPattern,
                    date,
                    totalShiftPatterns: shiftPatterns.length,
                    shiftPatternIds: shiftPatterns.map(p => `${p.id}: ${p.name}`)
                  });
                  
                  const pattern = shiftPatterns.find(p => p.id === targetShiftPattern);
                  console.log('Ã°Å¸â€Â Pattern found:', pattern ? `${pattern.name} (id: ${pattern.id})` : 'NULL - PATTERN NOT FOUND!');
                  
                  if (pattern) {
                    console.log('Ã°Å¸â€Â Pattern details:', {
                      name: pattern.name,
                      isCustom: pattern.isCustom,
                      hasWeeklySchedule: !!pattern.weeklySchedule,
                      weeklySchedule: pattern.weeklySchedule
                    });
                    
                    let hasHours = false;
                    try {
                      hasHours = shiftPatternHasHoursForDay(pattern, date);
                      console.log('Ã°Å¸â€Â Validation result - hasHours:', hasHours);
                    } catch (error) {
                      console.error('Ã¢ÂÅ’ ERROR in shiftPatternHasHoursForDay:', error);
                      alert('Error checking shift pattern. See console for details.');
                      draggedEmployeeRef.current = null;
                      setDragOverCell(null);
                      return false;
                    }
                    
                    if (!hasHours) {
                      console.log('Ã¢ÂÅ’ VALIDATION FAILED - No hours for this day!');
                      
                      try {
                        // Get alternative valid shift patterns
                        const validPatterns = getValidShiftPatternsForDay(shiftPatterns, project.id, date);
                        console.log('Ã°Å¸â€Â Valid alternatives:', validPatterns.map(p => p.name));
                        
                        // Validate data before setting state
                        if (!employeesToAssign || employeesToAssign.length === 0) {
                          console.error('Ã¢ÂÅ’ No employees to assign!');
                          alert('Error: No employees selected');
                          draggedEmployeeRef.current = null;
                          setDragOverCell(null);
                          return false;
                        }
                        
                        console.log('Ã°Å¸â€œÂ¢ Preparing modal data...');
                        const modalData = {
                          employees: employeesToAssign,
                          date: date,
                          projectId: project.id,
                          attemptedPattern: pattern,
                          validPatterns: validPatterns
                        };
                        console.log('Ã°Å¸â€œÂ¢ Modal data prepared:', modalData);
                        
                        // Set state
                        console.log('Ã°Å¸â€œÂ¢ Setting noRosterModalData state...');
                        setNoRosterModalData(modalData);
                        
                        console.log('Ã°Å¸â€œÂ¢ Setting showNoRosterModal to TRUE...');
                        setShowNoRosterModal(true);
                        
                        console.log('Ã¢Å“â€¦ Modal state set successfully');
                        
                        draggedEmployeeRef.current = null;
                        setDragOverCell(null);
                        return false;
                      } catch (error) {
                        console.error('Ã¢ÂÅ’ ERROR preparing/showing modal:', error);
                        console.error('Error stack:', error.stack);
                        alert('Error showing validation modal: ' + error.message);
                        draggedEmployeeRef.current = null;
                        setDragOverCell(null);
                        return false;
                      }
                    } else {
                      console.log('Ã¢Å“â€¦ VALIDATION PASSED - Pattern has hours for this day');
                    }
                  }
                  
                  console.log('Ã°Å¸â€œÂ Creating assignments for', employeesToAssign.length, 'employee(s)...');
                  
                  // Create all assignments at once, checking for duplicates
                  const newAssignments = [];
                  const skippedEmployees = [];
                  
                  employeesToAssign.forEach(employee => {
                    // Check if this employee is already assigned to this shift pattern on this date
                    const existingAssignment = assignments.find(a => 
                      a.employeeId === employee.id && 
                      a.date === date && 
                      a.shiftPatternId === targetShiftPattern
                    );
                    
                    if (existingAssignment) {
                      console.log('Ã¢Å¡Â Ã¯Â¸Â Skipping duplicate:', employee.name, 'already assigned to this shift on this date');
                      skippedEmployees.push(employee.name);
                    } else {
                      newAssignments.push({
                        id: Date.now() + Math.random(),
                        employeeId: employee.id,
                        projectId: project.id,
                        shiftPatternId: targetShiftPattern,
                        date: date
                      });
                    }
                  });
                  
                  if (skippedEmployees.length > 0) {
                    alert(`${skippedEmployees.join(', ')} ${skippedEmployees.length === 1 ? 'is' : 'are'} already assigned to this shift on this date.`);
                  }
                  
                  if (newAssignments.length > 0) {
                    console.log('Ã°Å¸â€™Â¾ Adding', newAssignments.length, 'new assignments:', newAssignments);
                    
                    // Save to Firestore
                    (async () => {
                      try {
                        const batch = db.batch();
                        let maxId = Math.max(...assignments.map(a => a.id), 0);
                        
                        newAssignments.forEach((assignment) => {
                          maxId++;
                          const assignmentWithId = { ...assignment, id: maxId };
                          const docRef = db.collection('assignments').doc(String(maxId));
                          batch.set(docRef, assignmentWithId);
                        });
                        
                        await batch.commit();
                        console.log('Ã¢Å“â€¦', newAssignments.length, 'assignments added successfully and saved to Firestore!');
                      } catch (error) {
                        console.error('Ã¢ÂÅ’ Error saving assignments:', error);
                        alert('Failed to save assignments. Please try again.');
                      }
                    })();
                  } else {
                    console.log('Ã¢â€žÂ¹Ã¯Â¸Â No new assignments created - all were duplicates');
                  }
                  
                  // Clear selection after successful drop
                  clearSelection();
                } else {
                  console.error('Ã¢ÂÅ’ ERROR: No shift patterns available!');
                  alert('Error: No shift patterns available for this project.');
                }
              } else {
                console.error('Ã¢ÂÅ’ ERROR: No draggedEmployee in ref! This should not happen.');
                alert('Error: Drag operation failed. Please try again.');
              }
              
              // Clear state
              draggedEmployeeRef.current = null;
              setDragOverCell(null);
              return false;
            };
            
            // Handle Ctrl+click on a date to select all assignments for that date
            const handleDateClick = (e, date) => {
              console.log('Ã°Å¸â€“Â±Ã¯Â¸Â Date clicked:', date, 'Ctrl pressed:', e.ctrlKey, 'Meta pressed:', e.metaKey);
              
              if (!e.ctrlKey && !e.metaKey) {
                console.log('Ã¢Å¡Â Ã¯Â¸Â Not a Ctrl/Cmd click, ignoring');
                return; // Only on Ctrl/Cmd click
              }
              
              e.preventDefault();
              e.stopPropagation();
              
              // Toggle selection - if already selected, deselect
              if (selectedDateAssignments?.date === date) {
                console.log('Ã°Å¸â€â€ž Deselecting date:', date);
                setSelectedDateAssignments(null);
                return;
              }
              
              // Get all assignments for this date in the current project
              const dateAssignments = projectAssignments.filter(a => a.date === date);
              console.log('Ã°Å¸â€œÅ  Found', dateAssignments.length, 'assignments for date:', date);
              
              if (dateAssignments.length > 0) {
                console.log('Ã¢Å“â€¦ Selected', dateAssignments.length, 'assignments for date:', date);
                setSelectedDateAssignments({ date, assignments: dateAssignments });
                setSelectedEmployees([]); // Clear employee selection
                alert(`Selected ${dateAssignments.length} assignments for ${new Date(date).toLocaleDateString('en-GB')}. Now drag this date column to copy to another date.`);
              } else {
                console.log('Ã¢Å¡Â Ã¯Â¸Â No assignments found for this date');
                alert('No assignments found for this date.');
              }
            };
            
            // Handle drag start for date assignments
            const handleDateDragStart = (e) => {
              if (!selectedDateAssignments) return;
              
              draggedAssignmentsRef.current = selectedDateAssignments.assignments;
              console.log('Ã¢Å“â€¦ Date drag started:', draggedAssignmentsRef.current.length, 'assignment(s)');
              e.dataTransfer.effectAllowed = 'copy';
              e.dataTransfer.setData('text/plain', 'date-assignments');
            };
            
            const handleDateDragEnd = () => {
              console.log('Ã°Å¸â€ºâ€˜ Date drag ended');
              setDragOverCell(null);
            };
            
            // Filter employees for search
            const filteredEmployees = employees.filter(emp => 
              emp.name.toLowerCase().includes(employeeSearchTerm.toLowerCase()) ||
              emp.role.toLowerCase().includes(employeeSearchTerm.toLowerCase())
            );
            
            return (
              <div style={{ 
                height: '100vh', 
                display: 'flex', 
                flexDirection: 'column', 
                overflow: 'hidden',
                margin: 0,
                padding: 0,
                background: '#f1f5f9'
              }}>
                {/* Header - Sleek Dark Style */}
                <div style={{ 
                    background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)', 
                    padding: '0.75rem 1.5rem',
                    borderBottom: '3px solid #3b82f6',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    flexShrink: 0
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                        <button 
                            onClick={() => setCurrentView('dashboard')}
                            style={{
                                background: '#334155',
                                border: 'none',
                                color: 'white',
                                padding: '0.5rem 0.75rem',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.25rem',
                                fontSize: '0.8rem'
                            }}>
                            Ã¢â€ Â Back
                        </button>
                        <div style={{ color: 'white', fontWeight: 600, fontSize: '1.1rem' }}>
                            {project.name} <span style={{ color: '#3b82f6' }}>Planning</span>
                        </div>
                        <span style={{ color: '#64748b', fontSize: '0.75rem' }}>{project.location} Ã¢â‚¬Â¢ {project.type}</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                        {/* View Switcher */}
                        <div style={{ display: 'flex', gap: '0.25rem', background: '#334155', padding: '0.25rem', borderRadius: '6px' }}>
                            <button 
                                onClick={() => setCurrentView('planning')}
                                style={{
                                    padding: '0.375rem 0.625rem',
                                    fontSize: '0.75rem',
                                    background: currentView === 'planning' ? '#3b82f6' : 'transparent',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer'
                                }}>
                                Planning
                            </button>
                            <button 
                                onClick={() => setCurrentView('summary')}
                                style={{
                                    padding: '0.375rem 0.625rem',
                                    fontSize: '0.75rem',
                                    background: currentView === 'summary' ? '#3b82f6' : 'transparent',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer'
                                }}>
                                Summary
                            </button>
                            <button 
                                onClick={() => {
                                    const assignedEmployeeIds = [...new Set(projectAssignments.map(a => a.employeeId))];
                                    if (assignedEmployeeIds.length > 0) {
                                        setSelectedEmployee(assignedEmployeeIds[0]);
                                        setCurrentView('person');
                                    } else {
                                        alert('No employees assigned to this project yet.');
                                    }
                                }}
                                style={{
                                    padding: '0.375rem 0.625rem',
                                    fontSize: '0.75rem',
                                    background: currentView === 'person' ? '#3b82f6' : 'transparent',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer'
                                }}>
                                Person
                            </button>
                        </div>
                        <div style={{
                            background: '#334155',
                            color: '#3b82f6',
                            padding: '0.375rem 0.75rem',
                            borderRadius: '4px',
                            fontFamily: 'ui-monospace, monospace',
                            fontSize: '0.7rem',
                            fontWeight: 500
                        }}>
                            PLANNING VIEW
                        </div>
                        <SignOutHeader user={user} onSignOut={onSignOut} />
                    </div>
                </div>
                
                {/* Roster Panel - fills remaining space using flex */}
                <div 
                  ref={scrollContainerRef} 
                  style={{ 
                    flex: '1 1 auto',
                    minHeight: 0,
                    overflowY: 'auto',
                    overflowX: 'auto',
                    backgroundColor: '#f9fafb',
                    padding: '16px'
                  }}>

              {/* ROW 2 Ã¢â‚¬â€œ Controls bar */}
              <div className="mb-3">
                <div className="flex flex-wrap items-center gap-3 bg-white shadow-sm border border-gray-200 rounded-md px-3 py-2">
                  {/* View mode pills */}
                  <div className="flex items-center gap-1">
                    <button 
                      onClick={() => setPlanningViewMode('timeline')}
                      className={`px-3 py-1.5 rounded text-sm ${
                        planningViewMode === 'timeline'
                          ? 'bg-blue-600 text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}>
                      Timeline
                    </button>
                    <button 
                      onClick={() => setPlanningViewMode('gantt')}
                      className={`px-3 py-1.5 rounded text-sm ${
                        planningViewMode === 'gantt'
                          ? 'bg-blue-600 text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}>
                      Gantt
                    </button>
                    <button 
                      onClick={() => setPlanningViewMode('weekly')}
                      className={`px-3 py-1.5 rounded text-sm ${
                        planningViewMode === 'weekly'
                          ? 'bg-blue-600 text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}>
                      Weekly Grid
                    </button>
                  </div>

                  {/* Year & Period */}
                  <div className="flex flex-wrap items-center gap-2 ml-2">
                    <select
                      value={selectedYear}
                      onChange={(e) => {
                        setSelectedYear(Number(e.target.value));
                        setSelectedPeriod(null);
                      }}
                      className="border border-gray-300 rounded-md px-2 py-1.5 text-sm min-w-[110px]">
                      {NETWORK_RAIL_YEARS.map(year => (
                        <option key={year} value={year}>
                          {year}/{year + 1}
                        </option>
                      ))}
                    </select>
                    <select
                      value={selectedPeriod || ''}
                      onChange={(e) => setSelectedPeriod(e.target.value)}
                      className="border border-gray-300 rounded-md px-2 py-1.5 text-sm min-w-[220px]">
                      {networkRailPeriods.map(period => (
                        <option key={period.id} value={period.id}>
                          {period.name}
                        </option>
                      ))}
                    </select>
                  </div>

                  <div className="flex-1" />

                  {/* Export / Import */}
                  <div className="flex items-center gap-2">
                    <button 
                      onClick={() => setShowExportModal(true)}
                      className="px-3 py-1.5 rounded text-sm bg-green-600 text-white hover:bg-green-700 flex items-center gap-1">
                      <Download className="w-4 h-4" />
                      Export Template
                    </button>
                    <button
                      onClick={() => setShowImportModal(true)}
                      className="px-3 py-1.5 rounded text-sm bg-purple-600 text-white hover:bg-purple-700 flex items-center gap-1">
                      <Upload className="w-4 h-4" />
                      Import Shifts
                    </button>
                  </div>
                </div>
              </div>

              {/* Views - still inside scroll container */}
              {planningViewMode === 'timeline' && <TimelineView project={project} shiftPatterns={projectShiftPatterns} projectAssignments={projectAssignments} openModal={openAssignmentModal} handleCellDragOver={handleCellDragOver} handleCellDrop={handleCellDrop} handleDateClick={handleDateClick} handleDateDragStart={handleDateDragStart} handleDateDragEnd={handleDateDragEnd} />}
              {planningViewMode === 'gantt' && <GanttView project={project} shiftPatterns={projectShiftPatterns} projectAssignments={projectAssignments} openModal={openAssignmentModal} handleCellDragOver={handleCellDragOver} handleCellDrop={handleCellDrop} handleDateClick={handleDateClick} handleDateDragStart={handleDateDragStart} handleDateDragEnd={handleDateDragEnd} />}
              {planningViewMode === 'weekly' && <WeeklyView project={project} shiftPatterns={projectShiftPatterns} projectAssignments={projectAssignments} openModal={openAssignmentModal} handleCellDragOver={handleCellDragOver} handleCellDrop={handleCellDrop} handleDateClick={handleDateClick} handleDateDragStart={handleDateDragStart} handleDateDragEnd={handleDateDragEnd} />}
                </div>
                
                {/* Draggable Divider */}
                <div 
                  onMouseDown={handleResizeStart}
                  style={{ 
                    height: '8px', 
                    cursor: 'row-resize',
                    backgroundColor: isResizing ? '#3b82f6' : '#d1d5db',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    flexShrink: 0,
                    flexGrow: 0
                  }}>
                  <div style={{ width: '60px', height: '4px', backgroundColor: '#6b7280', borderRadius: '2px' }}></div>
                </div>
                
                {/* Employee Panel - fixed height at bottom */}
                <div 
                  style={{ 
                    height: `${employeePanelHeight}px`,
                    overflowY: 'auto',
                    overflowX: 'hidden',
                    flexShrink: 0,
                    flexGrow: 0,
                    backgroundColor: '#ffffff',
                    padding: '16px',
                    borderTop: '1px solid #e5e7eb'
                  }}>
                  <div className="mb-2 flex items-center justify-between">
                    <h3 className="text-sm font-semibold text-gray-700">Employees</h3>
                    <p className="text-xs text-gray-500">
                      Ã°Å¸â€™Â¡ Ctrl+click to select Ã¢â‚¬Â¢ Drag to assign
                    </p>
                  </div>
                  <div className="mb-2 flex items-center gap-2">
                    <input
                      type="text"
                      placeholder="Search employees by name or role..."
                      value={employeeSearchTerm}
                      onChange={(e) => setEmployeeSearchTerm(e.target.value)}
                      className="flex-1 border rounded-md px-3 py-2"
                    />
                    {selectedEmployees.length > 0 && (
                      <div className="flex items-center gap-2">
                        <span className="text-sm font-medium text-blue-600">
                          {selectedEmployees.length} selected
                        </span>
                        <button
                          onClick={clearSelection}
                          className="px-3 py-2 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                          Clear
                        </button>
                      </div>
                    )}
                  </div>
                  <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-2">
                      {filteredEmployees.map(employee => {
                        const compliance = getEmployeeComplianceStatus(employee.id, assignments, shiftPatterns);
                        const isSelected = selectedEmployees.some(emp => emp.id === employee.id);
                        const isDragging = Array.isArray(draggedEmployeeRef.current) 
                          ? draggedEmployeeRef.current.some(emp => emp.id === employee.id)
                          : draggedEmployeeRef.current?.id === employee.id;
                        
                        return (
                            <div
                              key={employee.id}
                              draggable
                              onClick={(e) => handleEmployeeClick(e, employee)}
                              onDragStart={(e) => handleEmployeeDragStart(e, employee)}
                              onDragEnd={handleEmployeeDragEnd}
                              className={`employee-draggable p-2 rounded border transition-all cursor-pointer relative ${
                                isDragging ? 'dragging' : ''
                              } ${
                                isSelected 
                                  ? 'bg-blue-100 border-blue-500 ring-2 ring-blue-300' 
                                  : 'bg-gray-50 border-gray-200 hover:bg-blue-50 hover:border-blue-300'
                              }`}>
                              {isSelected && selectedEmployees.length > 1 && selectedEmployees[0].id === employee.id && (
                                <div className="multi-drag-badge">{selectedEmployees.length}</div>
                              )}
                              <div className="flex items-start gap-1">
                                <GripVertical className="w-3 h-3 text-gray-400 flex-shrink-0 mt-1" />
                                <div className="flex-1 min-w-0">
                                  <div className="flex items-center justify-between gap-1">
                                    <p className="text-xs font-medium truncate">{employee.name}</p>
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        setSelectedEmployee(employee.id);
                                        setCurrentView('person');
                                      }}
                                      className="hover:scale-110 transition-transform"
                                      title="View employee timeline">
                                      {compliance.status === 'error' ? (
                                        <ErrorTriangle className="w-3 h-3 text-red-500 flex-shrink-0" />
                                      ) : compliance.status === 'warning' ? (
                                        <AlertTriangle className="w-3 h-3 text-amber-500 flex-shrink-0" />
                                      ) : (
                                        <CheckCircle className="w-3 h-3 text-green-500 flex-shrink-0" />
                                      )}
                                    </button>
                                  </div>
                                  <p className="text-[10px] text-gray-600 truncate">{employee.role}</p>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                    </div>
                </div>
              </div>
            );
          }

          // Timeline View
          function TimelineView({ project, shiftPatterns: projectShiftPatterns, projectAssignments, openModal, handleCellDragOver, handleCellDrop, handleDateClick, handleDateDragStart, handleDateDragEnd }) {
            // Use selected period if available, otherwise use project start date
            const period = networkRailPeriods.find(p => p.id === selectedPeriod);
            const startDate = period ? new Date(period.startDate) : new Date(project.startDate);
            const dates = [];
            for (let i = 0; i < 28; i++) {
              const date = new Date(startDate);
              date.setDate(date.getDate() + i);
              dates.push(date.toISOString().split('T')[0]);
            }
            
            return (
              <div className="bg-white rounded-lg shadow-md overflow-x-auto">
                <div className="min-w-max">
                  <div className="grid grid-cols-[200px_repeat(28,120px)] border-b">
                    <div className="p-3 font-semibold bg-gray-50 sticky left-0 z-10">Shift Pattern</div>
                    {dates.map((date, idx) => {
                      const d = new Date(date);
                      const isSelectedDate = selectedDateAssignments?.date === date;
                      const dateAssignmentsCount = projectAssignments.filter(a => a.date === date).length;
                      
                      return (
                        <div 
                          key={idx} 
                          draggable={isSelectedDate}
                          onDragStart={isSelectedDate ? handleDateDragStart : undefined}
                          onDragEnd={isSelectedDate ? handleDateDragEnd : undefined}
                          onClick={(e) => handleDateClick(e, date)}
                          className={`p-2 text-center text-xs border-l transition-all ${
                            isSelectedDate 
                              ? 'bg-blue-200 border-blue-500 ring-2 ring-blue-300 cursor-grab' 
                              : 'bg-gray-50 hover:bg-blue-50 cursor-pointer'
                          }`}
                          title={isSelectedDate ? `${dateAssignmentsCount} assignments selected. Drag to copy to another date.` : 'Ctrl+click to select all assignments for this date'}>
                          <div className="font-semibold">{d.toLocaleDateString('en-GB', { weekday: 'short' })}</div>
                          <div>{d.getDate()}/{d.getMonth() + 1}</div>
                          {isSelectedDate && (
                            <div className="mt-1 text-[10px] font-bold text-blue-700">
                              {dateAssignmentsCount} selected
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                  
                  {projectShiftPatterns.map(pattern => {
                    const patternAssignments = projectAssignments.filter(a => a.shiftPatternId === pattern.id);
                    
                    return (
                      <div key={pattern.id} className="grid grid-cols-[200px_repeat(28,120px)] border-b border-gray-200 hover:bg-gray-50">
                        <div className="p-3 sticky left-0 bg-white border-r">
                          <div className="font-semibold text-sm">{pattern.name}</div>
                          <div className="text-xs text-gray-600">{pattern.startTime}-{pattern.endTime}</div>
                          <div className="text-xs text-gray-500">{pattern.dutyType}</div>
                        </div>
                        {dates.map((date, idx) => {
                          const dateAssignments = patternAssignments.filter(a => a.date === date);
                          const isDragOver = dragOverCell?.shiftPatternId === pattern.id && dragOverCell?.date === date;
                          const isSelectedDate = selectedDateAssignments?.date === date;
                          const isPartOfPattern = shiftPatternHasHoursForDay(pattern, date);
                          
                          // Check if this cell is in drag range AND matches the shift pattern being dragged
                          let isDragTarget = false;
                          if (tileDragging && selectedTiles.length > 0) {
                            const startDate = new Date(tileDragging.startDate);
                            const cellDate = new Date(date);
                            const daysDiff = Math.round((cellDate - startDate) / (1000 * 60 * 60 * 24));
                            
                            // Only highlight if this pattern matches one of the selected tiles' patterns
                            const hasMatchingPattern = selectedTiles.some(t => t.shiftPatternId === pattern.id);
                            
                            isDragTarget = hasMatchingPattern && daysDiff > 0 && daysDiff <= (tileDragging.daysForward || 0);
                          }
                          
                          return (
                            <div 
                              key={idx} 
                              className={`border-l p-1 cursor-pointer min-h-[60px] relative transition-colors ${
                                isDragTarget ? 'bg-blue-100 border-2 border-blue-500' :
                                isDragOver ? 'drag-over' : 
                                isSelectedDate ? 'bg-blue-50 border-blue-200' :
                                !isPartOfPattern ? 'non-pattern-day' :
                                'hover:bg-blue-50'
                              }`}
                              onClick={() => openModal({ projectId: project.id, shiftPatternId: pattern.id, date })}
                              onDragOver={(e) => handleCellDragOver(e, pattern.id, date)}
                              onDrop={(e) => handleCellDrop(e, pattern.id, date)}
                              title={!isPartOfPattern ? 'Not part of shift pattern - will use Custom Roster if assigned' : ''}>
                              {isDragTarget && (
                                <div className="text-[10px] font-semibold text-blue-600 text-center bg-blue-100 py-0.5">
                                  Ã¢Å¾Å“ Will copy here
                                </div>
                              )}
                              <div className={isDragTarget ? 'pt-1' : ''}>
                              {dateAssignments
                                .map(assignment => ({
                                  ...assignment,
                                  employeeName: employees.find(e => e.id === assignment.employeeId)?.name || ''
                                }))
                                .sort((a, b) => a.employeeName.localeCompare(b.employeeName))
                                .map((assignment, aIdx) => {
                                const employee = employees.find(e => e.id === assignment.employeeId);
                                const compliance = getEmployeeComplianceStatus(assignment.employeeId, assignments, shiftPatterns);
                                const isSelectedTile = selectedTiles.some(t => t.assignmentId === assignment.id);
                                
                                return (
                                  <div 
                                    key={aIdx}
                                    className={`text-[10px] px-1 py-0.5 mb-1 rounded flex items-center justify-between gap-1 group transition-all ${
                                      isSelectedTile ? (
                                        compliance.status === 'error' ? 'bg-red-200 text-red-900 border-2 border-red-700 font-bold shadow-lg' :
                                        compliance.status === 'warning' ? 'bg-amber-200 text-amber-900 border-2 border-amber-700 font-bold shadow-lg' :
                                        'bg-green-200 text-green-900 border-2 border-green-700 font-bold shadow-lg'
                                      ) : (
                                        compliance.status === 'error' ? 'bg-red-100 text-red-800 border border-red-300' :
                                        compliance.status === 'warning' ? 'bg-amber-100 text-amber-800 border border-amber-300' :
                                        'bg-green-100 text-green-800 border border-green-300'
                                      )
                                    }`}
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      if (!e.shiftKey) {
                                        handleTileClick(e, assignment.employeeId, date, assignment.id, pattern.id);
                                      }
                                    }}
                                    onMouseDown={(e) => {
                                      e.stopPropagation();
                                      if (!e.shiftKey) {
                                        handleTileCtrlDragStart(e, assignment.employeeId, date, assignment.id, pattern.id);
                                      }
                                    }}
                                    style={{ cursor: tileDragging ? 'grabbing' : (isSelectedTile ? 'grab' : 'pointer'), userSelect: 'none' }}
                                    title={employee?.name}>
                                    {isSelectedTile && (
                                      <span className="flex-shrink-0 font-bold mr-1">Ã¢Å“â€œ</span>
                                    )}
                                    <span 
                                      className="truncate flex-1 cursor-pointer hover:underline"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        if (e.shiftKey) {
                                          // Shift+click: Toggle employee selection
                                          if (selectedEmployees.some(emp => emp.id === employee.id)) {
                                            setSelectedEmployees(selectedEmployees.filter(emp => emp.id !== employee.id));
                                          } else {
                                            setSelectedEmployees([...selectedEmployees, employee]);
                                          }
                                        } else {
                                          // Regular click: Navigate to Person View
                                          setSelectedEmployee(employee.id);
                                          setCurrentView('person');
                                        }
                                      }}>
                                      {employee?.name}
                                    </span>
                                    <div className="flex gap-0.5">
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          openModal({ 
                                            projectId: assignment.projectId, 
                                            assignmentId: assignment.id,
                                            employeeId: assignment.employeeId,
                                            date: assignment.date 
                                          });
                                        }}
                                        className="opacity-0 group-hover:opacity-100 hover:bg-blue-200 rounded p-0.5 transition-opacity flex-shrink-0"
                                        title="Edit shift">
                                        <Edit2 className="w-3 h-3" />
                                      </button>
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          if (confirm(`Remove ${employee?.name} from this shift?`)) {
                                            deleteAssignment(assignment.id);
                                          }
                                        }}
                                        className="opacity-0 group-hover:opacity-100 hover:bg-red-200 rounded p-0.5 transition-opacity flex-shrink-0"
                                        title="Remove shift">
                                        <Trash2 className="w-3 h-3" />
                                      </button>
                                    </div>
                                  </div>
                                );
                              })}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          }

          // Gantt View
          function GanttView({ project, shiftPatterns: projectShiftPatterns, projectAssignments, openModal, handleCellDragOver, handleCellDrop, handleDateClick, handleDateDragStart, handleDateDragEnd }) {
            const assignedEmployeeIds = [...new Set(projectAssignments.map(a => a.employeeId))];
            const assignedEmployees = employees.filter(e => assignedEmployeeIds.includes(e.id));
            
            // Use selected period if available, otherwise use project start date
            const period = networkRailPeriods.find(p => p.id === selectedPeriod);
            const startDate = period ? new Date(period.startDate) : new Date(project.startDate);
            const dates = [];
            for (let i = 0; i < 28; i++) {
              const date = new Date(startDate);
              date.setDate(date.getDate() + i);
              dates.push(date.toISOString().split('T')[0]);
            }
            
            return (
              <div className="bg-white rounded-lg shadow-md overflow-x-auto">
                <div className="min-w-max">
                  <div className="grid grid-cols-[200px_repeat(28,120px)] border-b">
                    <div className="p-3 font-semibold bg-gray-50 sticky left-0 z-10">
                      <div>Employee</div>
                      <div className="text-[10px] font-normal text-gray-600 mt-0.5">
                        Ã°Å¸â€™Â¡ Click tiles Ã¢â‚¬Â¢ Shift+click Ã¢â‚¬Â¢ Ctrl+drag Ã¢â€ â€™
                      </div>
                    </div>
                    {dates.map((date, idx) => {
                      const d = new Date(date);
                      const isSelectedDate = selectedDateAssignments?.date === date;
                      const dateAssignmentsCount = projectAssignments.filter(a => a.date === date).length;
                      
                      return (
                        <div 
                          key={idx} 
                          draggable={isSelectedDate}
                          onDragStart={isSelectedDate ? handleDateDragStart : undefined}
                          onDragEnd={isSelectedDate ? handleDateDragEnd : undefined}
                          onClick={(e) => handleDateClick(e, date)}
                          className={`p-2 text-center text-xs border-l transition-all ${
                            isSelectedDate 
                              ? 'bg-blue-200 border-blue-500 ring-2 ring-blue-300 cursor-grab' 
                              : 'bg-gray-50 hover:bg-blue-50 cursor-pointer'
                          }`}
                          title={isSelectedDate ? `${dateAssignmentsCount} assignments selected. Drag to copy to another date.` : 'Ctrl+click to select all assignments for this date'}>
                          <div className="font-semibold">{d.toLocaleDateString('en-GB', { weekday: 'short' })}</div>
                          <div>{d.getDate()}/{d.getMonth() + 1}</div>
                          {isSelectedDate && (
                            <div className="mt-1 text-[10px] font-bold text-blue-700">
                              {dateAssignmentsCount} selected
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                  
                  {assignedEmployees.map(employee => {
                    const empAssignments = projectAssignments.filter(a => a.employeeId === employee.id);
                    const compliance = getEmployeeComplianceStatus(employee.id, assignments, shiftPatterns);
                    
                    return (
                      <div key={employee.id} className="grid grid-cols-[200px_repeat(28,120px)] border-b border-gray-200 hover:bg-gray-50">
                        <div className="p-3 sticky left-0 bg-white border-r flex items-center justify-between">
                          <div 
                            className="cursor-pointer hover:bg-blue-50 rounded p-1 -m-1"
                            onClick={() => {
                              setSelectedEmployee(employee.id);
                              setCurrentView('person');
                            }}>
                            <div className="font-semibold text-sm">{employee.name}</div>
                            <div className="text-xs text-gray-600">{employee.role}</div>
                          </div>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              setSelectedEmployee(employee.id);
                              setCurrentView('person');
                            }}
                            className="hover:scale-110 transition-transform"
                            title="View employee timeline">
                            {compliance.status === 'error' ? (
                              <ErrorTriangle className="w-4 h-4 text-red-500" title="Compliance breach" />
                            ) : compliance.status === 'warning' ? (
                              <AlertTriangle className="w-4 h-4 text-amber-500" title="Approaching limit" />
                            ) : (
                              <CheckCircle className="w-4 h-4 text-green-500" title="Compliant" />
                            )}
                          </button>
                        </div>
                        {dates.map((date, idx) => {
                          const assignment = empAssignments.find(a => a.date === date);
                          const pattern = assignment ? projectShiftPatterns.find(p => p.id === assignment.shiftPatternId) : null;
                          const isDragOver = dragOverCell?.date === date && dragOverCell?.employeeId === employee.id;
                          const isSelectedDate = selectedDateAssignments?.date === date;
                          const isSelectedTile = assignment && selectedTiles.some(t => t.assignmentId === assignment.id);
                          
                          // Check if this cell is in drag range AND matches the employee being dragged
                          let isDragTarget = false;
                          if (tileDragging && selectedTiles.length > 0) {
                            const startDate = new Date(tileDragging.startDate);
                            const cellDate = new Date(date);
                            const daysDiff = Math.round((cellDate - startDate) / (1000 * 60 * 60 * 24));
                            
                            // Only highlight if this employee matches one of the selected tiles
                            const hasMatchingEmployee = selectedTiles.some(t => t.employeeId === employee.id);
                            
                            isDragTarget = hasMatchingEmployee && daysDiff > 0 && daysDiff <= (tileDragging.daysForward || 0);
                          }
                          
                          return (
                            <div 
                              key={idx} 
                              className={`border-l p-1 min-h-[60px] transition-colors relative ${
                                isDragTarget ? 'bg-blue-100 border-2 border-blue-500' :
                                isSelectedTile ? 'bg-blue-200 border-2 border-blue-500 ring-2 ring-blue-300' :
                                isDragOver ? 'drag-over' :
                                isSelectedDate ? 'border-blue-300' :
                                assignment ? (
                                  compliance.status === 'error' ? 'bg-red-50' :
                                  compliance.status === 'warning' ? 'bg-amber-50' :
                                  pattern?.isNight ? 'bg-indigo-50' : 'bg-green-50'
                                ) : 'hover:bg-blue-50'
                              }`}
                              onClick={(e) => {
                                if (assignment && pattern) {
                                  handleTileClick(e, employee.id, date, assignment.id, pattern.id);
                                } else {
                                  openModal({ projectId: project.id, employeeId: employee.id, date });
                                }
                              }}
                              onMouseDown={(e) => {
                                if (assignment && pattern) {
                                  handleTileCtrlDragStart(e, employee.id, date, assignment.id, pattern.id);
                                }
                              }}
                              onDragOver={(e) => handleCellDragOver(e, null, date)}
                              onDrop={(e) => handleCellDrop(e, null, date)}
                              title={pattern ? `${pattern.name} (${pattern.startTime}-${pattern.endTime})${isSelectedTile ? ' - SELECTED' : ''}` : 'Click to assign'}
                              style={{ cursor: assignment ? 'pointer' : 'default', userSelect: 'none' }}>
                              {isDragTarget && (
                                <div className="text-[10px] font-semibold text-blue-600 text-center bg-blue-100 py-0.5 mb-1">
                                  Ã¢Å¾Å“ Will copy here
                                </div>
                              )}
                              {assignment && pattern && (
                                <div className={`text-[10px] font-medium flex items-center justify-between gap-1 group px-1 py-0.5 rounded ${
                                  isSelectedTile ? (
                                    compliance.status === 'error' ? 'bg-red-200 text-red-900 border border-red-500' :
                                    compliance.status === 'warning' ? 'bg-amber-200 text-amber-900 border border-amber-500' :
                                    'bg-green-200 text-green-900 border border-green-500'
                                  ) : (
                                    compliance.status === 'error' ? 'bg-red-100 text-red-800' :
                                    compliance.status === 'warning' ? 'bg-amber-100 text-amber-800' :
                                    'bg-green-100 text-green-800'
                                  )
                                }`}>
                                  {isSelectedTile && (
                                    <span className="flex-shrink-0 font-bold">Ã¢Å“â€œ</span>
                                  )}
                                  <span className="truncate flex-1">{pattern.name}</span>
                                  <div className="flex gap-0.5">
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        openModal({ 
                                          projectId: assignment.projectId, 
                                          assignmentId: assignment.id,
                                          employeeId: assignment.employeeId,
                                          date: assignment.date 
                                        });
                                      }}
                                      className="opacity-0 group-hover:opacity-100 hover:bg-blue-200 rounded p-0.5 transition-opacity flex-shrink-0"
                                      title="Edit shift">
                                      <Edit2 className="w-3 h-3" />
                                    </button>
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        if (confirm(`Remove ${employee.name} from ${pattern.name} on ${new Date(date).toLocaleDateString('en-GB')}?`)) {
                                          deleteAssignment(assignment.id);
                                        }
                                      }}
                                      className="opacity-0 group-hover:opacity-100 hover:bg-red-200 rounded p-0.5 transition-opacity flex-shrink-0"
                                      title="Remove shift">
                                      <Trash2 className="w-3 h-3" />
                                    </button>
                                  </div>
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    );
                  })}
                  
                  <div className="grid grid-cols-[200px_repeat(28,120px)] border-t bg-gray-50">
                    <div className="p-3 sticky left-0 bg-gray-100 border-r">
                      <button 
                        onClick={() => openModal({ projectId: project.id })}
                        className="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
                        <Plus className="w-4 h-4" /> Add Employee
                      </button>
                    </div>
                    {dates.map((date, idx) => (
                      <div key={idx} className="border-l"></div>
                    ))}
                  </div>
                </div>
                
                {/* Tile Drag Visual Feedback */}
                {tileDragging && selectedTiles.length > 0 && (
                  <div 
                    className="fixed bottom-4 right-4 bg-blue-600 text-white px-8 py-4 rounded-lg shadow-2xl z-50 flex items-center gap-4 animate-pulse"
                    style={{ pointerEvents: 'none' }}>
                    <div className="text-2xl font-bold">
                      Ã¢â€ â€™ +{tileDragging.daysForward || 0} days
                    </div>
                    <div className="text-base opacity-90">
                      Copying {selectedTiles.length} assignment{selectedTiles.length > 1 ? 's' : ''}
                    </div>
                  </div>
                )}
              </div>
            );
          }

          // Weekly View
          function WeeklyView({ project, shiftPatterns: projectShiftPatterns, projectAssignments, openModal, handleCellDragOver, handleCellDrop, handleDateClick, handleDateDragStart, handleDateDragEnd }) {
            const startDate = new Date(currentWeekStart);
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
              const date = new Date(startDate);
              date.setDate(date.getDate() + i);
              weekDates.push(date.toISOString().split('T')[0]);
            }
            
            const nextWeek = () => {
              const newDate = new Date(currentWeekStart);
              newDate.setDate(newDate.getDate() + 7);
              setCurrentWeekStart(newDate.toISOString().split('T')[0]);
            };
            
            const prevWeek = () => {
              const newDate = new Date(currentWeekStart);
              newDate.setDate(newDate.getDate() - 7);
              setCurrentWeekStart(newDate.toISOString().split('T')[0]);
            };
            
            return (
              <div className="bg-white rounded-lg shadow-md">
                <div className="p-4 border-b flex items-center justify-between">
                  <button onClick={prevWeek} className="p-2 hover:bg-gray-100 rounded">
                    <ChevronLeft className="w-5 h-5" />
                  </button>
                  <h3 className="text-lg font-semibold">
                    Week of {new Date(currentWeekStart).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}
                  </h3>
                  <button onClick={nextWeek} className="p-2 hover:bg-gray-100 rounded">
                    <ChevronRight className="w-5 h-5" />
                  </button>
                </div>
                
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="bg-gray-50">
                        <th className="p-3 text-left font-semibold border-r">Shift Pattern</th>
                        {weekDates.map((date, idx) => {
                          const d = new Date(date);
                          const isSelectedDate = selectedDateAssignments?.date === date;
                          const dateAssignmentsCount = projectAssignments.filter(a => a.date === date).length;
                          
                          return (
                            <th 
                              key={idx} 
                              draggable={isSelectedDate}
                              onDragStart={isSelectedDate ? handleDateDragStart : undefined}
                              onDragEnd={isSelectedDate ? handleDateDragEnd : undefined}
                              onClick={(e) => handleDateClick(e, date)}
                              className={`p-3 text-center border-l transition-all ${
                                isSelectedDate 
                                  ? 'bg-blue-200 border-blue-500 cursor-grab' 
                                  : 'cursor-pointer hover:bg-blue-50'
                              }`}
                              title={isSelectedDate ? `${dateAssignmentsCount} assignments selected. Drag to copy to another date.` : 'Ctrl+click to select all assignments for this date'}>
                              <div className="font-semibold">{d.toLocaleDateString('en-GB', { weekday: 'short' })}</div>
                              <div className="text-sm font-normal">{d.getDate()}/{d.getMonth() + 1}</div>
                              {isSelectedDate && (
                                <div className="text-[10px] font-bold text-blue-700 mt-1">
                                  {dateAssignmentsCount} selected
                                </div>
                              )}
                            </th>
                          );
                        })}
                      </tr>
                    </thead>
                    <tbody>
                      {projectShiftPatterns.map(pattern => {
                        return (
                          <tr key={pattern.id} className="border-t border-b hover:bg-gray-50">
                            <td className="p-3 border-r">
                              <div className="font-semibold">{pattern.name}</div>
                              <div className="text-xs text-gray-600">{pattern.startTime}-{pattern.endTime}</div>
                              <div className="text-xs text-gray-500">{pattern.dutyType}</div>
                            </td>
                            {weekDates.map((date, idx) => {
                              const dateAssignments = projectAssignments.filter(
                                a => a.date === date && a.shiftPatternId === pattern.id
                              );
                              const isDragOver = dragOverCell?.shiftPatternId === pattern.id && dragOverCell?.date === date;
                              const isSelectedDate = selectedDateAssignments?.date === date;
                              const isPartOfPattern = shiftPatternHasHoursForDay(pattern, date);
                              
                              // Check if this cell is in drag range AND matches the shift pattern being dragged
                              let isDragTarget = false;
                              if (tileDragging && selectedTiles.length > 0) {
                                const startDate = new Date(tileDragging.startDate);
                                const cellDate = new Date(date);
                                const daysDiff = Math.round((cellDate - startDate) / (1000 * 60 * 60 * 24));
                                
                                // Only highlight if this pattern matches one of the selected tiles' patterns
                                const hasMatchingPattern = selectedTiles.some(t => t.shiftPatternId === pattern.id);
                                
                                isDragTarget = hasMatchingPattern && daysDiff > 0 && daysDiff <= (tileDragging.daysForward || 0);
                              }
                              
                              return (
                                <td 
                                  key={idx} 
                                  className={`border-l p-2 cursor-pointer transition-colors ${
                                    isDragTarget ? 'bg-blue-100 border-2 border-blue-500' :
                                    isDragOver ? 'drag-over' : 
                                    isSelectedDate ? 'bg-blue-50 border-blue-200' :
                                    !isPartOfPattern ? 'non-pattern-day' :
                                    'hover:bg-blue-50'
                                  }`}
                                  onClick={() => openModal({ projectId: project.id, shiftPatternId: pattern.id, date })}
                                  onDragOver={(e) => handleCellDragOver(e, pattern.id, date)}
                                  onDrop={(e) => handleCellDrop(e, pattern.id, date)}
                                  title={!isPartOfPattern ? 'Not part of shift pattern - will use Custom Roster if assigned' : ''}>
                                  {isDragTarget && (
                                    <div className="text-xs font-bold text-blue-700 mb-1 text-center">
                                      Ã¢Å¾Å“ Will copy here
                                    </div>
                                  )}
                                  <div className="space-y-1">
                                    {dateAssignments
                                      .map(assignment => ({
                                        ...assignment,
                                        employeeName: employees.find(e => e.id === assignment.employeeId)?.name || ''
                                      }))
                                      .sort((a, b) => a.employeeName.localeCompare(b.employeeName))
                                      .map((assignment, aIdx) => {
                                      const employee = employees.find(e => e.id === assignment.employeeId);
                                      const compliance = getEmployeeComplianceStatus(assignment.employeeId, assignments, shiftPatterns);
                                      const isSelectedTile = selectedTiles.some(t => t.assignmentId === assignment.id);
                                      
                                      return (
                                        <div 
                                          key={aIdx}
                                          className={`text-xs px-2 py-1 rounded flex items-center justify-between gap-1 group transition-all ${
                                            isSelectedTile ? (
                                              compliance.status === 'error' ? 'bg-red-200 text-red-900 border-4 border-red-700 font-bold shadow-lg' :
                                              compliance.status === 'warning' ? 'bg-amber-200 text-amber-900 border-4 border-amber-700 font-bold shadow-lg' :
                                              'bg-green-200 text-green-900 border-4 border-green-700 font-bold shadow-lg'
                                            ) : (
                                              compliance.status === 'error' ? 'bg-red-100 text-red-800 border border-red-300' :
                                              compliance.status === 'warning' ? 'bg-amber-100 text-amber-800 border border-amber-300' :
                                              'bg-green-100 text-green-800 border border-green-300'
                                            )
                                          }`}
                                          onClick={(e) => handleTileClick(e, assignment.employeeId, date, assignment.id, pattern.id)}
                                          onMouseDown={(e) => {
                                            if (!e.shiftKey) {
                                              handleTileCtrlDragStart(e, assignment.employeeId, date, assignment.id, pattern.id);
                                            }
                                          }}
                                          style={{ cursor: tileDragging ? 'grabbing' : (isSelectedTile ? 'grab' : 'pointer'), userSelect: 'none' }}>
                                          {isSelectedTile && (
                                            <span className="flex-shrink-0 font-bold">Ã¢Å“â€œ</span>
                                          )}
                                          <span 
                                            className="truncate flex-1"
                                            title={employee?.name || 'Unknown Employee'}>
                                            {employee?.name || `Employee ${assignment.employeeId}`}
                                          </span>
                                          <div className="flex gap-0.5">
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                openModal({ 
                                                  projectId: assignment.projectId, 
                                                  assignmentId: assignment.id,
                                                  employeeId: assignment.employeeId,
                                                  date: assignment.date 
                                                });
                                              }}
                                              className="opacity-0 group-hover:opacity-100 hover:bg-blue-200 rounded p-0.5 transition-opacity flex-shrink-0"
                                              title="Edit shift">
                                              <Edit2 className="w-3 h-3" />
                                            </button>
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                if (confirm(`Remove ${employee?.name} from this shift?`)) {
                                                  deleteAssignment(assignment.id);
                                                }
                                              }}
                                              className="opacity-0 group-hover:opacity-100 hover:bg-red-200 rounded p-0.5 transition-opacity flex-shrink-0"
                                              title="Remove shift">
                                              <Trash2 className="w-3 h-3" />
                                            </button>
                                          </div>
                                        </div>
                                      );
                                    })}
                                    {dateAssignments.length === 0 && (
                                      <div className="text-xs text-gray-400 text-center">Click to assign</div>
                                    )}
                                  </div>
                                </td>
                              );
                            })}
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
                
                {/* Tile Drag Visual Feedback */}
                {tileDragging && selectedTiles.length > 0 && (
                  <div 
                    className="fixed bottom-4 right-4 bg-blue-600 text-white px-8 py-4 rounded-lg shadow-2xl z-50 flex items-center gap-4 animate-pulse"
                    style={{ pointerEvents: 'none' }}>
                    <div className="text-2xl font-bold">
                      Ã¢â€ â€™ +{tileDragging.daysForward || 0} days
                    </div>
                    <div className="text-base opacity-90">
                      Copying {selectedTiles.length} assignment{selectedTiles.length > 1 ? 's' : ''}
                    </div>
                  </div>
                )}
              </div>
            );
          }

          // Person View Container
          function PersonViewContainer() {
            const employee = employees.find(e => e.id === selectedEmployee);
            if (!employee) return null;
            
            // Function to open assignment modal
            const openAssignmentModal = (data) => {
              setAssignmentModalData(data);
              setShowAssignmentModal(true);
            };
            
            // State for quick shift addition popup
            const [quickShiftPopup, setQuickShiftPopup] = useState(null); // { date, x, y }
            
            const empAssignments = assignments.filter(a => a.employeeId === selectedEmployee)
              .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const compliance = getEmployeeComplianceStatus(selectedEmployee, assignments, shiftPatterns);
            
            const startDate = empAssignments.length > 0 ? new Date(empAssignments[0].date) : new Date();
            const endDate = empAssignments.length > 0 ? new Date(empAssignments[empAssignments.length - 1].date) : new Date();
            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            
            const calendarDates = [];
            for (let i = 0; i < Math.max(28, daysDiff); i++) {
              const date = new Date(startDate);
              date.setDate(date.getDate() + i);
              calendarDates.push(date.toISOString().split('T')[0]);
            }
            
            // Handle clicking empty date to add shift
            const handleEmptyDateClick = (e, date) => {
              // Get click position for popup positioning
              const rect = e.currentTarget.getBoundingClientRect();
              setQuickShiftPopup({
                date: date,
                x: rect.left,
                y: rect.bottom + window.scrollY
              });
            };
            
            // Quick assign shift from popup
            const quickAssignShift = async (projectId, shiftPatternId) => {
              if (!quickShiftPopup) return;
              
              // Validate shift pattern has hours for this day
              const pattern = shiftPatterns.find(p => p.id === shiftPatternId);
              const date = quickShiftPopup.date;
              
              if (pattern && !shiftPatternHasHoursForDay(pattern, date)) {
                const employee = employees.find(e => e.id === selectedEmployee);
                const validPatterns = getValidShiftPatternsForDay(shiftPatterns, projectId, date);
                
                // Open modal instead of alert
                setNoRosterModalData({
                  employees: [employee],
                  date: date,
                  projectId: projectId,
                  attemptedPattern: pattern,
                  validPatterns: validPatterns
                });
                setShowNoRosterModal(true);
                setQuickShiftPopup(null); // Close the quick shift popup
                return;
              }
              
              try {
                const maxId = Math.max(...assignments.map(a => a.id), 0);
                const newAssignment = {
                  id: maxId + 1,
                  employeeId: selectedEmployee,
                  projectId: projectId,
                  shiftPatternId: shiftPatternId,
                  date: quickShiftPopup.date
                };
                
                await db.collection('assignments').doc(String(newAssignment.id)).set(newAssignment);
                console.log('Ã¢Å“â€¦ Quick assignment saved');
                setQuickShiftPopup(null);
              } catch (error) {
                console.error('Ã¢ÂÅ’ Error saving quick assignment:', error);
                alert('Failed to save assignment. Please try again.');
              }
            };
            
            return (
              <div style={{ minHeight: '100vh', background: '#f1f5f9' }}>
                {/* Header - Sleek Dark Style */}
                <div style={{ 
                    background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)', 
                    padding: '0.75rem 1.5rem',
                    borderBottom: '3px solid #f97316',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between'
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                        <button 
                            onClick={() => setCurrentView('dashboard')}
                            style={{
                                background: '#334155',
                                border: 'none',
                                color: 'white',
                                padding: '0.5rem 0.75rem',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.25rem',
                                fontSize: '0.8rem'
                            }}>
                            Ã¢â€ Â Back
                        </button>
                        <div style={{ color: 'white', fontWeight: 600, fontSize: '1.1rem' }}>
                            {employee.name} <span style={{ color: '#f97316' }}>Timeline</span>
                        </div>
                        <span style={{ color: '#64748b', fontSize: '0.75rem' }}>{employee.role}</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                        {/* Employee Selector */}
                        <select 
                            value={selectedEmployee}
                            onChange={(e) => setSelectedEmployee(Number(e.target.value))}
                            style={{
                                background: '#334155',
                                color: 'white',
                                border: 'none',
                                padding: '0.375rem 0.625rem',
                                borderRadius: '4px',
                                fontSize: '0.8rem',
                                cursor: 'pointer'
                            }}>
                            {employees.map(emp => (
                                <option key={emp.id} value={emp.id}>{emp.name}</option>
                            ))}
                        </select>
                        {/* View Switcher */}
                        <div style={{ display: 'flex', gap: '0.25rem', background: '#334155', padding: '0.25rem', borderRadius: '6px' }}>
                            <button 
                                onClick={() => setCurrentView('planning')}
                                style={{
                                    padding: '0.375rem 0.625rem',
                                    fontSize: '0.75rem',
                                    background: 'transparent',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer'
                                }}>
                                Planning
                            </button>
                            <button 
                                onClick={() => setCurrentView('summary')}
                                style={{
                                    padding: '0.375rem 0.625rem',
                                    fontSize: '0.75rem',
                                    background: 'transparent',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer'
                                }}>
                                Summary
                            </button>
                            <button 
                                style={{
                                    padding: '0.375rem 0.625rem',
                                    fontSize: '0.75rem',
                                    background: '#f97316',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer'
                                }}>
                                Person
                            </button>
                        </div>
                        <div style={{
                            background: '#334155',
                            color: '#f97316',
                            padding: '0.375rem 0.75rem',
                            borderRadius: '4px',
                            fontFamily: 'ui-monospace, monospace',
                            fontSize: '0.7rem',
                            fontWeight: 500
                        }}>
                            PERSON VIEW
                        </div>
                        <SignOutHeader user={user} onSignOut={onSignOut} />
                    </div>
                </div>
                
                <div className="p-6">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                  <div className={`bg-white rounded-lg shadow-md p-6 ${
                    compliance.status === 'error' ? 'border-l-4 border-red-500' :
                    compliance.status === 'warning' ? 'border-l-4 border-amber-500' :
                    'border-l-4 border-green-500'
                  }`}>
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">Compliance Status</p>
                        <p className={`text-2xl font-bold ${
                          compliance.status === 'error' ? 'text-red-600' :
                          compliance.status === 'warning' ? 'text-amber-600' :
                          'text-green-600'
                        }`}>
                          {compliance.status === 'error' ? 'Non-Compliant' :
                           compliance.status === 'warning' ? 'Warning' :
                           'Compliant'}
                        </p>
                      </div>
                      {compliance.status === 'error' ? (
                        <ErrorTriangle className="w-12 h-12 text-red-500" />
                      ) : compliance.status === 'warning' ? (
                        <AlertTriangle className="w-12 h-12 text-amber-500" />
                      ) : (
                        <CheckCircle className="w-12 h-12 text-green-500" />
                      )}
                    </div>
                  </div>
                  
                  <div className="bg-white rounded-lg shadow-md p-6">
                    <p className="text-sm text-gray-600">Total Assignments</p>
                    <p className="text-2xl font-bold text-gray-900">{empAssignments.length}</p>
                    <p className="text-xs text-gray-500 mt-1">Across {new Set(empAssignments.map(a => a.projectId)).size} project(s)</p>
                  </div>
                  
                  <div className="bg-white rounded-lg shadow-md p-6">
                    <p className="text-sm text-gray-600">Violations</p>
                    <p className="text-2xl font-bold text-gray-900">
                      {compliance.violations.length}
                    </p>
                    <p className="text-xs text-gray-500 mt-1">
                      {compliance.status === 'error' ? 'Requires attention' : 
                       compliance.status === 'warning' ? 'Approaching limits' : 'None detected'}
                    </p>
                  </div>
                </div>
                
                {compliance.violations.length > 0 && (
                  <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 className="text-lg font-semibold mb-4">Compliance Violations</h3>
                    <div className="space-y-4">
                      {compliance.violations.map((violation, idx) => {
                        // Get the assignments involved in this violation
                        let violationAssignments = [];
                        if (violation.type === 'MAX_WEEKLY_HOURS' || violation.type === 'APPROACHING_WEEKLY_LIMIT') {
                          const windowStart = new Date(violation.date);
                          const windowEnd = new Date(violation.windowEnd || violation.date);
                          violationAssignments = empAssignments.filter(a => {
                            const aDate = new Date(a.date);
                            return aDate >= windowStart && aDate <= windowEnd;
                          });
                        } else if (violation.type === 'MAX_SHIFT_LENGTH' || violation.type === 'INSUFFICIENT_REST') {
                          violationAssignments = empAssignments.filter(a => a.date === violation.date);
                        }
                        
                        return (
                          <div key={idx} className={`p-4 rounded-lg ${
                            violation.severity === 'error' ? 'bg-red-50 border-l-4 border-red-500' :
                            'bg-amber-50 border-l-4 border-amber-500'
                          }`}>
                            <div className="flex items-start gap-3">
                              {violation.severity === 'error' ? (
                                <ErrorTriangle className="w-5 h-5 text-red-500 mt-0.5" />
                              ) : (
                                <AlertTriangle className="w-5 h-5 text-amber-500 mt-0.5" />
                              )}
                              <div className="flex-1">
                                <p className={`font-semibold ${
                                  violation.severity === 'error' ? 'text-red-900' : 'text-amber-900'
                                }`}>
                                  {violation.type === 'MAX_SHIFT_LENGTH' ? 'Maximum Shift Length Exceeded' :
                                   violation.type === 'INSUFFICIENT_REST' ? 'Insufficient Rest Period' :
                                   violation.type === 'MAX_WEEKLY_HOURS' ? 'Maximum Weekly Hours Exceeded' :
                                   'Approaching Weekly Limit'}
                                </p>
                                <p className={`text-sm mt-1 ${
                                  violation.severity === 'error' ? 'text-red-700' : 'text-amber-700'
                                }`}>
                                  {violation.message}
                                </p>
                                <p className="text-xs text-gray-600 mt-1">
                                  Date: {new Date(violation.date).toLocaleDateString('en-GB', { 
                                    weekday: 'long', 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                  })}
                                  {violation.windowEnd && ` to ${new Date(violation.windowEnd).toLocaleDateString('en-GB', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                  })}`}
                                </p>
                                
                                {/* Show shifts involved in this violation */}
                                {violationAssignments.length > 0 && (
                                  <div className="mt-3 space-y-2">
                                    <p className="text-xs font-semibold text-gray-700">Shifts causing this violation:</p>
                                    {violationAssignments.map(assignment => {
                                      const pattern = shiftPatterns.find(p => p.id === assignment.shiftPatternId);
                                      const proj = projects.find(p => p.id === assignment.projectId);
                                      const shiftDuration = pattern ? calculateShiftDuration(pattern.startTime, pattern.endTime) : 0;
                                      
                                      return (
                                        <div key={assignment.id} className="flex items-center justify-between bg-white rounded p-2 text-xs">
                                          <div className="flex-1">
                                            <span className="font-medium">
                                              {new Date(assignment.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}
                                            </span>
                                            <span className="mx-2">Ã¢â‚¬Â¢</span>
                                            <span className="text-gray-700">{pattern?.name || 'Unknown Shift'}</span>
                                            <span className="mx-2">Ã¢â‚¬Â¢</span>
                                            <span className="text-gray-600">{pattern?.startTime}-{pattern?.endTime}</span>
                                            <span className="mx-2">Ã¢â‚¬Â¢</span>
                                            <span className="text-gray-600">{shiftDuration.toFixed(1)}h</span>
                                            <span className="mx-2">Ã¢â‚¬Â¢</span>
                                            <span className="text-gray-500">{proj?.name}</span>
                                          </div>
                                          <div className="flex gap-1">
                                            <button
                                              onClick={() => {
                                                openAssignmentModal({ 
                                                  projectId: assignment.projectId, 
                                                  assignmentId: assignment.id,
                                                  employeeId: assignment.employeeId,
                                                  date: assignment.date 
                                                });
                                              }}
                                              className="p-1 text-blue-600 hover:bg-blue-100 rounded"
                                              title="Edit this shift">
                                              <Edit2 className="w-4 h-4" />
                                            </button>
                                            <button
                                              onClick={() => {
                                                if (confirm(`Remove ${employee.name} from ${pattern?.name} on ${new Date(assignment.date).toLocaleDateString('en-GB')}?`)) {
                                                  deleteAssignment(assignment.id);
                                                }
                                              }}
                                              className="p-1 text-red-600 hover:bg-red-100 rounded"
                                              title="Remove this shift">
                                              <Trash2 className="w-4 h-4" />
                                            </button>
                                          </div>
                                        </div>
                                      );
                                    })}
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
                
                {/* Calculate violation assignment IDs once using useMemo pattern */}
                {(() => {
                  // Calculate all violation assignment IDs
                  const violationAssignmentIds = new Set();
                  
                  compliance.violations.forEach((violation) => {
                    let violationAssignments = [];
                    if (violation.type === 'MAX_WEEKLY_HOURS' || violation.type === 'APPROACHING_WEEKLY_LIMIT') {
                      const windowStart = new Date(violation.date);
                      let windowEnd;
                      
                      if (violation.windowEnd) {
                        windowEnd = new Date(violation.windowEnd);
                      } else {
                        windowEnd = new Date(windowStart);
                        windowEnd.setDate(windowEnd.getDate() + 6);
                      }
                      
                      violationAssignments = empAssignments.filter(a => {
                        const aDate = new Date(a.date);
                        return aDate >= windowStart && aDate <= windowEnd;
                      });
                    } else if (violation.type === 'INSUFFICIENT_REST') {
                      const violationDate = new Date(violation.date);
                      const previousDate = new Date(violationDate);
                      previousDate.setDate(previousDate.getDate() - 1);
                      
                      const currentDayAssignments = empAssignments.filter(a => a.date === violation.date);
                      const prevDateStr = previousDate.toISOString().split('T')[0];
                      const previousDayAssignments = empAssignments.filter(a => a.date === prevDateStr);
                      
                      violationAssignments = [...currentDayAssignments, ...previousDayAssignments];
                    } else if (violation.type === 'MAX_SHIFT_LENGTH' || violation.type === 'DAY_NIGHT_TRANSITION' || violation.type === 'MULTIPLE_SHIFTS_SAME_DAY') {
                      violationAssignments = empAssignments.filter(a => a.date === violation.date);
                    }
                    violationAssignments.forEach(a => violationAssignmentIds.add(a.id));
                  });
                  
                  // Render the Schedule Timeline with violation data
                  return (
                    <div className="bg-white rounded-lg shadow-md p-6">
                      <h3 className="text-lg font-semibold mb-4">Schedule Timeline</h3>
                      <div className="overflow-x-auto">
                        <div className="inline-flex gap-1 min-w-full">
                          {calendarDates.map((date, idx) => {
                            const dateAssignments = empAssignments.filter(a => a.date === date);
                            const d = new Date(date);
                            const complianceStatus = dateAssignments.length > 0 ? getEmployeeComplianceStatus(employee.id, assignments, shiftPatterns) : null;
                            
                            // Check if this date has any violations
                            const hasViolation = dateAssignments.some(a => violationAssignmentIds.has(a.id));
                            
                            // Determine tile color based on compliance
                            let tileColor = 'bg-gray-50';
                            let borderColor = 'border-gray-200';
                            let dateTextColor = 'text-gray-800';
                            
                            if (dateAssignments.length > 0) {
                              if (hasViolation) {
                                tileColor = 'bg-red-600';
                                borderColor = 'border-red-700 border-4';
                                dateTextColor = 'text-white';
                              } else if (complianceStatus?.status === 'error') {
                                tileColor = 'bg-red-100';
                                borderColor = 'border-red-300';
                                dateTextColor = 'text-red-900';
                              } else if (complianceStatus?.status === 'warning') {
                                tileColor = 'bg-amber-100';
                                borderColor = 'border-amber-300';
                                dateTextColor = 'text-amber-900';
                              } else {
                                tileColor = 'bg-green-100';
                                borderColor = 'border-green-300';
                                dateTextColor = 'text-green-900';
                              }
                            }
                            
                            return (
                              <div 
                                key={idx}
                                onClick={dateAssignments.length === 0 ? (e) => handleEmptyDateClick(e, date) : undefined}
                                className={`flex-shrink-0 w-40 p-2 border rounded relative group ${tileColor} ${borderColor} ${dateAssignments.length === 0 ? 'cursor-pointer hover:border-blue-400 hover:bg-blue-50' : ''}`}
                                style={hasViolation ? { backgroundColor: '#dc2626' } : {}}>
                                <div className={`text-sm font-bold text-center mb-1 ${dateTextColor}`}>{d.toLocaleDateString('en-GB', { weekday: 'short' })}</div>
                                <div className={`text-sm font-semibold text-center mb-3 ${dateTextColor}`}>{d.getDate()}/{d.getMonth() + 1}</div>
                                
                                {dateAssignments.length === 0 && (
                                  <div className="mt-2 flex justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <Plus className="w-5 h-5 text-blue-500" />
                                  </div>
                                )}
                                
                                {dateAssignments.length > 0 && (
                                  <div className="space-y-2">
                                    {dateAssignments.map((assignment, aIdx) => {
                                      const pattern = shiftPatterns.find(p => p.id === assignment.shiftPatternId);
                                      const project = projects.find(p => p.id === assignment.projectId);
                                      const isViolationShift = violationAssignmentIds.has(assignment.id);
                                      
                                      return (
                                        <div key={aIdx} className={`relative bg-white rounded p-2 shadow-sm ${
                                          isViolationShift 
                                            ? 'border-2 border-red-500 ring-2 ring-red-200' 
                                            : 'border border-gray-300'
                                        }`}>
                                          <div className="absolute top-1 right-1 flex gap-0.5">
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                openAssignmentModal({ 
                                                  projectId: assignment.projectId, 
                                                  assignmentId: assignment.id,
                                                  employeeId: assignment.employeeId,
                                                  date: assignment.date 
                                                });
                                              }}
                                              className="bg-white hover:bg-blue-100 rounded p-0.5 border border-gray-300"
                                              title="Edit shift">
                                              <Edit2 className="w-4 h-4 text-blue-600" />
                                            </button>
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                if (confirm(`Remove ${employee.name} from ${pattern?.name} on ${d.toLocaleDateString('en-GB')}?`)) {
                                                  deleteAssignment(assignment.id);
                                                }
                                              }}
                                              className="bg-white hover:bg-red-100 rounded p-0.5 border border-gray-300"
                                              title="Remove shift">
                                              <Trash2 className="w-4 h-4 text-red-600" />
                                            </button>
                                          </div>
                                          <div className="pr-12">
                                            <div className="text-[10px] font-semibold text-gray-900 mb-0.5" title={pattern?.name}>
                                              {pattern?.name}
                                            </div>
                                            <div className="text-[10px] text-gray-700 mb-0.5 font-medium" title={project?.name}>
                                              {project?.name}
                                            </div>
                                            <div className="text-[9px] text-gray-600">
                                              {pattern?.startTime}-{pattern?.endTime}
                                            </div>
                                          </div>
                                          {dateAssignments.length > 1 && aIdx === 0 && !isViolationShift && (
                                            <div className="absolute -top-2 -left-2 bg-orange-500 text-white text-[9px] font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-md" title={`${dateAssignments.length} shifts on this day`}>
                                              {dateAssignments.length}
                                            </div>
                                          )}
                                        </div>
                                      );
                                    })}
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                  );
                })()}
                
                {/* Quick Shift Popup */}
                {quickShiftPopup && (
                  <>
                    {/* Backdrop */}
                    <div 
                      className="fixed inset-0 bg-black-50 z-40 flex items-center justify-center"
                      onClick={() => setQuickShiftPopup(null)}
                    />
                    
                    {/* Popup - Centered and responsive */}
                    <div 
                      className="fixed z-50 bg-white rounded-lg shadow-2xl border border-gray-200 w-full max-w-md max-h-[80vh] overflow-y-auto"
                      style={{
                        left: '50%',
                        top: '50%',
                        transform: 'translate(-50%, -50%)'
                      }}
                      onClick={(e) => e.stopPropagation()}>
                      <div className="sticky top-0 bg-white border-b px-4 py-3 flex items-center justify-between z-10">
                        <h3 className="font-semibold text-gray-900">
                          Add Shift - {new Date(quickShiftPopup.date).toLocaleDateString('en-GB')}
                        </h3>
                        <button
                          onClick={() => setQuickShiftPopup(null)}
                          className="text-gray-400 hover:text-gray-600">
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      </div>
                      
                      <div className="p-2">
                        {projects.map(project => {
                          const projectPatterns = shiftPatterns.filter(sp => sp.projectId === project.id);
                          if (projectPatterns.length === 0) return null;
                          
                          return (
                            <div key={project.id} className="mb-3">
                              <div className="px-2 py-1 text-xs font-semibold text-gray-600 bg-gray-50 rounded">
                                {project.name}
                              </div>
                              <div className="mt-1 space-y-1">
                                {projectPatterns.map(pattern => {
                                  // Check if pattern has hours for this day
                                  const hasHours = shiftPatternHasHoursForDay(pattern, quickShiftPopup.date);
                                  
                                  return (
                                    <button
                                      key={pattern.id}
                                      onClick={() => quickAssignShift(project.id, pattern.id)}
                                      disabled={!hasHours}
                                      className={`w-full text-left px-3 py-2 rounded transition-colors flex items-center justify-between group ${
                                        hasHours 
                                          ? 'hover:bg-blue-50' 
                                          : 'opacity-50 cursor-not-allowed bg-gray-100'
                                      }`}
                                      title={hasHours ? '' : 'No hours scheduled for this day'}>
                                      <div className="flex-1">
                                        <div className="font-medium text-sm text-gray-900">{pattern.name}</div>
                                        <div className="text-xs text-gray-500">
                                          {pattern.weeklySchedule ? (
                                            (() => {
                                              const dayIndex = getDayOfWeekShort(quickShiftPopup.date);
                                              const dayName = getDayOfWeekName(dayIndex);
                                              const daySchedule = pattern.weeklySchedule[dayName];
                                              return daySchedule && daySchedule.startTime && daySchedule.endTime ? (
                                                <span>{daySchedule.startTime} - {daySchedule.endTime}</span>
                                              ) : (
                                                <span className="text-red-500">No hours for this day</span>
                                              );
                                            })()
                                          ) : (
                                            <span>{pattern.startTime} - {pattern.endTime}</span>
                                          )}
                                          {pattern.isNight && <span className="ml-2 text-indigo-600">Ã¢â€”Â Night</span>}
                                        </div>
                                      </div>
                                      {hasHours && (
                                        <Plus className="w-4 h-4 text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity" />
                                      )}
                                    </button>
                                  );
                                })}
                              </div>
                            </div>
                          );
                        })}
                    </div>
                    </div>
                  </>
                )}
                </div>
              </div>
            );
          }

          // Project Summary Container
          function ProjectSummaryContainer() {
            const project = projects.find(p => p.id === selectedProject);
            
            if (!project) {
              // If no project found, go back to dashboard
              React.useEffect(() => {
                setCurrentView('dashboard');
              }, []);
              return null;
            }
            
            const stats = getProjectStats(project.id);
            const projectAssignments = assignments.filter(a => a.projectId === selectedProject);
            const projectShiftPatterns = shiftPatterns.filter(sp => sp.projectId === selectedProject);
            const uniqueEmployees = [...new Set(projectAssignments.map(a => a.employeeId))];
            
            const shiftBreakdown = {};
            projectAssignments.forEach(assignment => {
              const pattern = shiftPatterns.find(p => p.id === assignment.shiftPatternId);
              if (pattern) {
                let hours = 0;
                
                // Handle weekly schedule patterns
                if (pattern.weeklySchedule || (assignment.customStartTime && assignment.customEndTime)) {
                  const times = getShiftTimesForDate(pattern, assignment.date, assignment);
                  hours = calculateShiftDuration(times.startTime, times.endTime);
                } else {
                  // Handle simple start/end time patterns
                  hours = calculateShiftDuration(pattern.startTime, pattern.endTime);
                }
                
                if (!shiftBreakdown[pattern.name]) {
                  shiftBreakdown[pattern.name] = { hours: 0, count: 0 };
                }
                shiftBreakdown[pattern.name].hours += hours;
                shiftBreakdown[pattern.name].count += 1;
              }
            });
            
            return (
              <div style={{ minHeight: '100vh', background: '#f1f5f9' }}>
                {/* Header - Sleek Dark Style */}
                <div style={{ 
                    background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)', 
                    padding: '0.75rem 1.5rem',
                    borderBottom: '3px solid #8b5cf6',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between'
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                        <button 
                            onClick={() => setCurrentView('dashboard')}
                            style={{
                                background: '#334155',
                                border: 'none',
                                color: 'white',
                                padding: '0.5rem 0.75rem',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.25rem',
                                fontSize: '0.8rem'
                            }}>
                            Ã¢â€ Â Back
                        </button>
                        <div style={{ color: 'white', fontWeight: 600, fontSize: '1.1rem' }}>
                            {project.name} <span style={{ color: '#8b5cf6' }}>Summary</span>
                        </div>
                        <span style={{ color: '#64748b', fontSize: '0.75rem' }}>{project.location}</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                        {/* Project Selector */}
                        <select
                            value={selectedProject || ''}
                            onChange={(e) => setSelectedProject(Number(e.target.value))}
                            style={{
                                background: '#334155',
                                color: 'white',
                                border: 'none',
                                padding: '0.375rem 0.625rem',
                                borderRadius: '4px',
                                fontSize: '0.8rem',
                                cursor: 'pointer'
                            }}>
                            {projects.map(p => (
                                <option key={p.id} value={p.id}>{p.name}</option>
                            ))}
                        </select>
                        {/* View Switcher */}
                        <div style={{ display: 'flex', gap: '0.25rem', background: '#334155', padding: '0.25rem', borderRadius: '6px' }}>
                            <button 
                                onClick={() => setCurrentView('planning')}
                                style={{
                                    padding: '0.375rem 0.625rem',
                                    fontSize: '0.75rem',
                                    background: 'transparent',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer'
                                }}>
                                Planning
                            </button>
                            <button 
                                style={{
                                    padding: '0.375rem 0.625rem',
                                    fontSize: '0.75rem',
                                    background: '#8b5cf6',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer'
                                }}>
                                Summary
                            </button>
                            <button 
                                onClick={() => {
                                    const assignedEmployeeIds = [...new Set(projectAssignments.map(a => a.employeeId))];
                                    if (assignedEmployeeIds.length > 0) {
                                        setSelectedEmployee(assignedEmployeeIds[0]);
                                        setCurrentView('person');
                                    } else {
                                        alert('No employees assigned to this project yet.');
                                    }
                                }}
                                style={{
                                    padding: '0.375rem 0.625rem',
                                    fontSize: '0.75rem',
                                    background: 'transparent',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer'
                                }}>
                                Person
                            </button>
                        </div>
                        <div style={{
                            background: '#334155',
                            color: '#8b5cf6',
                            padding: '0.375rem 0.75rem',
                            borderRadius: '4px',
                            fontFamily: 'ui-monospace, monospace',
                            fontSize: '0.7rem',
                            fontWeight: 500
                        }}>
                            PROJECT SUMMARY
                        </div>
                        <SignOutHeader user={user} onSignOut={onSignOut} />
                    </div>
                </div>
                
                <div className="p-6">
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                  <div className="bg-white rounded-lg shadow-md p-6">
                    <p className="text-sm text-gray-600">Total Hours Planned</p>
                    <p className="text-3xl font-bold text-gray-900">{stats.totalHours.toLocaleString()}</p>
                  </div>
                  
                  <div className="bg-white rounded-lg shadow-md p-6">
                    <p className="text-sm text-gray-600">People Assigned</p>
                    <p className="text-3xl font-bold text-gray-900">{stats.employeeCount}</p>
                  </div>
                  
                  <div className="bg-white rounded-lg shadow-md p-6">
                    <p className="text-sm text-gray-600">Total Assignments</p>
                    <p className="text-3xl font-bold text-gray-900">{projectAssignments.length}</p>
                  </div>
                  
                  <div className={`bg-white rounded-lg shadow-md p-6 ${
                    stats.violations.length > 0 ? 'border-l-4 border-red-500' : 'border-l-4 border-green-500'
                  }`}>
                    <p className="text-sm text-gray-600">Compliance Breaches</p>
                    <p className={`text-3xl font-bold ${stats.violations.length > 0 ? 'text-red-600' : 'text-green-600'}`}>
                      {stats.violations.length}
                    </p>
                  </div>
                </div>
                
                {stats.violations.length > 0 && (
                  <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                      <ErrorTriangle className="w-5 h-5 text-red-500" />
                      Compliance Breaches Detected
                    </h3>
                    <div className="space-y-4">
                      {stats.violations.map((empViolation, idx) => (
                        <div key={idx} className="border-l-4 border-red-500 bg-red-50 p-4 rounded-r-lg">
                          <div className="flex items-start justify-between">
                            <div className="flex-1">
                              <p className="font-semibold text-red-900">{empViolation.employeeName}</p>
                              <div className="mt-2 space-y-2">
                                {empViolation.violations.map((violation, vIdx) => (
                                  <div key={vIdx} className="text-sm text-red-700">
                                    <p className="font-medium">
                                      {violation.type === 'MAX_SHIFT_LENGTH' ? 'Ã¢Å¡Â  Maximum Shift Length' :
                                       violation.type === 'INSUFFICIENT_REST' ? 'Ã¢Å¡Â  Insufficient Rest' :
                                       'Ã¢Å¡Â  Maximum Weekly Hours'}
                                    </p>
                                    <p className="ml-4">{violation.message}</p>
                                    <p className="ml-4 text-xs text-red-600">
                                      {new Date(violation.date).toLocaleDateString('en-GB', { 
                                        weekday: 'short', 
                                        year: 'numeric', 
                                        month: 'short', 
                                        day: 'numeric' 
                                      })}
                                    </p>
                                  </div>
                                ))}
                              </div>
                            </div>
                            <button 
                              onClick={() => { setSelectedEmployee(empViolation.employeeId); setCurrentView('person'); }}
                              className="text-sm text-blue-600 hover:text-blue-800 ml-4">
                              View Details Ã¢â€ â€™
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-lg font-semibold">Shift Pattern Breakdown</h3>
                    <button 
                      onClick={() => {
                        setShiftPatternModalData({ projectId: project.id, mode: 'add' });
                        setShowShiftPatternModal(true);
                      }}
                      className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center gap-2 text-sm">
                      <Plus className="w-4 h-4" /> Add Shift Pattern
                    </button>
                  </div>
                  
                  {projectShiftPatterns.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      No shift patterns defined yet. Click "Add Shift Pattern" to create one.
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {projectShiftPatterns.map(pattern => {
                        const patternData = shiftBreakdown[pattern.name] || { count: 0, hours: 0 };
                        const daysOfWeek = ['Sat', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
                        
                        return (
                          <div key={pattern.id} className="border rounded-lg p-4 bg-gray-50">
                            <div className="flex items-start justify-between mb-3">
                              <div className="flex-1">
                                <div className="flex items-center gap-3 mb-2">
                                  <h4 className="font-semibold text-base">{pattern.name}</h4>
                                  <span className={`text-xs px-2 py-1 rounded ${
                                    pattern.dutyType === 'Possession' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'
                                  }`}>
                                    {pattern.dutyType}
                                  </span>
                                  {pattern.isNight && (
                                    <span className="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded">Night Shift</span>
                                  )}
                                </div>
                                <div className="flex gap-4 text-xs text-gray-600">
                                  <span>{patternData.count} assignments</span>
                                  <span>{patternData.hours.toFixed(1)}h total</span>
                                </div>
                              </div>
                              <div className="flex items-center gap-2">
                                <button 
                                  onClick={() => {
                                    setShiftPatternModalData({ 
                                      ...pattern,
                                      mode: 'edit'
                                    });
                                    setShowShiftPatternModal(true);
                                  }}
                                  className="text-blue-600 hover:text-blue-800 p-1"
                                  title="Edit shift pattern">
                                  <Edit2 className="w-4 h-4" />
                                </button>
                                <button 
                                  onClick={() => {
                                    if (window.confirm(`Delete shift pattern "${pattern.name}"?`)) {
                                      deleteShiftPattern(pattern.id);
                                    }
                                  }}
                                  className="text-red-600 hover:text-red-800 p-1"
                                  title="Delete shift pattern">
                                  <Trash2 className="w-4 h-4" />
                                </button>
                              </div>
                            </div>
                            
                            <div className="bg-white rounded border">
                              <table className="w-full text-xs">
                                <thead>
                                  <tr className="bg-gray-100">
                                    <th className="text-center p-2 font-semibold w-20"></th>
                                    {daysOfWeek.map(day => (
                                      <th key={day} className="text-center p-2 font-semibold">
                                        {day}
                                      </th>
                                    ))}
                                  </tr>
                                </thead>
                                <tbody>
                                  {/* Commute In */}
                                  <tr className="border-t" style={{ background: '#fffbeb' }}>
                                    <td className="text-center p-1 font-medium text-amber-700 bg-amber-50 text-[10px]">Commute In</td>
                                    {daysOfWeek.map(day => {
                                      const daySchedule = pattern.weeklySchedule ? pattern.weeklySchedule[day] : {};
                                      return (
                                        <td key={`${day}-commuteIn`} className="text-center p-1" style={{ color: daySchedule?.startTime ? '#1f2937' : '#9ca3af' }}>
                                          {daySchedule?.startTime ? (daySchedule.commuteIn ?? 60) : '-'}
                                        </td>
                                      );
                                    })}
                                  </tr>
                                  
                                  {/* Start Time */}
                                  <tr className="border-t" style={{ background: '#eff6ff' }}>
                                    <td className="text-center p-1 font-semibold text-blue-800 bg-blue-100 text-[10px]">Start</td>
                                    {daysOfWeek.map(day => {
                                      const daySchedule = pattern.weeklySchedule 
                                        ? pattern.weeklySchedule[day]
                                        : { startTime: pattern.startTime || '', endTime: pattern.endTime || '' };
                                      return (
                                        <td key={`${day}-start`} className="text-center p-1 font-medium">
                                          {daySchedule?.startTime || '-'}
                                        </td>
                                      );
                                    })}
                                  </tr>
                                  
                                  {/* Finish Time */}
                                  <tr className="border-t" style={{ background: '#eff6ff' }}>
                                    <td className="text-center p-1 font-semibold text-blue-800 bg-blue-100 text-[10px]">Finish</td>
                                    {daysOfWeek.map(day => {
                                      const daySchedule = pattern.weeklySchedule 
                                        ? pattern.weeklySchedule[day]
                                        : { startTime: pattern.startTime || '', endTime: pattern.endTime || '' };
                                      return (
                                        <td key={`${day}-finish`} className="text-center p-1 font-medium">
                                          <div className="flex items-center justify-center gap-1">
                                            <span>{daySchedule?.endTime || '-'}</span>
                                            {daySchedule?.startTime && daySchedule?.endTime && isOvernightShift(daySchedule.startTime, daySchedule.endTime) && (
                                              <span className="text-sm" title="Finishes next day">Ã°Å¸Å’â„¢</span>
                                            )}
                                          </div>
                                        </td>
                                      );
                                    })}
                                  </tr>
                                  
                                  {/* Commute Out */}
                                  <tr className="border-t" style={{ background: '#fffbeb' }}>
                                    <td className="text-center p-1 font-medium text-amber-700 bg-amber-50 text-[10px]">Commute Out</td>
                                    {daysOfWeek.map(day => {
                                      const daySchedule = pattern.weeklySchedule ? pattern.weeklySchedule[day] : {};
                                      return (
                                        <td key={`${day}-commuteOut`} className="text-center p-1" style={{ color: daySchedule?.startTime ? '#1f2937' : '#9ca3af' }}>
                                          {daySchedule?.startTime ? (daySchedule.commuteOut ?? 60) : '-'}
                                        </td>
                                      );
                                    })}
                                  </tr>
                                  
                                  {/* Workload */}
                                  <tr className="border-t" style={{ background: '#fffbeb' }}>
                                    <td className="text-center p-1 font-medium text-amber-700 bg-amber-50 text-[10px]">Workload</td>
                                    {daysOfWeek.map(day => {
                                      const daySchedule = pattern.weeklySchedule ? pattern.weeklySchedule[day] : {};
                                      const workloadLabels = ['Light', 'Medium', 'Mod', 'Heavy'];
                                      return (
                                        <td key={`${day}-workload`} className="text-center p-1" style={{ color: daySchedule?.startTime ? '#1f2937' : '#9ca3af' }}>
                                          {daySchedule?.startTime ? workloadLabels[daySchedule.workload ?? 2] : '-'}
                                        </td>
                                      );
                                    })}
                                  </tr>
                                  
                                  {/* Attention */}
                                  <tr className="border-t" style={{ background: '#fffbeb' }}>
                                    <td className="text-center p-1 font-medium text-amber-700 bg-amber-50 text-[10px]">Attention</td>
                                    {daysOfWeek.map(day => {
                                      const daySchedule = pattern.weeklySchedule ? pattern.weeklySchedule[day] : {};
                                      const attentionLabels = ['Rarely', 'Some', 'Mostly', 'Always'];
                                      return (
                                        <td key={`${day}-attention`} className="text-center p-1" style={{ color: daySchedule?.startTime ? '#1f2937' : '#9ca3af' }}>
                                          {daySchedule?.startTime ? attentionLabels[daySchedule.attention ?? 1] : '-'}
                                        </td>
                                      );
                                    })}
                                  </tr>
                                  
                                  {/* Break Freq */}
                                  <tr className="border-t" style={{ background: '#fffbeb' }}>
                                    <td className="text-center p-1 font-medium text-amber-700 bg-amber-50 text-[10px]">Break Freq</td>
                                    {daysOfWeek.map(day => {
                                      const daySchedule = pattern.weeklySchedule ? pattern.weeklySchedule[day] : {};
                                      return (
                                        <td key={`${day}-breakFreq`} className="text-center p-1" style={{ color: daySchedule?.startTime ? '#1f2937' : '#9ca3af' }}>
                                          {daySchedule?.startTime ? (daySchedule.breakFreq ?? 180) : '-'}
                                        </td>
                                      );
                                    })}
                                  </tr>
                                  
                                  {/* Break Len */}
                                  <tr className="border-t" style={{ background: '#fffbeb' }}>
                                    <td className="text-center p-1 font-medium text-amber-700 bg-amber-50 text-[10px]">Break Len</td>
                                    {daysOfWeek.map(day => {
                                      const daySchedule = pattern.weeklySchedule ? pattern.weeklySchedule[day] : {};
                                      return (
                                        <td key={`${day}-breakLen`} className="text-center p-1" style={{ color: daySchedule?.startTime ? '#1f2937' : '#9ca3af' }}>
                                          {daySchedule?.startTime ? (daySchedule.breakLen ?? 15) : '-'}
                                        </td>
                                      );
                                    })}
                                  </tr>
                                  
                                  {/* Risk Index Row */}
                                  {(() => {
                                    const shifts = daysOfWeek.map((day, idx) => {
                                      const daySchedule = pattern.weeklySchedule ? pattern.weeklySchedule[day] : {};
                                      if (!daySchedule?.startTime) return null;
                                      return {
                                        day: idx + 1,
                                        dayName: day,
                                        startTime: daySchedule.startTime,
                                        endTime: daySchedule.endTime || daySchedule.startTime,
                                        commuteIn: daySchedule.commuteIn ?? 60,
                                        commuteOut: daySchedule.commuteOut ?? 60,
                                        workload: daySchedule.workload ?? 2,
                                        attention: daySchedule.attention ?? 1,
                                        breakFrequency: daySchedule.breakFreq ?? 180,
                                        breakLength: daySchedule.breakLen ?? 15
                                      };
                                    }).filter(Boolean);
                                    
                                    if (shifts.length === 0) return null;
                                    
                                    const riskResults = {};
                                    shifts.forEach((shift, idx) => {
                                      const params = {
                                        commuteTime: Math.round((shift.commuteIn + shift.commuteOut) / 2),
                                        workload: shift.workload,
                                        attention: shift.attention,
                                        breakFrequency: shift.breakFrequency,
                                        breakLength: shift.breakLength,
                                        continuousWork: 240,
                                        breakAfterContinuous: 30
                                      };
                                      const result = FatigueCalculator.calculateRiskIndex(shift, idx, shifts, params);
                                      riskResults[shift.dayName] = result.riskIndex;
                                    });
                                    
                                    const getRiskColor = (risk) => {
                                      if (risk < 1.0) return '#16a34a';
                                      if (risk < 1.1) return '#ca8a04';
                                      if (risk < 1.2) return '#ea580c';
                                      return '#dc2626';
                                    };
                                    
                                    const getRiskBg = (risk) => {
                                      if (risk < 1.0) return '#dcfce7';
                                      if (risk < 1.1) return '#fef9c3';
                                      if (risk < 1.2) return '#ffedd5';
                                      return '#fee2e2';
                                    };
                                    
                                    return (
                                      <tr className="border-t" style={{ background: '#f0fdf4' }}>
                                        <td className="text-center p-1 font-semibold text-green-800 bg-green-100 text-[10px]">Ã¢Å¡Â¡ Risk</td>
                                        {daysOfWeek.map(day => {
                                          const risk = riskResults[day];
                                          if (risk === undefined) {
                                            return <td key={`${day}-risk`} className="text-center p-1" style={{ color: '#9ca3af' }}>-</td>;
                                          }
                                          return (
                                            <td key={`${day}-risk`} className="text-center p-1">
                                              <span style={{
                                                background: getRiskBg(risk),
                                                color: getRiskColor(risk),
                                                fontWeight: 700,
                                                fontSize: '10px',
                                                padding: '2px 4px',
                                                borderRadius: '3px'
                                              }}>
                                                {risk.toFixed(2)}
                                              </span>
                                            </td>
                                          );
                                        })}
                                      </tr>
                                    );
                                  })()}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
                
                <div className="bg-white rounded-lg shadow-md p-6">
                  <h3 className="text-lg font-semibold mb-4">Assigned Personnel</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {uniqueEmployees.map(empId => {
                      const employee = employees.find(e => e.id === empId);
                      const empAssignments = projectAssignments.filter(a => a.employeeId === empId);
                      const compliance = getEmployeeComplianceStatus(empId, assignments, shiftPatterns);
                      
                      return (
                        <div 
                          key={empId}
                          className="border rounded-lg p-3 hover:shadow-md transition-shadow cursor-pointer"
                          onClick={() => { setSelectedEmployee(empId); setCurrentView('person'); }}>
                          <div className="flex items-center justify-between">
                            <div>
                              <p className="font-semibold">{employee?.name}</p>
                              <p className="text-xs text-gray-600">{employee?.role}</p>
                              <p className="text-xs text-gray-500 mt-1">{empAssignments.length} shifts</p>
                            </div>
                            <div className="hover:scale-110 transition-transform">
                              {compliance.status === 'error' ? (
                                <ErrorTriangle className="w-5 h-5 text-red-500" />
                              ) : compliance.status === 'warning' ? (
                                <AlertTriangle className="w-5 h-5 text-amber-500" />
                              ) : (
                                <CheckCircle className="w-5 h-5 text-green-500" />
                              )}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
                </div>
              </div>
            );
          }

          // Project Modal
          function ProjectModal() {
            const [projectName, setProjectName] = useState('');
            const [location, setLocation] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [projectType, setProjectType] = useState('Track Renewal');
            
            const projectTypes = [
              'Track Renewal',
              'Signalling',
              'Electrification',
              'Structures',
              'Station Works',
              'Maintenance',
              'Other'
            ];
            
            const handleSubmit = (e) => {
              e.preventDefault();
              
              // Validate dates
              if (new Date(endDate) < new Date(startDate)) {
                alert('End date must be after start date');
                return;
              }
              
              addProject({
                name: projectName,
                location: location,
                startDate: startDate,
                endDate: endDate,
                type: projectType
              });
            };
            
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                  <div className="p-6">
                    <div className="flex items-center justify-between mb-6">
                      <h2 className="text-2xl font-bold text-gray-900">Create New Project</h2>
                      <button
                        onClick={() => setShowProjectModal(false)}
                        className="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                    
                    <form onSubmit={handleSubmit} className="space-y-5">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Project Name *
                        </label>
                        <input
                          type="text"
                          value={projectName}
                          onChange={(e) => setProjectName(e.target.value)}
                          className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="e.g., East Coast Main Line - Track Renewal"
                          required
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Location *
                        </label>
                        <input
                          type="text"
                          value={location}
                          onChange={(e) => setLocation(e.target.value)}
                          className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder="e.g., York to Newcastle"
                          required
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Project Type *
                        </label>
                        <select
                          value={projectType}
                          onChange={(e) => setProjectType(e.target.value)}
                          className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          required>
                          {projectTypes.map(type => (
                            <option key={type} value={type}>{type}</option>
                          ))}
                        </select>
                      </div>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Start Date *
                          </label>
                          <input
                            type="date"
                            value={startDate}
                            onChange={(e) => setStartDate(e.target.value)}
                            className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            required
                          />
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            End Date *
                          </label>
                          <input
                            type="date"
                            value={endDate}
                            onChange={(e) => setEndDate(e.target.value)}
                            className="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            required
                          />
                        </div>
                      </div>
                      
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p className="text-sm text-blue-900">
                          <strong>Note:</strong> After creating the project, you'll need to add shift patterns before you can assign employees.
                        </p>
                      </div>
                      
                      <div className="flex gap-3 pt-4 border-t">
                        <button
                          type="button"
                          onClick={() => setShowProjectModal(false)}
                          className="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 font-medium transition-colors">
                          Cancel
                        </button>
                        <button
                          type="submit"
                          className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium transition-colors">
                          Create Project
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            );
          }

          // Assignment Modal
          function AssignmentModal() {
            // Check if we're in edit mode (has assignmentId) or add mode
            const isEditMode = assignmentModalData?.assignmentId !== undefined;
            const existingAssignment = isEditMode ? assignments.find(a => a.id === assignmentModalData.assignmentId) : null;
            
            const [selectedEmployeeId, setSelectedEmployeeId] = useState(existingAssignment?.employeeId || assignmentModalData?.employeeId || '');
            const [selectedShiftPatternId, setSelectedShiftPatternId] = useState(existingAssignment?.shiftPatternId || assignmentModalData?.shiftPatternId || '');
            const [startDate, setStartDate] = useState(existingAssignment?.date || assignmentModalData?.date || '');
            const [endDate, setEndDate] = useState(existingAssignment?.date || assignmentModalData?.date || '');
            const [customStartTime, setCustomStartTime] = useState(existingAssignment?.customStartTime || '08:00');
            const [customEndTime, setCustomEndTime] = useState(existingAssignment?.customEndTime || '17:00');
            
            const projectShiftPatterns = shiftPatterns.filter(sp => sp.projectId === (existingAssignment?.projectId || assignmentModalData?.projectId));
            
            // Check if selected pattern is Custom Roster
            const selectedPattern = projectShiftPatterns.find(p => p.id === selectedShiftPatternId);
            const isCustomRoster = selectedPattern?.name?.toLowerCase().includes('custom');
            
            const timeOptions = generateTimeOptions();
            
            const handleSubmit = (e) => {
              e.preventDefault();
              if (isEditMode) {
                // Edit mode - only update shift pattern (and custom times if applicable)
                if (selectedShiftPatternId) {
                  if (isCustomRoster) {
                    updateAssignmentWithTimes(assignmentModalData.assignmentId, selectedShiftPatternId, customStartTime, customEndTime);
                  } else {
                    updateAssignment(assignmentModalData.assignmentId, selectedShiftPatternId);
                  }
                  setShowAssignmentModal(false);
                }
              } else {
                // Add mode - create new assignments
                if (selectedEmployeeId && selectedShiftPatternId && startDate && endDate) {
                  if (isCustomRoster) {
                    addAssignmentWithTimes(Number(selectedEmployeeId), assignmentModalData.projectId, selectedShiftPatternId, startDate, endDate, customStartTime, customEndTime);
                  } else {
                    addAssignment(Number(selectedEmployeeId), assignmentModalData.projectId, selectedShiftPatternId, startDate, endDate);
                  }
                  setShowAssignmentModal(false);
                }
              }
            };
            
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={() => setShowAssignmentModal(false)}>
                <div className="bg-white rounded-lg p-6 w-full max-w-md" onClick={e => e.stopPropagation()}>
                  <h3 className="text-xl font-semibold mb-4">{isEditMode ? 'Edit Assignment' : 'Add Assignment'}</h3>
                  <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">Employee</label>
                      <select 
                        value={selectedEmployeeId}
                        onChange={(e) => setSelectedEmployeeId(e.target.value)}
                        className="w-full border rounded-md px-3 py-2"
                        disabled={isEditMode}
                        required>
                        <option value="">Select employee...</option>
                        {employees.map(emp => (
                          <option key={emp.id} value={emp.id}>{emp.name} - {emp.role}</option>
                        ))}
                      </select>
                      {isEditMode && <p className="text-xs text-gray-500 mt-1">Cannot change employee when editing</p>}
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium mb-1">Shift Pattern</label>
                      <select 
                        value={selectedShiftPatternId}
                        onChange={(e) => setSelectedShiftPatternId(e.target.value)}
                        className="w-full border rounded-md px-3 py-2"
                        required>
                        <option value="">Select shift...</option>
                        {projectShiftPatterns.map(pattern => (
                          <option key={pattern.id} value={pattern.id}>
                            {pattern.name} ({pattern.startTime}-{pattern.endTime})
                          </option>
                        ))}
                      </select>
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium mb-1">Start Date</label>
                      <input 
                        type="date"
                        value={startDate}
                        onChange={(e) => setStartDate(e.target.value)}
                        className="w-full border rounded-md px-3 py-2"
                        disabled={isEditMode}
                        required
                      />
                      {isEditMode && <p className="text-xs text-gray-500 mt-1">Cannot change date when editing</p>}
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium mb-1">End Date</label>
                      <input 
                        type="date"
                        value={endDate}
                        onChange={(e) => setEndDate(e.target.value)}
                        className="w-full border rounded-md px-3 py-2"
                        disabled={isEditMode}
                        required
                      />
                      {isEditMode && <p className="text-xs text-gray-500 mt-1">Cannot change date when editing</p>}
                    </div>
                    
                    {/* Custom time fields for Custom Roster */}
                    {isCustomRoster && (
                      <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                        <p className="text-sm font-medium text-amber-800 mb-3">Custom Roster - Set Hours</p>
                        <div className="grid grid-cols-2 gap-3">
                          <div>
                            <label className="block text-sm font-medium mb-1">Start Time</label>
                            <select 
                              value={customStartTime}
                              onChange={(e) => setCustomStartTime(e.target.value)}
                              className="w-full border rounded-md px-3 py-2">
                              {timeOptions.map(time => (
                                <option key={time} value={time}>{time}</option>
                              ))}
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">End Time</label>
                            <select 
                              value={customEndTime}
                              onChange={(e) => setCustomEndTime(e.target.value)}
                              className="w-full border rounded-md px-3 py-2">
                              {timeOptions.map(time => (
                                <option key={time} value={time}>{time}</option>
                              ))}
                            </select>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    <div className="flex gap-2 pt-4">
                      <button 
                        type="button"
                        onClick={() => setShowAssignmentModal(false)}
                        className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
                        Cancel
                      </button>
                      <button 
                        type="submit"
                        className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        {isEditMode ? 'Update Assignment' : 'Add Assignment'}
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            );
          }

          // Shift Pattern Modal
          function ShiftPatternModal() {
            const [name, setName] = useState(shiftPatternModalData?.name || '');
            const [dutyType, setDutyType] = useState(shiftPatternModalData?.dutyType || 'Non-Possession');
            const [isNight, setIsNight] = useState(shiftPatternModalData?.isNight || false);
            const [selectedProjectId, setSelectedProjectId] = useState(shiftPatternModalData?.projectId || '');
            
            // Days of week starting with Saturday (Network Rail convention)
            const daysOfWeek = ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const daysShort = ['Sat', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
            
            // Initialize weekly schedule - always use weekly schedule now
            const [weeklySchedule, setWeeklySchedule] = useState(() => {
              if (shiftPatternModalData?.weeklySchedule) {
                // Add fatigue params if missing from existing data
                const schedule = {...shiftPatternModalData.weeklySchedule};
                ['Sat', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'].forEach(day => {
                  if (schedule[day]) {
                    schedule[day] = {
                      ...schedule[day],
                      commuteIn: schedule[day].commuteIn ?? 60,
                      commuteOut: schedule[day].commuteOut ?? 60,
                      workload: schedule[day].workload ?? 2,
                      attention: schedule[day].attention ?? 1,
                      breakFreq: schedule[day].breakFreq ?? 180,
                      breakLen: schedule[day].breakLen ?? 15
                    };
                  }
                });
                return schedule;
              }
              // Default: same times for all days
              const defaultSchedule = {
                startTime: shiftPatternModalData?.startTime || '08:00',
                endTime: shiftPatternModalData?.endTime || '17:00',
                commuteIn: 60,
                commuteOut: 60,
                workload: 2,  // Moderate
                attention: 1, // Sometimes
                breakFreq: 180,
                breakLen: 15
              };
              return {
                Sat: {...defaultSchedule},
                Sun: {...defaultSchedule},
                Mon: {...defaultSchedule},
                Tue: {...defaultSchedule},
                Wed: {...defaultSchedule},
                Thu: {...defaultSchedule},
                Fri: {...defaultSchedule}
              };
            });
            
            // State to show/hide fatigue parameters section - always show by default
            const showFatigueParams = true;
            
            const isEditMode = shiftPatternModalData?.mode === 'edit';
            const timeOptions = generateTimeOptions();
            
            const updateDaySchedule = (day, field, value) => {
              setWeeklySchedule(prev => ({
                ...prev,
                [day]: {
                  ...prev[day],
                  [field]: value
                }
              }));
            };
            
            const applyToAllDays = () => {
              const monSchedule = weeklySchedule['Mon'];
              const newSchedule = {};
              daysShort.forEach(day => {
                newSchedule[day] = {...monSchedule};
              });
              setWeeklySchedule(newSchedule);
            };
            
            const clearDay = (day) => {
              setWeeklySchedule(prev => ({
                ...prev,
                [day]: {
                  startTime: '',
                  endTime: '',
                  commuteIn: null,
                  commuteOut: null,
                  workload: null,
                  attention: null,
                  breakFreq: null,
                  breakLen: null
                }
              }));
            };
            
            const handleSubmit = (e) => {
              e.preventDefault();
              
              if (!selectedProjectId && !isEditMode) {
                alert('Please select a project');
                return;
              }
              
              if (name) {
                const projectId = isEditMode ? shiftPatternModalData.projectId : selectedProjectId;
                
                if (isEditMode) {
                  updateShiftPatternWithWeekly(shiftPatternModalData.id, name, weeklySchedule, dutyType, isNight);
                } else {
                  addShiftPatternWithWeekly(projectId, name, weeklySchedule, dutyType, isNight);
                }
                setShowShiftPatternModal(false);
              }
            };
            
            // Auto-detect night shift based on times
            React.useEffect(() => {
              const firstDay = weeklySchedule['Mon'];
              if (firstDay.startTime && firstDay.endTime) {
                const [startHour] = firstDay.startTime.split(':').map(Number);
                const [endHour] = firstDay.endTime.split(':').map(Number);
                const spansNight = endHour < startHour || startHour >= 20 || endHour <= 6;
                setIsNight(spansNight);
              }
            }, [weeklySchedule]);
            
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={() => setShowShiftPatternModal(false)}>
                <div className="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                  <h3 className="text-xl font-semibold mb-4">
                    {isEditMode ? 'Edit Shift Pattern' : 'Create Shift Pattern'}
                  </h3>
                  <form onSubmit={handleSubmit} className="space-y-4">
                    {!isEditMode && (
                      <div>
                        <label className="block text-sm font-medium mb-1">Project *</label>
                        <select 
                          value={selectedProjectId}
                          onChange={(e) => setSelectedProjectId(Number(e.target.value))}
                          className="w-full border rounded-md px-3 py-2"
                          required>
                          <option value="">Select project...</option>
                          {projects.map(proj => (
                            <option key={proj.id} value={proj.id}>{proj.name}</option>
                          ))}
                        </select>
                      </div>
                    )}
                    
                    <div>
                      <label className="block text-sm font-medium mb-1">Pattern Name *</label>
                      <input 
                        type="text"
                        value={name}
                        onChange={(e) => setName(e.target.value)}
                        className="w-full border rounded-md px-3 py-2"
                        placeholder="e.g., Day Shift, Night Shift"
                        required
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium mb-1">Duty Type *</label>
                      <select 
                        value={dutyType}
                        onChange={(e) => setDutyType(e.target.value)}
                        className="w-full border rounded-md px-3 py-2"
                        required>
                        <option value="Non-Possession">Non-Possession</option>
                        <option value="Possession">Possession</option>
                      </select>
                    </div>
                    
                    <div className="border rounded-lg p-3 bg-gray-50">
                      <div className="flex justify-between items-center mb-2">
                        <p className="text-sm font-medium text-gray-700">Weekly Schedule (Week starts Saturday)</p>
                        <button
                          type="button"
                          onClick={applyToAllDays}
                          className="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">
                          Copy MonÃ¢â€ â€™All
                        </button>
                      </div>
                      
                      <div className="bg-white rounded border">
                        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '11px' }}>
                          <thead>
                            <tr style={{ background: '#f1f5f9' }}>
                              <th style={{ padding: '4px 6px', textAlign: 'center', fontWeight: 600, width: '90px', borderBottom: '1px solid #e2e8f0' }}></th>
                              {daysShort.map(day => (
                                <th key={day} style={{ padding: '4px 2px', textAlign: 'center', fontWeight: 600, borderBottom: '1px solid #e2e8f0', minWidth: '62px' }}>
                                  {day}
                                </th>
                              ))}
                            </tr>
                          </thead>
                          <tbody>
                            {/* Clear Day Row */}
                            <tr style={{ background: '#fef2f2' }}>
                              <td style={{ padding: '2px 6px', fontSize: '10px', color: '#991b1b', fontWeight: 500, textAlign: 'center' }}>Clear Day</td>
                              {daysShort.map(day => (
                                <td key={`${day}-clear`} style={{ padding: '2px', textAlign: 'center' }}>
                                  <button
                                    type="button"
                                    onClick={() => clearDay(day)}
                                    style={{
                                      background: weeklySchedule[day]?.startTime ? '#fee2e2' : '#f1f5f9',
                                      border: '1px solid #fca5a5',
                                      borderRadius: '3px',
                                      padding: '1px 6px',
                                      fontSize: '10px',
                                      cursor: 'pointer',
                                      color: '#991b1b'
                                    }}
                                    title={`Clear ${day}`}>
                                    Ã¢Å“â€¢
                                  </button>
                                </td>
                              ))}
                            </tr>
                            
                            {/* Commute In Row */}
                            <tr style={{ background: '#fffbeb' }}>
                              <td style={{ padding: '2px 6px', fontSize: '10px', color: '#92400e', background: '#fef3c7', textAlign: 'center' }}>Commute In</td>
                              {daysShort.map(day => (
                                <td key={`${day}-commuteIn`} style={{ padding: '1px', textAlign: 'center' }}>
                                  {!weeklySchedule[day]?.startTime ? (
                                    <span style={{ color: '#9ca3af' }}>-</span>
                                  ) : (
                                    <input
                                      type="number"
                                      min="0"
                                      value={weeklySchedule[day]?.commuteIn ?? 60}
                                      onChange={(e) => updateDaySchedule(day, 'commuteIn', Number(e.target.value))}
                                      style={{ width: '100%', padding: '2px', border: '1px solid #e5e7eb', borderRadius: '2px', fontSize: '11px', textAlign: 'center' }}
                                    />
                                  )}
                                </td>
                              ))}
                            </tr>
                            
                            {/* Start Time Row */}
                            <tr style={{ background: '#eff6ff' }}>
                              <td style={{ padding: '2px 6px', fontSize: '10px', fontWeight: 600, background: '#dbeafe', textAlign: 'center' }}>Start Time</td>
                              {daysShort.map(day => (
                                <td key={`${day}-start`} style={{ padding: '1px', textAlign: 'center' }}>
                                  <select
                                    value={weeklySchedule[day]?.startTime || ''}
                                    onChange={(e) => updateDaySchedule(day, 'startTime', e.target.value)}
                                    style={{ width: '100%', padding: '2px', border: '1px solid #93c5fd', borderRadius: '2px', fontSize: '11px', textAlign: 'center' }}>
                                    <option value="">-</option>
                                    {timeOptions.map(time => (
                                      <option key={time} value={time}>{time}</option>
                                    ))}
                                  </select>
                                </td>
                              ))}
                            </tr>
                            
                            {/* Finish Time Row */}
                            <tr style={{ background: '#eff6ff' }}>
                              <td style={{ padding: '2px 6px', fontSize: '10px', fontWeight: 600, background: '#dbeafe', textAlign: 'center' }}>
                                Finish Time
                              </td>
                              {daysShort.map(day => (
                                <td key={`${day}-finish`} style={{ padding: '1px', textAlign: 'center' }}>
                                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                    <select
                                      value={weeklySchedule[day]?.endTime || ''}
                                      onChange={(e) => updateDaySchedule(day, 'endTime', e.target.value)}
                                      style={{ width: '100%', padding: '2px', border: '1px solid #93c5fd', borderRadius: '2px', fontSize: '11px', textAlign: 'center' }}>
                                      <option value="">-</option>
                                      {timeOptions.map(time => (
                                        <option key={time} value={time}>{time}</option>
                                      ))}
                                    </select>
                                    {isOvernightShift(weeklySchedule[day]?.startTime, weeklySchedule[day]?.endTime) && (
                                      <span style={{ marginLeft: '1px', fontSize: '10px' }} title="Next day">Ã°Å¸Å’â„¢</span>
                                    )}
                                  </div>
                                </td>
                              ))}
                            </tr>
                            
                            {/* Commute Out Row */}
                            <tr style={{ background: '#fffbeb' }}>
                              <td style={{ padding: '2px 6px', fontSize: '10px', color: '#92400e', background: '#fef3c7', textAlign: 'center' }}>Commute Out</td>
                              {daysShort.map(day => (
                                <td key={`${day}-commuteOut`} style={{ padding: '1px', textAlign: 'center' }}>
                                  {!weeklySchedule[day]?.startTime ? (
                                    <span style={{ color: '#9ca3af' }}>-</span>
                                  ) : (
                                    <input
                                      type="number"
                                      min="0"
                                      value={weeklySchedule[day]?.commuteOut ?? 60}
                                      onChange={(e) => updateDaySchedule(day, 'commuteOut', Number(e.target.value))}
                                      style={{ width: '100%', padding: '2px', border: '1px solid #e5e7eb', borderRadius: '2px', fontSize: '11px', textAlign: 'center' }}
                                    />
                                  )}
                                </td>
                              ))}
                            </tr>
                            
                            {/* Workload Row */}
                            <tr style={{ background: '#fffbeb' }}>
                              <td style={{ padding: '2px 6px', fontSize: '10px', color: '#92400e', background: '#fef3c7', textAlign: 'center' }}>Workload</td>
                              {daysShort.map(day => (
                                <td key={`${day}-workload`} style={{ padding: '1px', textAlign: 'center' }}>
                                  {!weeklySchedule[day]?.startTime ? (
                                    <span style={{ color: '#9ca3af' }}>-</span>
                                  ) : (
                                    <select
                                      value={weeklySchedule[day]?.workload ?? 2}
                                      onChange={(e) => updateDaySchedule(day, 'workload', Number(e.target.value))}
                                      style={{ width: '100%', padding: '2px', border: '1px solid #e5e7eb', borderRadius: '2px', fontSize: '10px', textAlign: 'center' }}>
                                      <option value={0}>Light</option>
                                      <option value={1}>Medium</option>
                                      <option value={2}>Moderate</option>
                                      <option value={3}>Heavy</option>
                                    </select>
                                  )}
                                </td>
                              ))}
                            </tr>
                            
                            {/* Attention Row */}
                            <tr style={{ background: '#fffbeb' }}>
                              <td style={{ padding: '2px 6px', fontSize: '10px', color: '#92400e', background: '#fef3c7', textAlign: 'center' }}>Attention</td>
                              {daysShort.map(day => (
                                <td key={`${day}-attention`} style={{ padding: '1px', textAlign: 'center' }}>
                                  {!weeklySchedule[day]?.startTime ? (
                                    <span style={{ color: '#9ca3af' }}>-</span>
                                  ) : (
                                    <select
                                      value={weeklySchedule[day]?.attention ?? 1}
                                      onChange={(e) => updateDaySchedule(day, 'attention', Number(e.target.value))}
                                      style={{ width: '100%', padding: '2px', border: '1px solid #e5e7eb', borderRadius: '2px', fontSize: '10px', textAlign: 'center' }}>
                                      <option value={0}>Rarely</option>
                                      <option value={1}>Sometimes</option>
                                      <option value={2}>Mostly</option>
                                      <option value={3}>Always</option>
                                    </select>
                                  )}
                                </td>
                              ))}
                            </tr>
                            
                            {/* Break Frequency Row */}
                            <tr style={{ background: '#fffbeb' }}>
                              <td style={{ padding: '2px 6px', fontSize: '10px', color: '#92400e', background: '#fef3c7', textAlign: 'center' }}>Break Freq (m)</td>
                              {daysShort.map(day => (
                                <td key={`${day}-breakFreq`} style={{ padding: '1px', textAlign: 'center' }}>
                                  {!weeklySchedule[day]?.startTime ? (
                                    <span style={{ color: '#9ca3af' }}>-</span>
                                  ) : (
                                    <input
                                      type="number"
                                      min="0"
                                      value={weeklySchedule[day]?.breakFreq ?? 180}
                                      onChange={(e) => updateDaySchedule(day, 'breakFreq', Number(e.target.value))}
                                      style={{ width: '100%', padding: '2px', border: '1px solid #e5e7eb', borderRadius: '2px', fontSize: '11px', textAlign: 'center' }}
                                    />
                                  )}
                                </td>
                              ))}
                            </tr>
                            
                            {/* Break Length Row */}
                            <tr style={{ background: '#fffbeb' }}>
                              <td style={{ padding: '2px 6px', fontSize: '10px', color: '#92400e', background: '#fef3c7', textAlign: 'center' }}>Break Len (m)</td>
                              {daysShort.map(day => (
                                <td key={`${day}-breakLen`} style={{ padding: '1px', textAlign: 'center' }}>
                                  {!weeklySchedule[day]?.startTime ? (
                                    <span style={{ color: '#9ca3af' }}>-</span>
                                  ) : (
                                    <input
                                      type="number"
                                      min="0"
                                      value={weeklySchedule[day]?.breakLen ?? 15}
                                      onChange={(e) => updateDaySchedule(day, 'breakLen', Number(e.target.value))}
                                      style={{ width: '100%', padding: '2px', border: '1px solid #e5e7eb', borderRadius: '2px', fontSize: '11px', textAlign: 'center' }}
                                    />
                                  )}
                                </td>
                              ))}
                            </tr>
                            
                            {/* Live Fatigue Risk Row */}
                            {(() => {
                              // Calculate fatigue for each day with a shift
                              const shifts = daysShort.map((day, idx) => {
                                if (!weeklySchedule[day]?.startTime) return null;
                                return {
                                  day: idx + 1,
                                  dayName: day,
                                  startTime: weeklySchedule[day].startTime,
                                  endTime: weeklySchedule[day].endTime || weeklySchedule[day].startTime,
                                  commuteIn: weeklySchedule[day].commuteIn ?? 60,
                                  commuteOut: weeklySchedule[day].commuteOut ?? 60,
                                  workload: weeklySchedule[day].workload ?? 2,
                                  attention: weeklySchedule[day].attention ?? 1,
                                  breakFrequency: weeklySchedule[day].breakFreq ?? 180,
                                  breakLength: weeklySchedule[day].breakLen ?? 15
                                };
                              }).filter(Boolean);
                              
                              if (shifts.length === 0) return null;
                              
                              // Calculate risk for each shift
                              const riskResults = {};
                              let maxRisk = 0;
                              let avgRisk = 0;
                              
                              shifts.forEach((shift, idx) => {
                                const params = {
                                  commuteTime: Math.round((shift.commuteIn + shift.commuteOut) / 2),
                                  workload: shift.workload,
                                  attention: shift.attention,
                                  breakFrequency: shift.breakFrequency,
                                  breakLength: shift.breakLength,
                                  continuousWork: 240,
                                  breakAfterContinuous: 30
                                };
                                const result = FatigueCalculator.calculateRiskIndex(shift, idx, shifts, params);
                                riskResults[shift.dayName] = result.riskIndex;
                                if (result.riskIndex > maxRisk) maxRisk = result.riskIndex;
                                avgRisk += result.riskIndex;
                              });
                              avgRisk = avgRisk / shifts.length;
                              
                              const getRiskColor = (risk) => {
                                if (risk < 1.0) return '#22c55e';
                                if (risk < 1.1) return '#eab308';
                                if (risk < 1.2) return '#f97316';
                                return '#ef4444';
                              };
                              
                              const getRiskBg = (risk) => {
                                if (risk < 1.0) return '#dcfce7';
                                if (risk < 1.1) return '#fef9c3';
                                if (risk < 1.2) return '#ffedd5';
                                return '#fee2e2';
                              };
                              
                              return (
                                <tr style={{ background: '#f0fdf4', borderTop: '2px solid #86efac' }}>
                                  <td style={{ padding: '4px 6px', fontSize: '10px', fontWeight: 600, background: '#bbf7d0', color: '#166534' }}>
                                    Ã¢Å¡Â¡ Risk Index
                                  </td>
                                  {daysShort.map(day => {
                                    const risk = riskResults[day];
                                    if (risk === undefined) {
                                      return <td key={`${day}-risk`} style={{ padding: '2px', textAlign: 'center', color: '#9ca3af', fontSize: '10px' }}>-</td>;
                                    }
                                    return (
                                      <td key={`${day}-risk`} style={{ padding: '2px', textAlign: 'center' }}>
                                        <div style={{
                                          background: getRiskBg(risk),
                                          color: getRiskColor(risk),
                                          fontWeight: 700,
                                          fontSize: '11px',
                                          padding: '2px 4px',
                                          borderRadius: '3px',
                                          border: `1px solid ${getRiskColor(risk)}`
                                        }}>
                                          {risk.toFixed(2)}
                                        </div>
                                      </td>
                                    );
                                  })}
                                </tr>
                              );
                            })()}
                          </tbody>
                        </table>
                      </div>
                      
                      {/* Summary Stats */}
                      {(() => {
                        const shifts = daysShort.map((day, idx) => {
                          if (!weeklySchedule[day]?.startTime) return null;
                          return {
                            day: idx + 1,
                            dayName: day,
                            startTime: weeklySchedule[day].startTime,
                            endTime: weeklySchedule[day].endTime || weeklySchedule[day].startTime,
                            commuteIn: weeklySchedule[day].commuteIn ?? 60,
                            commuteOut: weeklySchedule[day].commuteOut ?? 60,
                            workload: weeklySchedule[day].workload ?? 2,
                            attention: weeklySchedule[day].attention ?? 1,
                            breakFrequency: weeklySchedule[day].breakFreq ?? 180,
                            breakLength: weeklySchedule[day].breakLen ?? 15
                          };
                        }).filter(Boolean);
                        
                        if (shifts.length === 0) return null;
                        
                        let maxRisk = 0;
                        let totalRisk = 0;
                        let totalHours = 0;
                        let elevatedCount = 0;
                        
                        shifts.forEach((shift, idx) => {
                          const params = {
                            commuteTime: Math.round((shift.commuteIn + shift.commuteOut) / 2),
                            workload: shift.workload,
                            attention: shift.attention,
                            breakFrequency: shift.breakFrequency,
                            breakLength: shift.breakLength,
                            continuousWork: 240,
                            breakAfterContinuous: 30
                          };
                          const result = FatigueCalculator.calculateRiskIndex(shift, idx, shifts, params);
                          if (result.riskIndex > maxRisk) maxRisk = result.riskIndex;
                          totalRisk += result.riskIndex;
                          totalHours += result.dutyLength;
                          if (result.riskIndex >= 1.1) elevatedCount++;
                        });
                        
                        const avgRisk = totalRisk / shifts.length;
                        const isOk = maxRisk < 1.1;
                        
                        return (
                          <div style={{ 
                            marginTop: '8px', 
                            padding: '8px 12px', 
                            background: isOk ? '#f0fdf4' : '#fef2f2',
                            border: `1px solid ${isOk ? '#86efac' : '#fca5a5'}`,
                            borderRadius: '6px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between'
                          }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                              <span style={{ fontSize: '16px' }}>{isOk ? 'Ã¢Å“â€¦' : 'Ã¢Å¡Â Ã¯Â¸Â'}</span>
                              <div>
                                <div style={{ fontSize: '12px', fontWeight: 600, color: isOk ? '#166534' : '#991b1b' }}>
                                  {isOk ? 'Pattern OK' : 'Elevated Fatigue Risk'}
                                </div>
                                <div style={{ fontSize: '10px', color: '#6b7280' }}>
                                  {shifts.length} shifts Ã¢â‚¬Â¢ {totalHours.toFixed(1)}h total
                                </div>
                              </div>
                            </div>
                            <div style={{ display: 'flex', gap: '12px', fontSize: '11px' }}>
                              <div style={{ textAlign: 'center' }}>
                                <div style={{ fontWeight: 600, color: avgRisk >= 1.1 ? '#dc2626' : avgRisk >= 1.0 ? '#d97706' : '#16a34a' }}>
                                  {avgRisk.toFixed(2)}
                                </div>
                                <div style={{ fontSize: '9px', color: '#6b7280' }}>Avg</div>
                              </div>
                              <div style={{ textAlign: 'center' }}>
                                <div style={{ fontWeight: 600, color: maxRisk >= 1.1 ? '#dc2626' : maxRisk >= 1.0 ? '#d97706' : '#16a34a' }}>
                                  {maxRisk.toFixed(2)}
                                </div>
                                <div style={{ fontSize: '9px', color: '#6b7280' }}>Peak</div>
                              </div>
                              {elevatedCount > 0 && (
                                <div style={{ textAlign: 'center' }}>
                                  <div style={{ fontWeight: 600, color: '#dc2626' }}>{elevatedCount}</div>
                                  <div style={{ fontSize: '9px', color: '#6b7280' }}>Elevated</div>
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })()}
                    </div>
                    
                    <div className="flex items-center gap-2 p-3 bg-blue-50 rounded-md border border-blue-200">
                      <input 
                        type="checkbox"
                        id="isNight"
                        checked={isNight}
                        onChange={(e) => setIsNight(e.target.checked)}
                        className="rounded"
                      />
                      <label htmlFor="isNight" className="text-sm font-medium text-blue-900">
                        Night Shift (auto-detected based on times)
                      </label>
                    </div>
                    
                    <div className="flex gap-2 pt-4 border-t">
                      <button 
                        type="button"
                        onClick={() => setShowShiftPatternModal(false)}
                        className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 font-medium">
                        Cancel
                      </button>
                      <button 
                        type="submit"
                        className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium">
                        {isEditMode ? 'Update' : 'Add'} Shift Pattern
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            );
          }

          // No Roster Warning Modal
          function NoRosterModal() {
            console.log('Ã°Å¸â€“Â¼Ã¯Â¸Â NoRosterModal rendering, data:', noRosterModalData);
            
            if (!noRosterModalData) {
              console.error('Ã¢ÂÅ’ NoRosterModal called but noRosterModalData is null!');
              return null;
            }
            
            if (!noRosterModalData.employees || noRosterModalData.employees.length === 0) {
              console.error('Ã¢ÂÅ’ NoRosterModal has no employees!', noRosterModalData);
              return null;
            }
            
            const dateObj = new Date(noRosterModalData.date);
            const dayName = dateObj.toLocaleDateString('en-GB', { weekday: 'long' });
            const formattedDate = dateObj.toLocaleDateString('en-GB');
            const employeeNames = noRosterModalData.employees.map(e => e.name).join(', ');
            
            console.log('Ã°Å¸â€“Â¼Ã¯Â¸Â Modal rendering with:', { dayName, formattedDate, employeeNames });
            
            const handleManualOverride = () => {
              console.log('Ã°Å¸â€˜â€  Manual Override clicked');
              setShowNoRosterModal(false);
              setManualOverrideData({
                employees: noRosterModalData.employees,
                date: noRosterModalData.date,
                projectId: noRosterModalData.projectId
              });
              setShowManualOverrideModal(true);
            };
            
            const handleCreateNewRoster = () => {
              console.log('Ã°Å¸â€˜â€  Create New Roster clicked');
              setShowNoRosterModal(false);
              setShiftPatternModalData({ projectId: noRosterModalData.projectId, mode: 'add' });
              setShowShiftPatternModal(true);
            };
            
            try {
              return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                  <div className="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
                    <div className="flex items-start gap-4 mb-4">
                      <div className="flex-shrink-0 w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
                        <AlertTriangle className="w-6 h-6 text-amber-600" />
                      </div>
                      <div className="flex-1">
                        <h2 className="text-2xl font-bold text-gray-900 mb-2">No Roster Exists</h2>
                        <p className="text-gray-700 mb-4">
                          Cannot assign <strong>{employeeNames}</strong> to <strong>{dayName}, {formattedDate}</strong>
                        </p>
                        
                        {noRosterModalData.attemptedPattern && (
                          <div className="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4">
                            <p className="text-sm text-gray-600">
                              The shift pattern "<strong>{noRosterModalData.attemptedPattern.name}</strong>" has no hours scheduled for {dayName}s.
                            </p>
                          </div>
                        )}
                        
                        {noRosterModalData.validPatterns && noRosterModalData.validPatterns.length > 0 && (
                          <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                            <p className="text-sm font-semibold text-blue-900 mb-2">Click to assign using an available roster for {dayName}:</p>
                            <div className="space-y-2">
                              {noRosterModalData.validPatterns.map(p => {
                                // Use inline date logic instead of utility functions
                                const d = new Date(noRosterModalData.date);
                                const dayIndex = d.getDay(); // 0=Sun, 6=Sat
                                const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                                const dayName = daysOfWeek[dayIndex];
                                
                                const daySchedule = p.weeklySchedule?.[dayName];
                                const times = daySchedule && daySchedule.startTime
                                  ? `${daySchedule.startTime}-${daySchedule.endTime || 'next day'}` 
                                  : `${p.startTime || '??:??'}-${p.endTime || '??:??'}`;
                                
                                const handleAssignToPattern = async () => {
                                  try {
                                    const batch = db.batch();
                                    let maxId = Math.max(...assignments.map(a => a.id), 0);
                                    
                                    noRosterModalData.employees.forEach(employee => {
                                      // Check if already assigned to this pattern on this date
                                      const existing = assignments.find(a => 
                                        a.employeeId === employee.id && 
                                        a.date === noRosterModalData.date && 
                                        a.shiftPatternId === p.id
                                      );
                                      
                                      if (!existing) {
                                        maxId++;
                                        const assignment = {
                                          id: maxId,
                                          employeeId: employee.id,
                                          projectId: noRosterModalData.projectId,
                                          shiftPatternId: p.id,
                                          date: noRosterModalData.date
                                        };
                                        const docRef = db.collection('assignments').doc(String(maxId));
                                        batch.set(docRef, assignment);
                                      }
                                    });
                                    
                                    await batch.commit();
                                    console.log('Ã¢Å“â€¦ Assigned to alternative pattern:', p.name);
                                    setShowNoRosterModal(false);
                                    setNoRosterModalData(null);
                                  } catch (error) {
                                    console.error('Ã¢ÂÅ’ Error assigning to pattern:', error);
                                    alert('Failed to create assignment. Please try again.');
                                  }
                                };
                                
                                return (
                                  <button
                                    key={p.id}
                                    onClick={handleAssignToPattern}
                                    className="w-full text-left p-2 rounded-md bg-white border border-blue-300 hover:bg-blue-100 hover:border-blue-500 transition-colors">
                                    <div className="font-semibold text-blue-900">{p.name}</div>
                                    <div className="text-xs text-blue-700">{times}</div>
                                  </button>
                                );
                              })}
                            </div>
                          </div>
                        )}
                        
                        <p className="text-gray-600 mb-4">Or choose another option:</p>
                      </div>
                    </div>
                    
                    <div className="space-y-3">
                      <button
                        onClick={handleManualOverride}
                        className="w-full bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 font-medium text-left flex items-center gap-3 transition-colors">
                        <Clock className="w-5 h-5 flex-shrink-0" />
                        <div>
                          <div className="font-semibold">Manual Override</div>
                          <div className="text-sm text-blue-100">Enter custom hours for this specific assignment</div>
                        </div>
                      </button>
                      
                      <button
                        onClick={handleCreateNewRoster}
                        className="w-full bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 font-medium text-left flex items-center gap-3 transition-colors">
                        <Plus className="w-5 h-5 flex-shrink-0" />
                        <div>
                          <div className="font-semibold">Create New Permanent Roster</div>
                          <div className="text-sm text-green-100">Define a new shift pattern for this project</div>
                        </div>
                      </button>
                      
                      <button
                        onClick={() => setShowNoRosterModal(false)}
                        className="w-full bg-gray-200 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-300 font-medium transition-colors">
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              );
            } catch (error) {
              console.error('Ã¢ÂÅ’ Error rendering NoRosterModal:', error);
              return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                  <div className="bg-white rounded-lg p-6 max-w-md">
                    <h3 className="text-lg font-bold text-red-600 mb-2">Modal Error</h3>
                    <p className="text-gray-700">Failed to render modal. Check console for details.</p>
                    <button
                      onClick={() => setShowNoRosterModal(false)}
                      className="mt-4 w-full bg-gray-200 px-4 py-2 rounded">
                      Close
                    </button>
                  </div>
                </div>
              );
            }
          }

          // Manual Override Modal
          function ManualOverrideModal() {
            if (!manualOverrideData) return null;
            
            const [startTime, setStartTime] = useState('08:00');
            const [endTime, setEndTime] = useState('17:00');
            
            const dateObj = new Date(manualOverrideData.date);
            const dayName = dateObj.toLocaleDateString('en-GB', { weekday: 'long' });
            const formattedDate = dateObj.toLocaleDateString('en-GB');
            const employeeNames = manualOverrideData.employees.map(e => e.name).join(', ');
            
            const timeOptions = generateTimeOptions();
            
            const handleSubmit = async (e) => {
              e.preventDefault();
              
              try {
                // Find or create "Custom Roster" shift pattern for this project
                let customPattern = shiftPatterns.find(p => 
                  p.projectId === manualOverrideData.projectId && 
                  p.name === 'Custom Roster'
                );
                
                if (!customPattern) {
                  // Create the Custom Roster pattern
                  const maxPatternId = shiftPatterns.length > 0 ? Math.max(...shiftPatterns.map(p => p.id)) : 0;
                  customPattern = {
                    id: maxPatternId + 1,
                    projectId: manualOverrideData.projectId,
                    name: 'Custom Roster',
                    startTime: '00:00',
                    endTime: '00:00',
                    dutyType: 'Non-Possession',
                    isNight: false,
                    isCustom: true,
                    weeklySchedule: {
                      Sat: { startTime: '00:00', endTime: '00:00' },
                      Sun: { startTime: '00:00', endTime: '00:00' },
                      Mon: { startTime: '00:00', endTime: '00:00' },
                      Tue: { startTime: '00:00', endTime: '00:00' },
                      Wed: { startTime: '00:00', endTime: '00:00' },
                      Thu: { startTime: '00:00', endTime: '00:00' },
                      Fri: { startTime: '00:00', endTime: '00:00' }
                    }
                  };
                  
                  await db.collection('shiftPatterns').doc(String(customPattern.id)).set(customPattern);
                  console.log('Ã¢Å“â€¦ Created Custom Roster pattern');
                }
                
                // Create assignments with custom times
                const batch = db.batch();
                let maxId = Math.max(...assignments.map(a => a.id), 0);
                
                manualOverrideData.employees.forEach(employee => {
                  maxId++;
                  const assignment = {
                    id: maxId,
                    employeeId: employee.id,
                    projectId: manualOverrideData.projectId,
                    shiftPatternId: customPattern.id,
                    date: manualOverrideData.date,
                    customStartTime: startTime,
                    customEndTime: endTime
                  };
                  const docRef = db.collection('assignments').doc(String(maxId));
                  batch.set(docRef, assignment);
                });
                
                await batch.commit();
                console.log('Ã¢Å“â€¦ Manual override assignments created');
                
                setShowManualOverrideModal(false);
                setManualOverrideData(null);
              } catch (error) {
                console.error('Ã¢ÂÅ’ Error creating manual override:', error);
                alert('Failed to create manual override. Please try again.');
              }
            };
            
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                  <h2 className="text-2xl font-bold text-gray-900 mb-4">Manual Override</h2>
                  
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <p className="text-sm text-blue-900 mb-2">
                      <strong>Employee(s):</strong> {employeeNames}
                    </p>
                    <p className="text-sm text-blue-900">
                      <strong>Date:</strong> {dayName}, {formattedDate}
                    </p>
                  </div>
                  
                  <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">Start Time *</label>
                      <select 
                        value={startTime}
                        onChange={(e) => setStartTime(e.target.value)}
                        className="w-full border rounded-md px-3 py-2"
                        required>
                        {timeOptions.map(time => (
                          <option key={time} value={time}>{time}</option>
                        ))}
                      </select>
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium mb-1">End Time *</label>
                      <select 
                        value={endTime}
                        onChange={(e) => setEndTime(e.target.value)}
                        className="w-full border rounded-md px-3 py-2"
                        required>
                        {timeOptions.map(time => (
                          <option key={time} value={time}>{time}</option>
                        ))}
                      </select>
                    </div>
                    
                    <div className="bg-gray-50 border border-gray-200 rounded-lg p-3">
                      <p className="text-xs text-gray-600">
                        <strong>Note:</strong> This will be added to a "Custom Roster" pattern that consolidates all manual overrides for this project.
                      </p>
                    </div>
                    
                    <div className="flex gap-2 pt-4 border-t">
                      <button 
                        type="button"
                        onClick={() => setShowManualOverrideModal(false)}
                        className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 font-medium">
                        Cancel
                      </button>
                      <button 
                        type="submit"
                        className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium">
                        Create Override
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            );
          }

          // Export Modal Component
          function ExportModal() {
            const project = projects.find(p => p.id === selectedProject);
            const projectShiftPatterns = shiftPatterns.filter(sp => sp.projectId === selectedProject);
            const period = networkRailPeriods.find(p => p.id === selectedPeriod);
            const projectAssignments = assignments.filter(a => a.projectId === selectedProject);
            
            const [exportType, setExportType] = useState('template'); // 'template' or 'current'
            
            const startDate = period ? new Date(period.startDate) : new Date(project?.startDate || new Date());
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 27);
            
            const handleExport = () => {
              if (exportType === 'template') {
                // Export blank template
                const templateData = [
                  ['Network Rail Fatigue Management - Shift Upload Template'],
                  [''],
                  ['Project:', project?.name || ''],
                  ['Period:', period?.name || 'N/A'],
                  ['Date Range:', `${startDate.toISOString().split('T')[0]} to ${endDate.toISOString().split('T')[0]}`],
                  ['Generated:', new Date().toLocaleString()],
                  [''],
                  ['Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â'],
                  ['INSTRUCTIONS'],
                  ['Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â'],
                  ['1. Fill in employee names exactly as shown in the "Employees" sheet'],
                  ['2. Enter dates in YYYY-MM-DD format (e.g., 2025-04-01)'],
                  ['3. Enter shift pattern names exactly as shown in the "Shift Patterns" sheet'],
                  ['4. One row creates shifts for ALL days between Start and End date'],
                  ['5. Save file and use "Import Shifts" button to upload'],
                  [''],
                  ['Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â'],
                  ['DATA ENTRY (Add your shifts below)'],
                  ['Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â'],
                  ['Employee Name', 'Start Date', 'End Date', 'Shift Pattern', 'Notes'],
                  ['', '', '', '', ''],
                  ['', '', '', '', ''],
                  ['', '', '', '', ''],
                  ['', '', '', '', ''],
                  ['', '', '', '', '']
                ];
                
                // Employee reference sheet
                const employeeData = [
                  ['AVAILABLE EMPLOYEES'],
                  [''],
                  ['Name', 'Role'],
                  ...employees.map(e => [e.name, e.role])
                ];
                
                // Shift pattern reference sheet  
                const shiftPatternData = [
                  ['AVAILABLE SHIFT PATTERNS'],
                  [''],
                  ['Pattern Name', 'Start Time', 'End Time', 'Type'],
                  ...projectShiftPatterns.map(sp => [sp.name, sp.startTime, sp.endTime, sp.dutyType || 'Standard'])
                ];
                
                const wb = XLSX.utils.book_new();
                const wsTemplate = XLSX.utils.aoa_to_sheet(templateData);
                const wsEmployees = XLSX.utils.aoa_to_sheet(employeeData);
                const wsShifts = XLSX.utils.aoa_to_sheet(shiftPatternData);
                
                wsTemplate['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 30 }];
                wsEmployees['!cols'] = [{ wch: 25 }, { wch: 25 }];
                wsShifts['!cols'] = [{ wch: 20 }, { wch: 12 }, { wch: 12 }, { wch: 15 }];
                
                XLSX.utils.book_append_sheet(wb, wsTemplate, 'Upload Template');
                XLSX.utils.book_append_sheet(wb, wsEmployees, 'Employees');
                XLSX.utils.book_append_sheet(wb, wsShifts, 'Shift Patterns');
                
                XLSX.writeFile(wb, `Shift_Template_${project?.name?.replace(/\s+/g, '_') || 'Project'}_${period?.name?.replace(/\s+/g, '_') || 'Period'}.xlsx`);
              } else {
                // Export current assignments
                const exportData = [
                  ['Network Rail Fatigue Management - Current Assignments Export'],
                  [''],
                  ['Project:', project?.name || ''],
                  ['Period:', period?.name || 'N/A'],
                  ['Exported:', new Date().toLocaleString()],
                  ['Total Assignments:', projectAssignments.length],
                  [''],
                  ['Employee Name', 'Date', 'Shift Pattern', 'Start Time', 'End Time', 'Duration (hrs)', 'Night Shift', 'Project']
                ];
                
                // Sort assignments by date then employee
                const sortedAssignments = [...projectAssignments].sort((a, b) => {
                  const dateCompare = a.date.localeCompare(b.date);
                  if (dateCompare !== 0) return dateCompare;
                  const empA = employees.find(e => e.id === a.employeeId)?.name || '';
                  const empB = employees.find(e => e.id === b.employeeId)?.name || '';
                  return empA.localeCompare(empB);
                });
                
                sortedAssignments.forEach(a => {
                  const emp = employees.find(e => e.id === a.employeeId);
                  const pattern = shiftPatterns.find(p => p.id === a.shiftPatternId);
                  
                  // Use the proper function to get shift times for the specific date
                  const times = pattern ? getShiftTimesForDate(pattern, a.date, a) : null;
                  const startTime = times?.startTime || '';
                  const endTime = times?.endTime || '';
                  
                  // Calculate duration
                  let duration = '';
                  let isNightShift = 'No';
                  if (startTime && endTime) {
                    const [startHour, startMin] = startTime.split(':').map(Number);
                    const [endHour, endMin] = endTime.split(':').map(Number);
                    let startMins = startHour * 60 + startMin;
                    let endMins = endHour * 60 + endMin;
                    
                    // If end time is before start time, it's overnight
                    if (endMins <= startMins) {
                      endMins += 24 * 60; // Add 24 hours
                      isNightShift = 'Yes';
                    }
                    
                    const durationMins = endMins - startMins;
                    duration = (durationMins / 60).toFixed(1);
                  }
                  
                  // Also check pattern isNight flag
                  if (pattern?.isNight) {
                    isNightShift = 'Yes';
                  }
                  
                  exportData.push([
                    emp?.name || 'Unknown',
                    a.date,
                    pattern?.name || 'Custom',
                    startTime,
                    endTime,
                    duration,
                    isNightShift,
                    project?.name || ''
                  ]);
                });
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(exportData);
                ws['!cols'] = [{ wch: 25 }, { wch: 12 }, { wch: 20 }, { wch: 10 }, { wch: 10 }, { wch: 14 }, { wch: 10 }, { wch: 20 }];
                XLSX.utils.book_append_sheet(wb, ws, 'Assignments');
                
                XLSX.writeFile(wb, `Shift_Export_${project?.name?.replace(/\s+/g, '_') || 'Project'}_${new Date().toISOString().split('T')[0]}.xlsx`);
              }
              
              setShowExportModal(false);
            };
            
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden">
                  {/* Header */}
                  <div className="bg-gradient-to-r from-green-600 to-green-700 px-6 py-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <Download className="w-6 h-6 text-white" />
                        <h2 className="text-xl font-bold text-white">Export to Excel</h2>
                      </div>
                      <button 
                        onClick={() => setShowExportModal(false)}
                        className="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-1">
                        <X className="w-5 h-5" />
                      </button>
                    </div>
                  </div>
                  
                  {/* Content */}
                  <div className="p-6">
                    {/* Project Info */}
                    <div className="bg-gray-50 rounded-lg p-4 mb-6">
                      <div className="grid grid-cols-2 gap-3 text-sm">
                        <div>
                          <span className="text-gray-500">Project:</span>
                          <p className="font-semibold text-gray-900">{project?.name || 'N/A'}</p>
                        </div>
                        <div>
                          <span className="text-gray-500">Period:</span>
                          <p className="font-semibold text-gray-900">{period?.name || 'N/A'}</p>
                        </div>
                      </div>
                    </div>
                    
                    {/* Export Type Selection */}
                    <div className="space-y-3 mb-6">
                      <label className="block text-sm font-medium text-gray-700 mb-2">What would you like to export?</label>
                      
                      <div 
                        onClick={() => setExportType('template')}
                        className={`p-4 rounded-lg border-2 cursor-pointer transition-all ${
                          exportType === 'template' 
                            ? 'border-green-500 bg-green-50' 
                            : 'border-gray-200 hover:border-gray-300'
                        }`}>
                        <div className="flex items-start gap-3">
                          <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center mt-0.5 ${
                            exportType === 'template' ? 'border-green-500' : 'border-gray-300'
                          }`}>
                            {exportType === 'template' && <div className="w-2.5 h-2.5 rounded-full bg-green-500"></div>}
                          </div>
                          <div>
                            <p className="font-semibold text-gray-900">Blank Template</p>
                            <p className="text-sm text-gray-600">Download an empty template to fill in new shift assignments</p>
                          </div>
                        </div>
                      </div>
                      
                      <div 
                        onClick={() => setExportType('current')}
                        className={`p-4 rounded-lg border-2 cursor-pointer transition-all ${
                          exportType === 'current' 
                            ? 'border-green-500 bg-green-50' 
                            : 'border-gray-200 hover:border-gray-300'
                        }`}>
                        <div className="flex items-start gap-3">
                          <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center mt-0.5 ${
                            exportType === 'current' ? 'border-green-500' : 'border-gray-300'
                          }`}>
                            {exportType === 'current' && <div className="w-2.5 h-2.5 rounded-full bg-green-500"></div>}
                          </div>
                          <div>
                            <p className="font-semibold text-gray-900">Current Assignments</p>
                            <p className="text-sm text-gray-600">Export all {projectAssignments.length} existing shift assignments for this project</p>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    {/* Actions */}
                    <div className="flex gap-3">
                      <button
                        onClick={() => setShowExportModal(false)}
                        className="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                        Cancel
                      </button>
                      <button
                        onClick={handleExport}
                        className="flex-1 px-4 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium flex items-center justify-center gap-2">
                        <Download className="w-4 h-4" />
                        Export
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          // Import Modal Component
          function ImportModal() {
            const project = projects.find(p => p.id === selectedProject);
            const projectShiftPatterns = shiftPatterns.filter(sp => sp.projectId === selectedProject);
            const period = networkRailPeriods.find(p => p.id === selectedPeriod);
            
            const [file, setFile] = useState(null);
            const [preview, setPreview] = useState(null);
            const [errors, setErrors] = useState([]);
            const [validAssignments, setValidAssignments] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [step, setStep] = useState(1); // 1 = select file, 2 = preview
            
            const handleFileSelect = (selectedFile) => {
              if (!selectedFile) return;
              
              setFile(selectedFile);
              setIsProcessing(true);
              
              const reader = new FileReader();
              reader.onload = (e) => {
                try {
                  const data = new Uint8Array(e.target.result);
                  const workbook = XLSX.read(data, { type: 'array' });
                  const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                  const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                  
                  // Find header row
                  let headerRowIndex = -1;
                  for (let i = 0; i < jsonData.length; i++) {
                    if (jsonData[i][0] === 'Employee Name') {
                      headerRowIndex = i;
                      break;
                    }
                  }
                  
                  if (headerRowIndex === -1) {
                    setErrors(['Could not find header row. Make sure "Employee Name" is in the first column.']);
                    setIsProcessing(false);
                    return;
                  }
                  
                  const isRangeFormat = jsonData[headerRowIndex][1] === 'Start Date';
                  const dataRows = jsonData.slice(headerRowIndex + 1).filter(row => row[0] && row[1]);
                  
                  const newErrors = [];
                  const newAssignments = [];
                  
                  dataRows.forEach((row, idx) => {
                    const employeeName = row[0]?.toString().trim();
                    const startDate = row[1]?.toString().trim();
                    const endDate = isRangeFormat ? row[2]?.toString().trim() : startDate;
                    const shiftPatternName = isRangeFormat ? row[3]?.toString().trim() : row[2]?.toString().trim();
                    
                    if (!employeeName || !startDate || !shiftPatternName) return;
                    
                    const employee = employees.find(e => e.name.toLowerCase() === employeeName.toLowerCase());
                    if (!employee) {
                      newErrors.push({ row: idx + headerRowIndex + 2, message: `Employee "${employeeName}" not found` });
                      return;
                    }
                    
                    const shiftPattern = projectShiftPatterns.find(sp => sp.name.toLowerCase() === shiftPatternName.toLowerCase());
                    if (!shiftPattern) {
                      newErrors.push({ row: idx + headerRowIndex + 2, message: `Shift pattern "${shiftPatternName}" not found` });
                      return;
                    }
                    
                    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                    if (!dateRegex.test(startDate)) {
                      newErrors.push({ row: idx + headerRowIndex + 2, message: `Invalid start date "${startDate}"` });
                      return;
                    }
                    if (endDate && !dateRegex.test(endDate)) {
                      newErrors.push({ row: idx + headerRowIndex + 2, message: `Invalid end date "${endDate}"` });
                      return;
                    }
                    
                    const start = new Date(startDate);
                    const end = new Date(endDate || startDate);
                    
                    if (end < start) {
                      newErrors.push({ row: idx + headerRowIndex + 2, message: 'End date before start date' });
                      return;
                    }
                    
                    let current = new Date(start);
                    while (current <= end) {
                      newAssignments.push({
                        employeeId: employee.id,
                        employeeName: employee.name,
                        projectId: selectedProject,
                        shiftPatternId: shiftPattern.id,
                        shiftPatternName: shiftPattern.name,
                        date: current.toISOString().split('T')[0]
                      });
                      current.setDate(current.getDate() + 1);
                    }
                  });
                  
                  setErrors(newErrors);
                  setValidAssignments(newAssignments);
                  setStep(2);
                  setIsProcessing(false);
                  
                } catch (error) {
                  setErrors([{ row: 0, message: 'Error reading file: ' + error.message }]);
                  setIsProcessing(false);
                }
              };
              reader.readAsArrayBuffer(selectedFile);
            };
            
            const handleImport = async () => {
              if (validAssignments.length === 0) return;
              
              setIsProcessing(true);
              try {
                const batch = db.batch();
                let maxId = Math.max(...assignments.map(a => a.id), 0);
                
                validAssignments.forEach((assignment) => {
                  maxId++;
                  const docRef = db.collection('assignments').doc(String(maxId));
                  batch.set(docRef, {
                    id: maxId,
                    employeeId: assignment.employeeId,
                    projectId: assignment.projectId,
                    shiftPatternId: assignment.shiftPatternId,
                    date: assignment.date
                  });
                });
                
                await batch.commit();
                alert(`Successfully imported ${validAssignments.length} shift assignments!`);
                setShowImportModal(false);
              } catch (error) {
                alert('Error importing: ' + error.message);
              }
              setIsProcessing(false);
            };
            
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 overflow-hidden max-h-[90vh] flex flex-col">
                  {/* Header */}
                  <div className="bg-gradient-to-r from-purple-600 to-purple-700 px-6 py-4 flex-shrink-0">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <Upload className="w-6 h-6 text-white" />
                        <h2 className="text-xl font-bold text-white">Import from Excel</h2>
                      </div>
                      <button 
                        onClick={() => setShowImportModal(false)}
                        className="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-1">
                        <X className="w-5 h-5" />
                      </button>
                    </div>
                    {/* Steps */}
                    <div className="flex items-center gap-2 mt-3">
                      <div className={`flex items-center gap-2 ${step >= 1 ? 'text-white' : 'text-purple-300'}`}>
                        <div className={`w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold ${
                          step >= 1 ? 'bg-white text-purple-600' : 'bg-purple-500'
                        }`}>1</div>
                        <span className="text-sm">Select File</span>
                      </div>
                      <div className="w-8 h-0.5 bg-purple-400"></div>
                      <div className={`flex items-center gap-2 ${step >= 2 ? 'text-white' : 'text-purple-300'}`}>
                        <div className={`w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold ${
                          step >= 2 ? 'bg-white text-purple-600' : 'bg-purple-500'
                        }`}>2</div>
                        <span className="text-sm">Review & Import</span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Content */}
                  <div className="p-6 overflow-auto flex-1">
                    {/* Project Info */}
                    <div className="bg-gray-50 rounded-lg p-4 mb-6">
                      <div className="grid grid-cols-2 gap-3 text-sm">
                        <div>
                          <span className="text-gray-500">Project:</span>
                          <p className="font-semibold text-gray-900">{project?.name || 'N/A'}</p>
                        </div>
                        <div>
                          <span className="text-gray-500">Period:</span>
                          <p className="font-semibold text-gray-900">{period?.name || 'N/A'}</p>
                        </div>
                      </div>
                    </div>
                    
                    {step === 1 && (
                      <div>
                        {/* File Upload Area */}
                        <label className="block">
                          <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-purple-400 hover:bg-purple-50 transition-all cursor-pointer">
                            <Upload className="w-12 h-12 text-gray-400 mx-auto mb-4" />
                            <p className="text-lg font-medium text-gray-700 mb-1">
                              {file ? file.name : 'Click to select Excel file'}
                            </p>
                            <p className="text-sm text-gray-500">
                              Supports .xlsx, .xls, and .csv files
                            </p>
                          </div>
                          <input 
                            type="file" 
                            accept=".xlsx,.xls,.csv"
                            onChange={(e) => handleFileSelect(e.target.files[0])}
                            className="hidden"
                          />
                        </label>
                        
                        <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                          <p className="font-medium text-blue-900 mb-2">Need a template?</p>
                          <p className="text-sm text-blue-700">
                            Close this dialog and click "Export Template" to download a blank template with instructions.
                          </p>
                        </div>
                      </div>
                    )}
                    
                    {step === 2 && (
                      <div>
                        {/* Summary */}
                        <div className="grid grid-cols-2 gap-4 mb-6">
                          <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                            <p className="text-3xl font-bold text-green-600">{validAssignments.length}</p>
                            <p className="text-sm text-green-700">Valid assignments ready to import</p>
                          </div>
                          <div className={`rounded-lg p-4 ${errors.length > 0 ? 'bg-red-50 border border-red-200' : 'bg-gray-50 border border-gray-200'}`}>
                            <p className={`text-3xl font-bold ${errors.length > 0 ? 'text-red-600' : 'text-gray-400'}`}>{errors.length}</p>
                            <p className={`text-sm ${errors.length > 0 ? 'text-red-700' : 'text-gray-500'}`}>Errors found</p>
                          </div>
                        </div>
                        
                        {/* Errors List */}
                        {errors.length > 0 && (
                          <div className="mb-6">
                            <p className="font-medium text-red-900 mb-2">Errors to fix:</p>
                            <div className="bg-red-50 border border-red-200 rounded-lg p-3 max-h-32 overflow-auto">
                              {errors.slice(0, 10).map((err, idx) => (
                                <p key={idx} className="text-sm text-red-700">
                                  Row {err.row}: {err.message}
                                </p>
                              ))}
                              {errors.length > 10 && (
                                <p className="text-sm text-red-600 font-medium mt-2">
                                  ... and {errors.length - 10} more errors
                                </p>
                              )}
                            </div>
                          </div>
                        )}
                        
                        {/* Preview Table */}
                        {validAssignments.length > 0 && (
                          <div>
                            <p className="font-medium text-gray-700 mb-2">Preview (first 10 assignments):</p>
                            <div className="border rounded-lg overflow-hidden">
                              <table className="w-full text-sm">
                                <thead className="bg-gray-50">
                                  <tr>
                                    <th className="px-3 py-2 text-left font-medium text-gray-600">Employee</th>
                                    <th className="px-3 py-2 text-left font-medium text-gray-600">Date</th>
                                    <th className="px-3 py-2 text-left font-medium text-gray-600">Shift Pattern</th>
                                  </tr>
                                </thead>
                                <tbody className="divide-y">
                                  {validAssignments.slice(0, 10).map((a, idx) => (
                                    <tr key={idx} className="hover:bg-gray-50">
                                      <td className="px-3 py-2">{a.employeeName}</td>
                                      <td className="px-3 py-2">{a.date}</td>
                                      <td className="px-3 py-2">{a.shiftPatternName}</td>
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                              {validAssignments.length > 10 && (
                                <div className="px-3 py-2 bg-gray-50 text-sm text-gray-500">
                                  ... and {validAssignments.length - 10} more assignments
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                  
                  {/* Footer */}
                  <div className="px-6 py-4 bg-gray-50 border-t flex gap-3 flex-shrink-0">
                    {step === 1 ? (
                      <button
                        onClick={() => setShowImportModal(false)}
                        className="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                        Cancel
                      </button>
                    ) : (
                      <>
                        <button
                          onClick={() => { setStep(1); setFile(null); setErrors([]); setValidAssignments([]); }}
                          className="px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                          Back
                        </button>
                        <button
                          onClick={() => setShowImportModal(false)}
                          className="px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                          Cancel
                        </button>
                        <button
                          onClick={handleImport}
                          disabled={validAssignments.length === 0 || isProcessing}
                          className={`flex-1 px-4 py-2.5 rounded-lg font-medium flex items-center justify-center gap-2 ${
                            validAssignments.length === 0 || isProcessing
                              ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                              : 'bg-purple-600 text-white hover:bg-purple-700'
                          }`}>
                          {isProcessing ? 'Importing...' : `Import ${validAssignments.length} Assignments`}
                        </button>
                      </>
                    )}
                  </div>
                </div>
              </div>
            );
          }

          // Teams View
          const TeamsView = () => {
            return (
              <div style={{ minHeight: '100vh', background: '#f1f5f9' }}>
                {/* Header */}
                <div style={{ 
                    background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)', 
                    padding: '0.75rem 1.5rem',
                    borderBottom: '3px solid #8b5cf6',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between'
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                        <button 
                            onClick={() => setCurrentView('dashboard')}
                            style={{ color: '#94a3b8', background: 'none', border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '0.25rem' }}>
                            Ã¢â€ Â Back
                        </button>
                        <div style={{ color: 'white', fontWeight: 600, fontSize: '1.1rem' }}>
                            <span style={{ color: '#8b5cf6' }}>Team</span> Management
                        </div>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                        <div style={{
                            background: '#334155',
                            color: '#8b5cf6',
                            padding: '0.375rem 0.75rem',
                            borderRadius: '4px',
                            fontFamily: 'ui-monospace, monospace',
                            fontSize: '0.7rem',
                            fontWeight: 500
                        }}>
                            TEAMS
                        </div>
                        <SignOutHeader user={user} onSignOut={onSignOut} />
                    </div>
                </div>
                
                <div className="p-6">
                  <div className="flex justify-between items-center mb-6">
                    <div>
                      <h2 className="text-2xl font-bold text-gray-900">Teams</h2>
                      <p className="text-gray-600">Create teams and bulk-assign them to shift patterns</p>
                    </div>
                    <button
                      onClick={() => {
                        setTeamModalData({ mode: 'add' });
                        setShowTeamModal(true);
                      }}
                      className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2">
                      <Plus className="w-4 h-4" /> Create Team
                    </button>
                  </div>
                  
                  {teams.length === 0 ? (
                    <div className="bg-white rounded-lg shadow-md p-12 text-center">
                      <Users className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                      <h3 className="text-xl font-semibold text-gray-700 mb-2">No Teams Yet</h3>
                      <p className="text-gray-500 mb-6">Create a team to group employees and assign them to projects together</p>
                      <button
                        onClick={() => {
                          setTeamModalData({ mode: 'add' });
                          setShowTeamModal(true);
                        }}
                        className="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700">
                        Create Your First Team
                      </button>
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      {teams.map(team => {
                        const teamMembers = employees.filter(e => team.memberIds?.includes(e.id));
                        return (
                          <div key={team.id} className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                            <div className="flex items-start justify-between mb-4">
                              <div>
                                <h3 className="text-xl font-semibold text-gray-900">{team.name}</h3>
                                <p className="text-sm text-gray-600">{teamMembers.length} member{teamMembers.length !== 1 ? 's' : ''}</p>
                              </div>
                              <div className="flex gap-2">
                                <button
                                  onClick={() => {
                                    setTeamModalData({ ...team, mode: 'edit' });
                                    setShowTeamModal(true);
                                  }}
                                  className="text-blue-600 hover:text-blue-800 p-1"
                                  title="Edit team">
                                  <Edit2 className="w-4 h-4" />
                                </button>
                                <button
                                  onClick={() => {
                                    if (window.confirm(`Delete team "${team.name}"?`)) {
                                      deleteTeam(team.id);
                                    }
                                  }}
                                  className="text-red-600 hover:text-red-800 p-1"
                                  title="Delete team">
                                  <Trash2 className="w-4 h-4" />
                                </button>
                              </div>
                            </div>
                            
                            {/* Team Members */}
                            <div className="mb-4">
                              <p className="text-xs font-medium text-gray-500 mb-2">MEMBERS</p>
                              <div className="flex flex-wrap gap-1">
                                {teamMembers.length === 0 ? (
                                  <span className="text-gray-400 text-sm">No members</span>
                                ) : (
                                  teamMembers.slice(0, 5).map(member => (
                                    <span key={member.id} className="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">
                                      {member.name.split(' ')[0]}
                                    </span>
                                  ))
                                )}
                                {teamMembers.length > 5 && (
                                  <span className="bg-gray-200 text-gray-600 px-2 py-1 rounded text-xs">
                                    +{teamMembers.length - 5} more
                                  </span>
                                )}
                              </div>
                            </div>
                            
                            {/* Assign to Project Button */}
                            <button
                              onClick={() => {
                                setTeamAssignModalData({ team });
                                setShowTeamAssignModal(true);
                              }}
                              disabled={teamMembers.length === 0}
                              className={`w-full py-2 rounded-md flex items-center justify-center gap-2 ${
                                teamMembers.length === 0
                                  ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                  : 'bg-purple-600 text-white hover:bg-purple-700'
                              }`}>
                              <Calendar className="w-4 h-4" />
                              Assign to Shift Pattern
                            </button>
                          </div>
                        );
                      })}
                      
                      {/* Add Team Card */}
                      <div
                        onClick={() => {
                          setTeamModalData({ mode: 'add' });
                          setShowTeamModal(true);
                        }}
                        className="bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-dashed border-purple-300 rounded-lg p-6 hover:border-purple-500 transition-all cursor-pointer flex flex-col items-center justify-center min-h-[200px]">
                        <div className="bg-purple-600 rounded-full p-3 mb-3">
                          <Plus className="w-6 h-6 text-white" />
                        </div>
                        <h3 className="font-semibold text-gray-900">Create New Team</h3>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            );
          };

          // Team Modal (Create/Edit)
          function TeamModal() {
            const isEditMode = teamModalData?.mode === 'edit';
            const [name, setName] = useState(teamModalData?.name || '');
            const [selectedMembers, setSelectedMembers] = useState(teamModalData?.memberIds || []);
            
            const toggleMember = (employeeId) => {
              setSelectedMembers(prev => 
                prev.includes(employeeId)
                  ? prev.filter(id => id !== employeeId)
                  : [...prev, employeeId]
              );
            };
            
            const handleSubmit = (e) => {
              e.preventDefault();
              if (!name.trim()) {
                alert('Please enter a team name');
                return;
              }
              
              if (isEditMode) {
                updateTeam(teamModalData.id, name, selectedMembers);
              } else {
                addTeam(name, selectedMembers);
              }
              setShowTeamModal(false);
            };
            
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={() => setShowTeamModal(false)}>
                <div className="bg-white rounded-lg p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                  <h3 className="text-xl font-semibold mb-4">
                    {isEditMode ? 'Edit Team' : 'Create Team'}
                  </h3>
                  
                  <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">Team Name *</label>
                      <input
                        type="text"
                        value={name}
                        onChange={(e) => setName(e.target.value)}
                        className="w-full border rounded-md px-3 py-2"
                        placeholder="e.g., Day Shift Core, Night Crew A"
                        required
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium mb-2">
                        Team Members ({selectedMembers.length} selected)
                      </label>
                      <div className="border rounded-md max-h-64 overflow-y-auto">
                        {employees.map(emp => (
                          <div
                            key={emp.id}
                            onClick={() => toggleMember(emp.id)}
                            className={`flex items-center gap-3 px-3 py-2 cursor-pointer hover:bg-gray-50 border-b last:border-b-0 ${
                              selectedMembers.includes(emp.id) ? 'bg-purple-50' : ''
                            }`}>
                            <input
                              type="checkbox"
                              checked={selectedMembers.includes(emp.id)}
                              onChange={() => {}}
                              className="rounded text-purple-600"
                            />
                            <div className="flex-1">
                              <p className="font-medium text-sm">{emp.name}</p>
                              <p className="text-xs text-gray-500">{emp.role}</p>
                            </div>
                          </div>
                        ))}
                        {employees.length === 0 && (
                          <p className="text-center py-4 text-gray-500">No employees available</p>
                        )}
                      </div>
                    </div>
                    
                    <div className="flex gap-2 pt-4 border-t">
                      <button
                        type="button"
                        onClick={() => setShowTeamModal(false)}
                        className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
                        Cancel
                      </button>
                      <button
                        type="submit"
                        className="flex-1 bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                        {isEditMode ? 'Update Team' : 'Create Team'}
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            );
          }

          // Team Assign Modal (Assign team to shift pattern)
          function TeamAssignModal() {
            const team = teamAssignModalData?.team;
            const [selectedProjectId, setSelectedProjectId] = useState('');
            const [selectedPatternId, setSelectedPatternId] = useState('');
            const [startDate, setStartDate] = useState(new Date().toISOString().split('T')[0]);
            const [endDate, setEndDate] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            
            const projectPatterns = shiftPatterns.filter(p => p.projectId === Number(selectedProjectId));
            const teamMembers = employees.filter(e => team?.memberIds?.includes(e.id));
            
            const handleAssign = async () => {
              if (!selectedProjectId || !selectedPatternId || !startDate || !endDate) {
                alert('Please fill in all fields');
                return;
              }
              
              setIsProcessing(true);
              await assignTeamToPattern(team.id, Number(selectedProjectId), selectedPatternId, startDate, endDate);
              setIsProcessing(false);
              setShowTeamAssignModal(false);
            };
            
            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={() => setShowTeamAssignModal(false)}>
                <div className="bg-white rounded-lg p-6 w-full max-w-lg" onClick={e => e.stopPropagation()}>
                  <h3 className="text-xl font-semibold mb-4">
                    Assign Team to Shift Pattern
                  </h3>
                  
                  {/* Team Info */}
                  <div className="bg-purple-50 border border-purple-200 rounded-lg p-3 mb-4">
                    <p className="font-semibold text-purple-900">{team?.name}</p>
                    <p className="text-sm text-purple-700">{teamMembers.length} members will be assigned</p>
                    <div className="flex flex-wrap gap-1 mt-2">
                      {teamMembers.map(m => (
                        <span key={m.id} className="bg-purple-100 text-purple-800 px-2 py-0.5 rounded text-xs">
                          {m.name.split(' ')[0]}
                        </span>
                      ))}
                    </div>
                  </div>
                  
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">Project *</label>
                      <select
                        value={selectedProjectId}
                        onChange={(e) => {
                          setSelectedProjectId(e.target.value);
                          setSelectedPatternId('');
                        }}
                        className="w-full border rounded-md px-3 py-2"
                        required>
                        <option value="">Select project...</option>
                        {projects.map(proj => (
                          <option key={proj.id} value={proj.id}>{proj.name}</option>
                        ))}
                      </select>
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium mb-1">Shift Pattern *</label>
                      <select
                        value={selectedPatternId}
                        onChange={(e) => setSelectedPatternId(e.target.value)}
                        className="w-full border rounded-md px-3 py-2"
                        disabled={!selectedProjectId}
                        required>
                        <option value="">Select shift pattern...</option>
                        {projectPatterns.map(pattern => (
                          <option key={pattern.id} value={pattern.id}>{pattern.name}</option>
                        ))}
                      </select>
                      {selectedProjectId && projectPatterns.length === 0 && (
                        <p className="text-xs text-amber-600 mt-1">No shift patterns for this project. Create one first.</p>
                      )}
                    </div>
                    
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium mb-1">Start Date *</label>
                        <input
                          type="date"
                          value={startDate}
                          onChange={(e) => setStartDate(e.target.value)}
                          className="w-full border rounded-md px-3 py-2"
                          required
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">End Date *</label>
                        <input
                          type="date"
                          value={endDate}
                          onChange={(e) => setEndDate(e.target.value)}
                          min={startDate}
                          className="w-full border rounded-md px-3 py-2"
                          required
                        />
                      </div>
                    </div>
                    
                    {startDate && endDate && (
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p className="text-sm text-blue-900">
                          <strong>{teamMembers.length}</strong> employees will be assigned to <strong>{projectPatterns.find(p => p.id === selectedPatternId)?.name || 'selected pattern'}</strong> from <strong>{new Date(startDate).toLocaleDateString('en-GB')}</strong> to <strong>{new Date(endDate).toLocaleDateString('en-GB')}</strong>
                        </p>
                      </div>
                    )}
                  </div>
                  
                  <div className="flex gap-2 pt-4 mt-4 border-t">
                    <button
                      type="button"
                      onClick={() => setShowTeamAssignModal(false)}
                      className="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
                      Cancel
                    </button>
                    <button
                      onClick={handleAssign}
                      disabled={!selectedProjectId || !selectedPatternId || !startDate || !endDate || isProcessing}
                      className={`flex-1 px-4 py-2 rounded-md ${
                        !selectedProjectId || !selectedPatternId || !startDate || !endDate || isProcessing
                          ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                          : 'bg-purple-600 text-white hover:bg-purple-700'
                      }`}>
                      {isProcessing ? 'Assigning...' : `Assign ${teamMembers.length} Members`}
                    </button>
                  </div>
                </div>
              </div>
            );
          }
        };

        // Render the app
        const AppWrapper = () => {
                const [user, setUser] = useState(null);
                const [loading, setLoading] = useState(true);
    
                useEffect(() => {
                    // Check current session
                    supabase.auth.getSession().then(({ data: { session } }) => {
                        setUser(session?.user || null);
                        setCurrentUser(session?.user || null);
                        setLoading(false);
                    });
                    
                    // Listen for auth changes
                    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                        setUser(session?.user || null);
                        setCurrentUser(session?.user || null);
                        setLoading(false);
                    });
                    
                    return () => subscription.unsubscribe();
                }, []);
    
                if (loading) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-slate-900">
                            <div className="text-white text-xl">Loading...</div>
                        </div>
                    );
                }
    
                if (!user) {
                    return <AuthScreen onLogin={(u) => { setUser(u); setCurrentUser(u); }} />;
                }
    
                // Original App component logic starts here
                return (
                    <>
                        <FatigueManagementApp user={user} onSignOut={() => { setUser(null); setCurrentUser(null); }} />
                    </>
                );
            };
    
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(
                <ErrorBoundary>
                    <AppWrapper />
                </ErrorBoundary>
            );
    </script>
</body>
</html>
